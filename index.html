<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Learning Management System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login/Register Page */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .auth-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 450px;
        }

        .auth-box h2 {
            color: #667eea;
            margin-bottom: 30px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .btn.loading {
            color: transparent;
        }

        .btn.loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            margin: auto;
            border: 3px solid transparent;
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: button-loading-spinner 1s ease infinite;
        }

        @keyframes button-loading-spinner {
            from {
                transform: rotate(0turn);
            }

            to {
                transform: rotate(1turn);
            }
        }

        .btn-secondary {
            background: #6c757d;
            margin-top: 10px;
        }

        .btn-small {
            width: auto;
            padding: 8px 16px;
            font-size: 14px;
            margin-bottom: 40px;
        }

        .btn-role {
            transition: all 0.3s ease;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .btn-role:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        /* Add loading spinner for small buttons */
        .btn-small.loading {
            color: transparent;
        }

        .btn-small.loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            margin: auto;
            border: 2px solid transparent;
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: button-loading-spinner 1s ease infinite;
        }

        /* Dashboard */
        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #667eea;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 20px;
        }

        .sidebar {
            background: white;
            padding: 20px;
            border-radius: 15px;
            height: fit-content;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .menu-item {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            color: #333;
            font-weight: 500;
        }

        .menu-item:hover {
            background: #f0f0f0;
        }

        .menu-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .content-area {
            background: white;
            padding: 30px;
            border-radius: 15px;
            min-height: 500px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        /* Cards */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .card:hover::before {
            left: 100%;
        }

        .card h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .card p {
            color: #666;
            line-height: 1.6;
        }

        .card-meta {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            font-size: 12px;
            color: #999;
        }

        /* Lists */
        .item-list {
            margin-top: 20px;
        }

        .list-item {
            background: #f8f9fa;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .list-item h4 {
            color: #333;
            margin-bottom: 8px;
        }

        .list-item p {
            color: #666;
            line-height: 1.6;
        }

        .item-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        /* Forms */
        .form-container {
            max-width: 600px;
            margin-top: 20px;
        }

        /* Discussion */
        .discussion-post {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .post-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .post-author {
            font-weight: 600;
            color: #667eea;
        }

        .post-role {
            background: #764ba2;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 8px;
        }

        .post-date {
            color: #999;
            font-size: 12px;
        }

        .replies {
            margin-left: 30px;
            margin-top: 15px;
        }

        .reply {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        /* Course enrollment */
        .course-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .course-info h3 {
            color: #333;
            margin-bottom: 5px;
        }

        .course-info p {
            color: #666;
            font-size: 14px;
        }

        .course-code {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            margin-top: 8px;
            display: inline-block;
        }

        /* Status badges */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            color: white;
            margin-right: 5px;
        }

        /* Grades */
        .grade-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .grade-table th,
        .grade-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .grade-table th {
            background: #f8f9fa;
            color: #667eea;
            font-weight: 600;
        }

        .grade-badge {
            background: #28a745;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
        }

        .grade-badge.low {
            background: #dc3545;
        }

        .grade-badge.medium {
            background: #ffc107;
            color: #333;
        }

        .hidden {
            display: none;
        }

        .notification-item {
            transition: all 0.3s;
        }

        .notification-item:hover {
            transform: translateX(5px);
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-modal {
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        /* Loading spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Search improvements */
        .search-container {
            position: relative;
        }

        .search-container .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #667eea;
        }

        .search-container input {
            padding-left: 45px !important;
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-width: 300px;
            max-width: 400px;
            z-index: 10000;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.3s ease-out;
        }

        .toast-success {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
        }

        .toast-error {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .toast-info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Department Course Deployment Styles */
        .department-courses {
            transition: all 0.3s ease;
        }

        .course-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            margin-right: 8px;
        }

        .course-checkbox:checked {
            accent-color: #667eea;
        }

        .science-badge {
            background: #2196F3;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .arts-badge {
            background: #9C27B0;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .commercial-badge {
            background: #4CAF50;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        /* Department colors */
        .science-color {
            color: #2196F3;
        }

        .arts-color {
            color: #9C27B0;
        }

        .commercial-color {
            color: #4CAF50;
        }

        /* Success info box */
        .success-info-box {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border: 1px solid #667eea;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            animation: slideIn 0.5s ease-out;
        }

        .student-id-highlight {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 20px;
            font-weight: bold;
            letter-spacing: 1px;
            text-align: center;
            margin: 15px 0;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        /* Department Selection for HS Students */
        .department-selection {
            display: none;
        }

        .department-selection.active {
            display: block;
        }

        .department-card {
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            text-align: center;
        }

        .department-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .department-card.active {
            border-color: #667eea;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        .department-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        /* Subject Combination Display */
        .subject-combination-box {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            animation: fadeIn 0.5s ease-out;
        }

        .subject-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 10px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* MS Course Deployment */
        .ms-level-selection {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .ms-level-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .ms-level-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .ms-level-card.active {
            border-color: #667eea;
            background: #e3f2fd;
        }

        /* Department filter for teachers */
        .department-filter {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        /* Subject combination section */
        #subjectCombination {
            display: none;
        }

        #subjectCombination.active {
            display: block;
        }

        /* Confirmation Modal Animations */
        .modal-content {
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .confirmation-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .confirmation-icon.success {
            color: #28a745;
        }

        .confirmation-icon.warning {
            color: #ffc107;
        }

        .confirmation-icon.danger {
            color: #dc3545;
        }

        .confirmation-icon.info {
            color: #17a2b8;
        }

        .btn-modal-confirm {
            transition: all 0.3s ease;
        }

        .btn-modal-confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-modal-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-modal-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        /* Admin buttons */
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 6px;
            transition: all 0.3s;
        }

        .btn-small:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        /* Notification badge styling */
        #notificationBadge,
        #teacherNotificationBadge,
        #adminNotificationBadge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            z-index: 10;
        }

        /* Approval badge */
        #approvalBadge {
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 11px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 5px;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .sidebar {
                display: none;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .user-info {
                flex-direction: column;
                gap: 10px;
            }

            .auth-box {
                margin: 20px;
                padding: 20px;
            }

            .department-card {
                margin-bottom: 10px;
            }

            .ms-level-selection {
                grid-template-columns: 1fr;
            }

            /* Adjust department selection for mobile */
            .department-selection.active>div>div {
                grid-template-columns: 1fr;
            }

            /* Adjust modal widths for mobile */
            .modal-content {
                width: 95%;
                padding: 20px;
            }

            /* Adjust toast notifications for mobile */
            .toast {
                left: 10px;
                right: 10px;
                max-width: none;
            }

            /* Adjust course items for mobile */
            .course-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .course-item .btn-small {
                align-self: flex-end;
            }

            /* Adjust tables for mobile */
            .grade-table {
                display: block;
                overflow-x: auto;
            }
        }

        @media (max-width: 992px) {
            #admin-deploy-courses .department-courses {
                grid-column: span 2;
            }
        }

        @media (max-width: 768px) {
            #admin-deploy-courses>div {
                grid-template-columns: 1fr;
            }

            #admin-deploy-courses .department-courses {
                grid-column: span 1;
            }
        }

        /* Ensure hidden class properly hides elements */
        .hidden {
            display: none !important;
        }

        /* List item hover effects */
        .list-item {
            transition: all 0.3s;
            border-left: 4px solid #667eea;
        }

        .list-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        /* Modal form improvements */
        .modal-content .form-group {
            margin-bottom: 15px;
        }

        .modal-content label {
            font-size: 13px;
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
        }

        .modal-content input,
        .modal-content select {
            padding: 10px;
            font-size: 14px;
        }

        /* Course item styling */
        .course-checkbox {
            cursor: pointer;
        }

        /* Form validation styling */
        input:invalid,
        select:invalid,
        textarea:invalid {
            border-color: #dc3545;
        }

        input:valid,
        select:valid,
        textarea:valid {
            border-color: #28a745;
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }

        /* Print styles */
        @media print {
            .no-print {
                display: none !important;
            }

            .dashboard.active {
                display: block;
            }

            .header,
            .sidebar,
            .btn,
            .modal {
                display: none !important;
            }

            .content-area {
                box-shadow: none;
                padding: 0;
            }
        }

        /* Add to your existing CSS */
        .fee-status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .fee-status.approved {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .fee-status.pending {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }

        .fee-status.rejected {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .payment-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
        }

        .payment-status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .payment-status-approved {
            background: #28a745;
            color: white;
        }

        .payment-status-pending {
            background: #ffc107;
            color: #212529;
        }

        .payment-status-rejected {
            background: #dc3545;
            color: white;
        }

        .btn-tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-tab.active {
            border-bottom: 3px solid #667eea;
            color: #667eea;
        }

        /* Add to your existing CSS */
        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .hidden {
            display: none !important;
        }

        .payment-status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .payment-status-approved {
            background: #28a745;
            color: white;
        }

        .payment-status-pending {
            background: #ffc107;
            color: #212529;
        }

        .payment-status-rejected {
            background: #dc3545;
            color: white;
        }

        .fee-status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .fee-status.approved {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .fee-status.pending {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }

        .fee-status.rejected {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        /* Add this after line 18 */
        .auth-page-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        #backgroundVideo {
            position: absolute;
            top: 50%;
            left: 50%;
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            transform: translateX(-50%) translateY(-50%);
            object-fit: cover;
        }

        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 0;
        }

        .auth-container {
            position: relative;
            z-index: 1;
        }

        .auth-box {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .auth-container {
            /* Replace the URL below with your classroom image link */
            background-image: url('https://images.unsplash.com/photo-1580582932707-520aed937b7b');

            /* This ensures the image covers the entire screen */
            background-size: cover;

            /* This prevents the image from repeating if it's small */
            background-repeat: no-repeat;

            /* This keeps the background fixed so it doesn't move when you scroll */
            background-attachment: fixed;

            /* Centers the image */
            background-position: center;

            height: 1000;

            /* Basic text styling so you can see your content */
            color: white;
            font-family: Arial, sans-serif;
            margin: 0;
            height: 100vh;
        }

        .switchs-auth-1{
            margin-top: 10px;
            margin-left: -20px;
            font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif
        }

        .switchs-auth-1 a{
            text-decoration: none;
        }
    </style>
</head>

<body>
    <!-- Authentication Page -->
    <div id="authPage" class="auth-container">
        <div class="auth-box">


            <!-- Role Selection -->
            <div id="roleSelection" class="text-center">
                <h2><i class="bi bi-speedometer2"></i> School LMS</h2>
                <div style="margin: 30px 0;">
                    <button onclick="showStudentLogin()" class="btn btn-role"
                        style="background: #4CAF50; margin-bottom: 15px; padding: 15px;">
                        <i class="bi bi-person-circle"></i> Student Login
                    </button>
                    <button onclick="showTeacherLogin()" class="btn btn-role"
                        style="background: #2196F3; margin-bottom: 15px; padding: 15px;">
                        <i class="bi bi-person-workspace"></i> Teacher Login
                    </button>
                    <button onclick="showAdminLogin()" class="btn btn-role" style="background: #6f42c1; padding: 15px;">
                        <i class="bi bi-shield-lock"></i> Admin Login
                    </button>
                </div>
                <div class="switch-auth-1">
                    <span style="color: black;">Don't have an account? </span>
                    <a href="#" onclick="showRegister()">Register here</a>
                </div>
            </div>

            <!-- Student Login Form -->
            <div id="studentLoginForm" class="hidden">
                <h2><i class="bi bi-person-circle"></i> Student Login</h2>
                <div id="studentLoginAlert" class="alert"></div>
                <form id="studentLoginFormElement" onsubmit="handleStudentLogin(event)">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="studentLoginEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="studentLoginPassword" required>
                    </div>
                    <button type="submit" class="btn">Login as Student</button>
                    <button type="button" class="btn btn-secondary" onclick="showRoleSelection()"
                        style="margin-top: 10px;">
                        ← Back
                    </button>
                </form>
            </div>

            <!-- Teacher Login Form -->
            <div id="teacherLoginForm" class="hidden">
                <h2><i class="bi bi-person-workspace"></i> Teacher Login</h2>
                <div id="teacherLoginAlert" class="alert"></div>
                <form id="teacherLoginFormElement" onsubmit="handleTeacherLogin(event)">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="teacherLoginEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="teacherLoginPassword" required>
                    </div>
                    <div class="form-group">
                        <label>Teacher Code</label>
                        <input type="text" id="teacherCode" required placeholder="Enter your unique teacher code">
                    </div>
                    <button type="submit" class="btn">Login as Teacher</button>
                    <button type="button" class="btn btn-secondary" onclick="showRoleSelection()"
                        style="margin-top: 10px;">
                        ← Back
                    </button>
                </form>
            </div>

            <!-- Admin Login Form -->
            <div id="adminLoginForm" class="hidden">
                <h2><i class="bi bi-shield-lock"></i> Admin Login</h2>
                <div id="adminLoginAlert" class="alert"></div>
                <form id="adminLoginFormElement" onsubmit="handleAdminLogin(event)">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="adminLoginEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="adminLoginPassword" required>
                    </div>
                    <button type="submit" class="btn">Login as Admin</button>
                    <button type="button" class="btn btn-secondary" onclick="showRoleSelection()"
                        style="margin-top: 10px;">
                        ← Back
                    </button>
                </form>
            </div>

            <!-- Register Form -->
            <div id="registerForm" class="hidden">
                <h2><i class="bi bi-person-circle"></i> Student Registration</h2>
                <div id="registerAlert" class="alert"></div>
                <form id="registerFormElement" onsubmit="handleRegister(event)">
                    <div class="form-group">
                        <label>First Name *</label>
                        <input type="text" id="regFirstName" required>
                    </div>
                    <div class="form-group">
                        <label>Last Name *</label>
                        <input type="text" id="regLastName" required>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="regEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Password *</label>
                        <input type="password" id="regPassword" required>
                    </div>
                    <div class="form-group">
                        <label>Register as *</label>
                        <select id="regRole" required onchange="toggleStudentFields()">
                            <option value="student">Student</option>
                        </select>
                    </div>
                    <div id="studentFields">
                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="tel" id="regPhone">
                        </div>
                        <div class="form-group">
                            <label>Address</label>
                            <input type="text" id="regAddress">
                        </div>
                        <div class="form-group">
                            <label>Date of Birth</label>
                            <input type="date" id="regDOB">
                        </div>
                        <div class="form-group">
                            <label>Gender</label>
                            <select id="regGender">
                                <option value="">Select</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Level *</label>
                            <select id="regLevel" required onchange="toggleDepartmentField()">
                                <option value="">Select class</option>
                                <option value="MS1">Middle School 1 (MS1)</option>
                                <option value="MS2">Middle School 2 (MS2)</option>
                                <option value="MS3">Middle School 3 (MS3)</option>
                                <option value="HS1">High School 1 (HS1)</option>
                                <option value="HS2">High School 2 (HS2)</option>
                                <option value="HS3">High School 3 (HS3)</option>
                            </select>
                        </div>

                        <div id="departmentField" class="form-group hidden">
                            <label>Department * (Required for HS students)</label>
                            <select id="regDepartment">
                                <option value="">Select Department</option>
                                <option value="Science">Science</option>
                                <option value="Commercial">Commercial</option>
                                <option value="Arts">Arts</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn">Register</button>
                </form>
                <div class="switchs-auth-1">
                    <span class="log" style="color: black;">Already have an account?</span> <a href="#" onclick="showLogin()">Login here</a>
                </div>
            </div>

            <!-- Registration Success Modal -->
            <div id="registrationSuccessModal" class="modal">
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3><i class="bi bi-check-circle-fill" style="color: #28a745;"></i> Registration Successful!
                        </h3>
                        <span class="close-modal" onclick="closeModal('registrationSuccessModal')">&times;</span>
                    </div>
                    <div style="padding: 25px; text-align: center;">
                        <div style="margin-bottom: 20px;">
                            <div style="width: 80px; height: 80px; margin: 0 auto; 
                     background: linear-gradient(135deg, #28a745 0%, #20c997 100%); 
                     border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-person-check" style="font-size: 36px; color: white;"></i>
                            </div>
                        </div>

                        <h4 id="registrationMessage" style="color: #333; margin-bottom: 20px; line-height: 1.5;"></h4>

                        <div id="studentIdDisplay" style="display: none;">
                            <div class="student-id-highlight">
                                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Your Student ID:</div>
                                <div id="generatedStudentId" style="font-family: monospace; letter-spacing: 2px;"></div>
                            </div>

                            <div class="success-info-box" style="text-align: left; margin-top: 20px;">
                                <p style="color: #333; font-weight: 600; margin-bottom: 10px;">
                                    <i class="bi bi-key"></i> Important Login Information:
                                </p>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                                    <div><strong>Email:</strong></div>
                                    <div id="successEmail"></div>
                                    <div><strong>Student ID:</strong></div>
                                    <div id="successStudentId"></div>
                                    <div><strong>Department:</strong></div>
                                    <div id="successDepartment"></div>
                                    <div><strong>Level:</strong></div>
                                    <div id="successLevel"></div>
                                </div>
                            </div>

                            <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 5px; 
                     padding: 10px; margin: 15px 0; text-align: left;">
                                <p style="color: #856404; margin: 0; font-size: 13px;">
                                    <i class="bi bi-exclamation-triangle"></i>
                                    <strong>Important:</strong> Please save your Student ID. You'll need it along with
                                    your password to login.
                                </p>
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 25px;">
                            <button class="btn" onclick="closeModal('registrationSuccessModal'); showRoleSelection();"
                                style="flex: 1; background: #667eea; padding: 12px;">
                                <i class="bi bi-box-arrow-in-right"></i> Go to Login
                            </button>
                            <button class="btn btn-secondary" onclick="closeModal('registrationSuccessModal')"
                                style="flex: 1; padding: 12px;">
                                <i class="bi bi-x-circle"></i> Close
                            </button>
                        </div>

                        <p style="color: #666; font-size: 12px; margin-top: 15px;">
                            <i class="bi bi-info-circle"></i> You can now login with your credentials
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Dashboard -->
    <div id="studentDashboard" class="dashboard">
        <div class="container">
            <div class="header">
                <h1><i class="bi bi-person-circle"></i> Student Dashboard</h1>
                <div class="user-info">
                    <div style="position: relative; margin-right: 15px;">
                        <button class="btn btn-small" onclick="toggleNotifications()"
                            style="position: relative; background: #667eea;">
                            <i class="bi bi-bell"></i> Notifications
                            <span id="notificationBadge" class="hidden"
                                style="position: absolute; top: -8px; right: -8px; background: #dc3545; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 11px; display: flex; align-items: center; justify-content: center; font-weight: bold;"></span>
                        </button>
                        <div id="notificationDropdown" class="hidden"
                            style="position: absolute; top: 45px; right: 0; background: white; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); width: 400px; max-height: 500px; overflow-y: auto; z-index: 1000;">
                            <div
                                style="padding: 15px; border-bottom: 2px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                                <h4 style="color: #667eea; margin: 0;">Notifications</h4>
                                <button onclick="markAllAsRead()" class="btn btn-small"
                                    style="padding: 4px 8px; font-size: 12px;">
                                    <i class="bi bi-check-all"></i> Mark all read
                                </button>
                            </div>
                            <div id="notificationsList" style="max-height: 300px; overflow-y: auto;"></div>
                            <div style="padding: 15px; border-top: 2px solid #f0f0f0;">
                                <button onclick="showAllNotifications()" class="btn btn-small"
                                    style="width: 100%; background: #667eea;">
                                    <i class="bi bi-list"></i> View All Notifications
                                </button>
                            </div>
                        </div>
                    </div>
                    <span id="studentName" class="user-badge"></span>
                    <button class="btn btn-small btn-secondary" onclick="logout()">Logout</button>
                </div>
            </div>

            <div class="main-content">
                <div class="sidebar">
                    <div class="menu-item active" onclick="showSection('overview')"><i class="bi bi-grid-1x2-fill"></i>
                        Overview</div>
                    <div class="menu-item" onclick="showSection('courses')"><i class="bi bi-book"></i> My Courses</div>
                    <div class="menu-item" onclick="showSection('enroll')"><i class="bi bi-journal-plus"></i> Enroll in
                        Courses</div>
                    <div class="menu-item" onclick="showSection('assignments')"><i class="bi bi-pencil-square"></i>
                        Assignments</div>
                    <div class="menu-item" onclick="showSection('grades')"><i class="bi bi-award"></i> Grades</div>
                    <div class="menu-item" onclick="showSection('discussions')"><i class="bi bi-chat-right-dots"></i>
                        Discussions</div>
                    <div class="menu-item" onclick="showSection('materials')"><i class="bi bi-collection"></i> Course
                        Materials</div>
                    <!-- Add to student sidebar -->
                    <div class="menu-item" onclick="showSection('fee-payment')">
                        <i class="bi bi-credit-card"></i> Fee Payment
                    </div>
                    <div class="menu-item" onclick="showSection('profile')"><i class="bi bi-person-fill"></i> My Profile
                    </div>
                    <!-- Student Fee Payment Section -->
                    <div id="fee-payment" class="section">
                        <h2><i class="bi bi-credit-card"></i> Fee Payment</h2>

                        <!-- Fee Status Banner -->
                        <div id="feeStatusBanner" style="margin-bottom: 20px;">
                            <!-- Status will be loaded here -->
                        </div>

                        <!-- Payment History -->
                        <div style="margin-bottom: 20px;">
                            <h3><i class="bi bi-clock-history"></i> Payment History</h3>
                            <div id="studentFeePaymentsList">
                                <!-- Payment history will be loaded here -->
                            </div>
                        </div>

                        <!-- Fee Structure -->
                        <div id="feeStructureSection" style="display: none;">
                            <h3><i class="bi bi-receipt"></i> Fee Structure</h3>
                            <div id="feeStructureInfo">
                                <!-- Fee structure will be loaded here -->
                            </div>
                        </div>

                        <!-- Payment Instructions -->
                        <div class="card" style="background: #f8f9fa; margin-top: 20px;">
                            <h3><i class="bi bi-info-circle"></i> Payment Instructions</h3>
                            <p>To make a fee payment:</p>
                            <ol style="margin: 10px 0 10px 20px;">
                                <li>Visit the school administration office</li>
                                <li>Present your Student ID: <strong id="currentStudentId"></strong></li>
                                <li>Make payment and collect receipt</li>
                                <li>Admin will record and approve your payment</li>
                                <li>You'll receive notification when approved</li>
                            </ol>
                            <p style="color: #666; font-size: 14px;">
                                <i class="bi bi-exclamation-triangle"></i>
                                You cannot access courses until your fee payment is approved.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="content-area">
                    <!-- Overview Section -->
                    <div id="overview" class="section active">
                        <h2>Welcome to Your Learning Portal</h2>
                        <div id="subjectCombinationContainer"></div>
                        <div id="recentAnnouncements"></div>
                    </div>

                    <!-- My Courses Section -->
                    <div id="courses" class="section">
                        <h2>My Enrolled Courses</h2>
                        <div id="enrolledCoursesList"></div>
                    </div>

                    <!-- Enroll Section -->
                    <div id="enroll" class="section">
                        <h2>Available Courses</h2>
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label>Search Courses</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="courseSearch"
                                    placeholder="Search by course name, code, or teacher..." style="flex: 1;"
                                    onkeyup="filterCourses()">
                                <select id="searchCategory" onchange="filterCourses()" style="width: 150px;">
                                    <option value="all">All</option>
                                    <option value="title">Course Name</option>
                                    <option value="code">Course Code</option>
                                    <option value="teacher">Teacher</option>
                                </select>
                            </div>
                        </div>
                        <div id="availableCoursesList"></div>
                    </div>

                    <!-- Assignments Section -->
                    <div id="assignments" class="section">
                        <h2>My Assignments</h2>
                        <div id="assignmentsList"></div>
                    </div>

                    <!-- Grades Section -->
                    <div id="grades" class="section">
                        <h2>My Grades</h2>
                        <div class="form-group">
                            <label>Select Course</label>
                            <select id="gradesCourseSelect" onchange="loadStudentGrades()">
                                <option value="">Select a course</option>
                            </select>
                        </div>
                        <div id="gradesList"></div>
                    </div>

                    <!-- Discussions Section -->
                    <div id="discussions" class="section">
                        <h2>Course Discussions</h2>
                        <div class="form-group">
                            <label>Select Course</label>
                            <select id="discussionCourseSelect" onchange="loadDiscussions()">
                                <option value="">Select a course</option>
                            </select>
                        </div>
                        <button class="btn btn-small" onclick="showNewPostModal()">New Discussion Post</button>
                        <div id="discussionsList"></div>
                    </div>

                    <!-- Materials Section -->
                    <div id="materials" class="section">
                        <h2>Course Materials</h2>
                        <div class="form-group">
                            <label>Select Course</label>
                            <select id="materialsCourseSelect" onchange="loadMaterials()">
                                <option value="">Select a course</option>
                            </select>
                        </div>
                        <div id="materialsList"></div>
                    </div>

                    <!-- Profile Section -->
                    <div id="profile" class="section">
                        <h2>My Profile</h2>
                        <div class="form-container">
                            <form id="studentProfileForm" onsubmit="updateStudentProfile(event)">
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" id="profileEmail" readonly style="background: #f5f5f5;">
                                </div>
                                <div class="form-group">
                                    <label>First Name</label>
                                    <input type="text" id="profileFirstName" required>
                                </div>
                                <div class="form-group">
                                    <label>Last Name</label>
                                    <input type="text" id="profileLastName" required>
                                </div>
                                <div class="form-group">
                                    <label>Phone Number</label>
                                    <input type="tel" id="profilePhone">
                                </div>
                                <div class="form-group">
                                    <label>Address</label>
                                    <input type="text" id="profileAddress">
                                </div>
                                <div class="form-group">
                                    <label>Date of Birth</label>
                                    <input type="date" id="profileDOB">
                                </div>
                                <button type="submit" class="btn">Update Profile</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Teacher Dashboard -->
    <div id="teacherDashboard" class="dashboard">
        <div class="container">
            <div class="header">
                <h1><i class="bi bi-person-workspace"></i> Teacher Dashboard</h1>
                <div class="user-info">
                    <div style="position: relative; margin-right: 15px;">
                        <button class="btn btn-small" onclick="toggleTeacherNotifications()"
                            style="position: relative; background: #667eea;">
                            <i class="bi bi-bell"></i> Notifications
                            <span id="teacherNotificationBadge" class="hidden"
                                style="position: absolute; top: -8px; right: -8px; background: #dc3545; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 11px; display: flex; align-items: center; justify-content: center; font-weight: bold;"></span>
                        </button>
                        <div id="teacherNotificationDropdown" class="hidden"
                            style="position: absolute; top: 45px; right: 0; background: white; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); width: 400px; max-height: 500px; overflow-y: auto; z-index: 1000;">
                            <div
                                style="padding: 15px; border-bottom: 2px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                                <h4 style="color: #667eea; margin: 0;">Notifications</h4>
                                <button onclick="markAllTeacherNotificationsAsRead()" class="btn btn-small"
                                    style="padding: 4px 8px; font-size: 12px;">
                                    <i class="bi bi-check-all"></i> Mark all read
                                </button>
                            </div>
                            <div id="teacherNotificationsList" style="max-height: 300px; overflow-y: auto;"></div>
                            <div style="padding: 15px; border-top: 2px solid #f0f0f0;">
                                <button onclick="showAllTeacherNotifications()" class="btn btn-small"
                                    style="width: 100%; background: #667eea;">
                                    <i class="bi bi-list"></i> View All Notifications
                                </button>
                            </div>
                        </div>
                    </div>
                    <span id="teacherName" class="user-badge"></span>
                    <button class="btn btn-small btn-secondary" onclick="logout()">Logout</button>
                </div>
            </div>

            <div class="main-content">
                <div class="sidebar">
                    <div class="menu-item active" onclick="showTeacherSection('t-courses')"><i
                            class="bi bi-journals"></i> My Courses</div>
                    <div class="menu-item" onclick="showTeacherSection('t-students')"><i
                            class="bi bi-person-lines-fill"></i> Enrolled Students</div>
                    <div class="menu-item" onclick="showTeacherSection('t-announcements')"><i
                            class="bi bi-megaphone-fill"></i> Announcements</div>
                    <div class="menu-item" onclick="showTeacherSection('t-assignments')"><i
                            class="bi bi-journal-check"></i> Assignments</div>
                    <div class="menu-item" onclick="showTeacherSection('t-materials')"><i class="bi bi-collection"></i>
                        Materials</div>
                    <div class="menu-item" onclick="showTeacherSection('t-grading')"><i class="bi bi-pencil-square"></i>
                        Grading</div>
                    <div class="menu-item" onclick="showTeacherSection('t-discussions')"><i
                            class="bi bi-chat-left-dots"></i> Discussions</div>
                    <div class="menu-item" onclick="showTeacherSection('t-profile')"><i class="bi bi-person-badge"></i>
                        My Profile</div>
                </div>

                <div class="content-area">
                    <!-- Teacher Courses -->
                    <div id="t-courses" class="section active">
                        <h2>My Courses</h2>
                        <button class="btn btn-small" onclick="showManageCoursesModal()" style="margin-bottom: 20px;"><i
                                class="bi bi-journal-text"></i> Manage My Courses</button>
                        <div id="teacherCoursesList"></div>
                    </div>

                    <!-- Enrolled Students -->
                    <div id="t-students" class="section">
                        <h2>Enrolled Students by Course</h2>
                        <div class="form-group">
                            <label>Select Course</label>
                            <select id="studentsCourseSelect" onchange="loadEnrolledStudents()">
                                <option value="">Select a course</option>
                            </select>
                        </div>
                        <div id="enrolledStudentsList"></div>
                    </div>

                    <!-- Announcements -->
                    <div id="t-announcements" class="section">
                        <h2>Post Announcement</h2>
                        <div class="form-container">
                            <form id="announcementForm" onsubmit="createAnnouncement(event)">
                                <div class="form-group">
                                    <label>Select Course</label>
                                    <select id="announcementCourse" required></select>
                                </div>
                                <div class="form-group">
                                    <label>Title</label>
                                    <input type="text" id="announcementTitle" required>
                                </div>
                                <div class="form-group">
                                    <label>Content</label>
                                    <textarea id="announcementContent" rows="5" required></textarea>
                                </div>
                                <button type="submit" class="btn">Post Announcement</button>
                            </form>
                        </div>
                    </div>

                    <!-- Create Assignment -->
                    <div id="t-assignments" class="section">
                        <h2>Create Assignment</h2>
                        <div class="form-container">
                            <form id="assignmentForm" onsubmit="createAssignment(event)">
                                <div class="form-group">
                                    <label>Select Course</label>
                                    <select id="assignmentCourse" required></select>
                                </div>
                                <div class="form-group">
                                    <label>Assignment Title</label>
                                    <input type="text" id="assignmentTitle" required>
                                </div>
                                <div class="form-group">
                                    <label>Description</label>
                                    <textarea id="assignmentDescription" rows="4" required></textarea>
                                </div>
                                <div class="form-group">
                                    <label>Due Date</label>
                                    <input type="datetime-local" id="assignmentDueDate" required>
                                </div>
                                <div class="form-group">
                                    <label>Maximum Points</label>
                                    <input type="number" id="assignmentPoints" required>
                                </div>
                                <button type="submit" class="btn">Create Assignment</button>
                            </form>
                        </div>
                    </div>

                    <!-- Add Materials -->
                    <div id="t-materials" class="section">
                        <h2>Add Course Material</h2>
                        <div class="form-container">
                            <form id="materialForm" onsubmit="addMaterial(event)">
                                <div class="form-group">
                                    <label>Select Course</label>
                                    <select id="materialCourse" required></select>
                                </div>
                                <div class="form-group">
                                    <label>Material Title</label>
                                    <input type="text" id="materialTitle" required>
                                </div>
                                <div class="form-group">
                                    <label>Description</label>
                                    <textarea id="materialDescription" rows="3"></textarea>
                                </div>
                                <div class="form-group">
                                    <label>Material Type</label>
                                    <select id="materialType" required>
                                        <option value="pdf">PDF</option>
                                        <option value="video">Video</option>
                                        <option value="link">Link</option>
                                        <option value="document">Document</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>File URL / Link</label>
                                    <input type="text" id="materialUrl">
                                </div>
                                <button type="submit" class="btn">Add Material</button>
                            </form>
                        </div>
                    </div>

                    <!-- Grading -->
                    <div id="t-grading" class="section">
                        <h2>Grade Submissions</h2>
                        <div class="form-group">
                            <label>Select Course</label>
                            <select id="gradingCourseSelect" onchange="loadCourseAssignments()">
                                <option value="">Select a course</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Select Assignment</label>
                            <select id="gradingAssignmentSelect" onchange="loadSubmissions()">
                                <option value="">Select an assignment</option>
                            </select>
                        </div>
                        <div id="submissionsList"></div>
                    </div>

                    <!-- Teacher Discussions -->
                    <div id="t-discussions" class="section">
                        <h2>Course Discussions</h2>
                        <div class="form-group">
                            <label>Select Course</label>
                            <select id="teacherDiscussionCourseSelect" onchange="loadTeacherDiscussions()">
                                <option value="">Select a course</option>
                            </select>
                        </div>
                        <button class="btn btn-small" onclick="showNewPostModal()">New Discussion Post</button>
                        <div id="teacherDiscussionsList"></div>
                    </div>

                    <!-- Teacher Profile -->
                    <div id="t-profile" class="section">
                        <h2>My Profile</h2>
                        <div class="form-container">
                            <div class="form-group">
                                <label>Teacher Code</label>
                                <input type="text" id="teacherProfileCode" readonly style="background: #f5f5f5;">
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="teacherProfileEmail" readonly style="background: #f5f5f5;">
                            </div>
                            <div class="form-group">
                                <label>Specialization</label>
                                <input type="text" id="teacherProfileSpecialization">
                            </div>
                            <div class="form-group">
                                <label>Department</label>
                                <input type="text" id="teacherProfileDepartment" readonly style="background: #f5f5f5;">
                            </div>
                            <button class="btn" onclick="updateTeacherProfile()">Update Profile</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="dashboard">
        <div class="container">
            <div class="header">
                <h1><i class="bi bi-shield-lock"></i> Admin Dashboard</h1>
                <div class="user-info">
                    <div style="position: relative; margin-right: 15px;">
                        <button class="btn btn-small" onclick="toggleAdminNotifications()"
                            style="position: relative; background: #667eea;">
                            <i class="bi bi-bell"></i> Notifications
                            <span id="adminNotificationBadge" class="hidden"
                                style="position: absolute; top: -8px; right: -8px; background: #dc3545; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 11px; display: flex; align-items: center; justify-content: center; font-weight: bold;"></span>
                        </button>
                        <div id="adminNotificationDropdown" class="hidden"
                            style="position: absolute; top: 45px; right: 0; background: white; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); width: 400px; max-height: 500px; overflow-y: auto; z-index: 1000;">
                            <div
                                style="padding: 15px; border-bottom: 2px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                                <h4 style="color: #667eea; margin: 0;">Notifications</h4>
                                <button onclick="markAllAdminNotificationsAsRead()" class="btn btn-small"
                                    style="padding: 4px 8px; font-size: 12px;">
                                    <i class="bi bi-check-all"></i> Mark all read
                                </button>
                            </div>
                            <div id="adminNotificationsList" style="max-height: 300px; overflow-y: auto;"></div>
                            <div style="padding: 15px; border-top: 2px solid #f0f0f0;">
                                <button onclick="showAllAdminNotifications()" class="btn btn-small"
                                    style="width: 100%; background: #667eea;">
                                    <i class="bi bi-list"></i> View All Notifications
                                </button>
                            </div>
                        </div>
                    </div>
                    <span id="adminName" class="user-badge">Administrator</span>
                    <button class="btn btn-small btn-secondary" onclick="logout()">Logout</button>
                </div>
            </div>

            <div class="main-content">
                <!-- SIDEBAR - ONLY MENU ITEMS -->
                <div class="sidebar">
                    <div class="menu-item active" onclick="showAdminSection('admin-students')">
                        <i class="bi bi-person-check"></i> Manage Students
                    </div>
                    <div class="menu-item" onclick="showAdminSection('admin-teachers')">
                        <i class="bi bi-person-rolodex"></i> Manage Teachers
                    </div>
                    <div class="menu-item" onclick="showAdminSection('admin-courses')">
                        <i class="bi bi-journal-text"></i> Manage Courses
                    </div>
                    <div class="menu-item" onclick="showAdminSection('admin-deploy-courses')">
                        <i class="bi bi-rocket-takeoff"></i> Deploy Courses
                    </div>
                    <div class="menu-item" onclick="showAdminSection('admin-announcements')">
                        <i class="bi bi-megaphone-fill"></i> Announcements
                    </div>
                    <div class="menu-item" onclick="showAdminSection('admin-enrollments')">
                        <i class="bi bi-person-lines-fill"></i> Manage Enrollments
                    </div>
                    <div class="menu-item" onclick="showAdminSection('admin-fee-management')">
                        <i class="bi bi-cash-stack"></i> Fee Management
                        <span id="feePendingBadge" class="hidden" style="background: #dc3545; color: white; border-radius: 50%; 
                        width: 20px; height: 20px; font-size: 11px; 
                        display: inline-flex; align-items: center; 
                        justify-content: center; margin-left: 5px;"></span>
                    </div>
                    <div class="menu-item" onclick="showAdminSection('admin-approvals')">
                        <i class="bi bi-clipboard-check"></i> Approvals
                        <span id="approvalBadge" class="hidden"
                            style="background: #dc3545; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 11px; display: inline-flex; align-items: center; justify-content: center; margin-left: 5px;"></span>
                    </div>
                    <div class="menu-item" onclick="showAdminSection('admin-settings')">
                        <i class="bi bi-sliders"></i> System Settings
                    </div>
                </div>

                <!-- CONTENT AREA - ALL SECTIONS GO HERE -->
                <div class="content-area">
                    <!-- Manage Students Section -->
                    <div id="admin-students" class="section active">
                        <h2>Student Management</h2>
                        <div class="form-group" style="margin-bottom: 20px;">
                            <input type="text" id="searchStudents" placeholder="Search students..."
                                style="width: 300px; padding: 10px;" onkeyup="searchStudents()"
                                class="search-container">
                        </div>
                        <div id="studentsList"></div>
                    </div>

                    <!-- Manage Teachers Section -->
                    <div id="admin-teachers" class="section">
                        <h2>Teacher Management</h2>
                        <button class="btn btn-small" onclick="showCreateTeacherModal()" style="margin-bottom: 20px;">
                            ＋ Add New Teacher
                        </button>
                        <div id="teachersList"></div>
                    </div>

                    <!-- Manage Courses Section -->
                    <div id="admin-courses" class="section">
                        <h2>Course Management</h2>
                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <button class="btn btn-small" onclick="showCreateCourseModal()">
                                ＋ Add New Course
                            </button>
                            <button class="btn btn-small" onclick="showAddCompulsoryCourseModal()"
                                style="background: #28a745;">
                                <i class="bi bi-check-circle"></i> Add Compulsory Course
                            </button>
                            <button class="btn btn-small" onclick="showClearAllCoursesModal()"
                                style="background: #dc3545;">
                                <i class="bi bi-trash-fill"></i> Clear All Courses
                            </button>
                        </div>
                        <div id="adminCoursesList"></div>
                    </div>

                    <!-- Deploy Department Courses Section -->
                    <div id="admin-deploy-courses" class="section">
                        <h2><i class="bi bi-rocket-takeoff"></i> Deploy Department Courses</h2>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 20px;">

                            <!-- Department Selection -->
                            <div
                                style="background: #f8f9fa; padding: 25px; border-radius: 10px; border: 1px solid #e0e0e0;">
                                <h3 style="color: #667eea; margin-bottom: 20px;">
                                    <i class="bi bi-gear"></i> Select Department & Level
                                </h3>
                                <div class="form-group">
                                    <label>Department</label>
                                    <select id="deployDepartment" class="form-control"
                                        onchange="loadDepartmentCourseTemplate()">
                                        <option value="">Select Department</option>
                                        <option value="Science">Science</option>
                                        <option value="Arts">Arts</option>
                                        <option value="Commercial">Commercial</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Level</label>
                                    <select id="deployLevel" class="form-control"
                                        onchange="loadDepartmentCourseTemplate()">
                                        <option value="">Select Level</option>
                                        <option value="MS1">Middle School 1 (MS1)</option>
                                        <option value="MS2">Middle School 2 (MS2)</option>
                                        <option value="MS3">Middle School 3 (MS3)</option>
                                        <option value="HS1">High School 1 (HS1)</option>
                                        <option value="HS2">High School 2 (HS2)</option>
                                        <option value="HS3">High School 3 (HS3)</option>
                                    </select>
                                </div>
                                <button class="btn" onclick="loadDepartmentCourseTemplate()"
                                    style="width: 100%; margin-top: 15px;">
                                    <i class="bi bi-arrow-clockwise"></i> Load Course Template
                                </button>
                            </div>

                            <!-- Current Department Courses -->
                            <div
                                style="background: #f8f9fa; padding: 25px; border-radius: 10px; border: 1px solid #e0e0e0;">
                                <h3 style="color: #28a745; margin-bottom: 20px;">
                                    <i class="bi bi-journals"></i> Existing Department Courses
                                </h3>
                                <div id="existingDepartmentCourses">
                                    <p style="color: #666; text-align: center; padding: 20px;">
                                        Select a department and level to view existing courses
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Course Deployment Form -->
                        <div id="departmentCourseForm" style="display: none; margin-top: 30px;">
                            <div
                                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                                <h3 style="margin: 0;">
                                    <i class="bi bi-rocket-takeoff"></i> Deploy Courses for
                                    <span id="deployHeader">[Department] - [Level]</span>
                                </h3>
                            </div>

                            <div
                                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 30px;">
                                <!-- Science Courses -->
                                <div id="scienceCourses" class="department-courses" style="display: none;">
                                    <div
                                        style="background: #e3f2fd; padding: 20px; border-radius: 10px; border: 2px solid #2196F3;">
                                        <h4 style="color: #2196F3; margin-bottom: 15px;">
                                            <i class="bi bi-flask"></i> Science Department Courses
                                        </h4>
                                        <div id="scienceCourseList">
                                            <!-- Science courses will be loaded here -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Arts Courses -->
                                <div id="artsCourses" class="department-courses" style="display: none;">
                                    <div
                                        style="background: #f3e5f5; padding: 20px; border-radius: 10px; border: 2px solid #9C27B0;">
                                        <h4 style="color: #9C27B0; margin-bottom: 15px;">
                                            <i class="bi bi-palette"></i> Arts Department Courses
                                        </h4>
                                        <div id="artsCourseList">
                                            <!-- Arts courses will be loaded here -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Commercial Courses -->
                                <div id="commercialCourses" class="department-courses" style="display: none;">
                                    <div
                                        style="background: #e8f5e9; padding: 20px; border-radius: 10px; border: 2px solid #4CAF50;">
                                        <h4 style="color: #4CAF50; margin-bottom: 15px;">
                                            <i class="bi bi-graph-up"></i> Commercial Department Courses
                                        </h4>
                                        <div id="commercialCourseList">
                                            <!-- Commercial courses will be loaded here -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div style="text-align: center; margin-top: 30px;">
                                <button class="btn" onclick="deployDepartmentCourses()"
                                    style="padding: 15px 30px; font-size: 16px;">
                                    <i class="bi bi-rocket-takeoff"></i> Deploy Selected Courses
                                </button>
                                <p style="color: #666; font-size: 14px; margin-top: 10px;">
                                    This will create/update courses and auto-enroll students in the selected department
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Manage Enrollments Section -->
                    <div id="admin-enrollments" class="section">
                        <h2><i class="bi bi-person-lines-fill"></i> Course Enrollments Management</h2>

                        <div style="margin-bottom: 20px;">
                            <div class="form-group">
                                <label>Search Enrollments</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" id="searchEnrollments"
                                        placeholder="Search by student name, ID, email, or course..."
                                        style="flex: 1; padding: 10px;" onkeyup="searchEnrollments()">
                                    <button class="btn btn-small" onclick="loadAllEnrollments()">
                                        <i class="bi bi-arrow-clockwise"></i> Refresh
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div id="enrollmentsList">
                            <!-- Enrollments will be loaded here -->
                        </div>
                    </div>

                    <!-- Admin Announcements Section -->
                    <div id="admin-announcements" class="section">
                        <h2><i class="bi bi-megaphone-fill"></i> System Announcements</h2>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                            <!-- Announcements to Teachers -->
                            <div
                                style="background: #f8f9fa; padding: 25px; border-radius: 10px; border: 1px solid #e0e0e0;">
                                <h3
                                    style="color: #2196F3; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                                    <i class="bi bi-person-workspace"></i> Announcement to Teachers
                                </h3>
                                <form id="teacherAnnouncementForm" onsubmit="sendAnnouncementToTeachers(event)">
                                    <div class="form-group">
                                        <label>Title</label>
                                        <input type="text" id="teacherAnnouncementTitle" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Message</label>
                                        <textarea id="teacherAnnouncementContent" rows="5" required></textarea>
                                    </div>
                                    <button type="submit" class="btn" style="background: #2196F3;">
                                        <i class="bi bi-send"></i> Send to Teachers
                                    </button>
                                </form>
                            </div>

                            <!-- Announcements to Students -->
                            <div
                                style="background: #f8f9fa; padding: 25px; border-radius: 10px; border: 1px solid #e0e0e0;">
                                <h3
                                    style="color: #4CAF50; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                                    <i class="bi bi-person-circle"></i> Announcement to Students
                                </h3>
                                <form id="studentAnnouncementForm" onsubmit="sendAnnouncementToStudents(event)">
                                    <div class="form-group">
                                        <label>Title</label>
                                        <input type="text" id="studentAnnouncementTitle" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Message</label>
                                        <textarea id="studentAnnouncementContent" rows="5" required></textarea>
                                    </div>
                                    <button type="submit" class="btn" style="background: #4CAF50;">
                                        <i class="bi bi-send"></i> Send to Students
                                    </button>
                                </form>
                            </div>
                        </div>

                        <!-- Recent Announcements -->
                        <div style="margin-top: 40px;">
                            <h3 style="color: #667eea; margin-bottom: 20px;">
                                <i class="bi bi-clock-history"></i> Recent Announcements
                            </h3>
                            <div id="recentAdminAnnouncements"></div>
                        </div>
                    </div>

                    <!-- Fee Management Section -->
                    <div id="admin-fee-management" class="section">
                        <h2><i class="bi bi-cash-stack"></i> Fee Payment Management</h2>

                        <div style="margin-bottom: 20px;">
                            <div class="form-group">
                                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                    <input type="text" id="searchFeePayments"
                                        placeholder="Search payments, students, or receipt numbers..."
                                        style="flex: 1; padding: 10px;" onkeyup="searchFeePayments()">
                                    <button class="btn btn-small" onclick="loadFeeManagementData()">
                                        <i class="bi bi-arrow-clockwise"></i> Refresh
                                    </button>
                                    <button class="btn btn-small" onclick="showRecordFeePaymentModal()"
                                        style="background: #28a745;">
                                        <i class="bi bi-plus-circle"></i> Record Payment
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Statistics Cards -->
                        <div class="card-grid" id="feeStatistics">
                            <!-- Statistics will be loaded here -->
                        </div>

                        <!-- Tabs for different views -->
                        <div style="margin: 20px 0;">
                            <div style="display: flex; gap: 5px; border-bottom: 2px solid #e0e0e0;">
                                <button class="btn-tab active" onclick="showFeeTab('pending')" style="padding: 10px 20px; background: none; border: none; 
                                border-bottom: 3px solid #667eea; cursor: pointer;">
                                    <i class="bi bi-clock"></i> Pending Approval
                                </button>
                                <button class="btn-tab" onclick="showFeeTab('approved')" style="padding: 10px 20px; background: none; border: none; 
                                cursor: pointer;">
                                    <i class="bi bi-check-circle"></i> Approved
                                </button>
                                <button class="btn-tab" onclick="showFeeTab('all')" style="padding: 10px 20px; background: none; border: none; 
                                cursor: pointer;">
                                    <i class="bi bi-list"></i> All Payments
                                </button>
                                <button class="btn-tab" onclick="showFeeTab('students')" style="padding: 10px 20px; background: none; border: none; 
                                cursor: pointer;">
                                    <i class="bi bi-people"></i> Students Status
                                </button>
                            </div>
                        </div>

                        <!-- Payment List -->
                        <div id="feePaymentsList">
                            <!-- Payments will be loaded here -->
                        </div>

                        <!-- Students Status -->
                        <div id="studentsFeeStatus" style="display: none;">
                            <!-- Students fee status will be loaded here -->
                        </div>
                    </div>

                    <!-- Admin Approvals Section -->
                    <div id="admin-approvals" class="section">
                        <h2><i class="bi bi-clipboard-check"></i> Course Approval Requests</h2>
                        <div style="margin-bottom: 20px;">
                            <button class="btn btn-small" onclick="showApprovalHistory()" style="margin-right: 10px;">
                                <i class="bi bi-clock-history"></i> View History
                            </button>
                            <button class="btn btn-small btn-secondary" onclick="refreshApprovals()">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                        </div>
                        <div id="approvalsList">
                            <!-- Approval requests will be loaded here -->
                        </div>
                    </div>

                    <!-- System Settings Section -->
                    <div id="admin-settings" class="section">
                        <h2>System Settings</h2>
                        <div class="card">
                            <h3>Database Management</h3>
                            <button class="btn btn-small" onclick="backupDatabase()" style="margin-right: 10px;">
                                <i class="bi bi-database-down"></i> Backup Database
                            </button>
                            <button class="btn btn-small btn-secondary" onclick="showResetModal()">
                                <i class="bi bi-arrow-counterclockwise"></i> Reset System
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="submitAssignmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Submit Assignment</h3>
                <span class="close-modal" onclick="closeModal('submitAssignmentModal')">&times;</span>
            </div>
            <form id="submitAssignmentForm" onsubmit="submitAssignment(event)">
                <input type="hidden" id="submitAssignmentId">
                <div class="form-group">
                    <label>Your Submission</label>
                    <textarea id="submissionContent" rows="6" required></textarea>
                </div>
                <button type="submit" class="btn">Submit</button>
            </form>
        </div>
    </div>

    <div id="gradeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Grade Submission</h3>
                <span class="close-modal" onclick="closeModal('gradeModal')">&times;</span>
            </div>
            <form id="gradeForm" onsubmit="gradeSubmission(event)">
                <input type="hidden" id="gradeAssignmentId">
                <input type="hidden" id="gradeStudentId">
                <div id="submissionContentDisplay"></div>
                <div class="form-group">
                    <label>Grade (Points)</label>
                    <input type="number" id="gradePoints" required>
                </div>
                <div class="form-group">
                    <label>Feedback</label>
                    <textarea id="gradeFeedback" rows="4"></textarea>
                </div>
                <button type="submit" class="btn">Submit Grade</button>
            </form>
        </div>
    </div>

    <div id="newPostModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>New Discussion Post</h3>
                <span class="close-modal" onclick="closeModal('newPostModal')">&times;</span>
            </div>
            <form id="newPostForm" onsubmit="createDiscussionPost(event)">
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="postTitle" required>
                </div>
                <div class="form-group">
                    <label>Content</label>
                    <textarea id="postContent" rows="6" required></textarea>
                </div>
                <button type="submit" class="btn">Post</button>
            </form>
        </div>
    </div>

    <div id="replyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Reply to Discussion</h3>
                <span class="close-modal" onclick="closeModal('replyModal')">&times;</span>
            </div>
            <form id="replyForm" onsubmit="replyToPost(event)">
                <input type="hidden" id="replyPostId">
                <div class="form-group">
                    <label>Your Reply</label>
                    <textarea id="replyContent" rows="4" required></textarea>
                </div>
                <button type="submit" class="btn">Reply</button>
            </form>
        </div>
    </div>

    <div id="manageCoursesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Select Courses to Teach</h3>
                <span class="close-modal" onclick="closeModal('manageCoursesModal')">&times;</span>
            </div>
            <div id="allCoursesList"></div>
        </div>
    </div>

    <div id="studentDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Student Details</h3>
                <span class="close-modal" onclick="closeModal('studentDetailsModal')">&times;</span>
            </div>
            <div id="studentDetailsContent"></div>
        </div>
    </div>

    <div id="editStudentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Student Information</h3>
                <span class="close-modal" onclick="closeModal('editStudentModal')">&times;</span>
            </div>
            <form id="editStudentForm" onsubmit="updateStudentInfo(event)">
                <input type="hidden" id="editStudentId">
                <div class="form-group">
                    <label>First Name *</label>
                    <input type="text" id="editFirstName" required>
                </div>
                <div class="form-group">
                    <label>Last Name *</label>
                    <input type="text" id="editLastName" required>
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="editEmail" required>
                </div>
                <div class="form-group">
                    <label>Student ID</label>
                    <input type="text" id="editStudentIdField">
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" id="editPhone">
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <input type="text" id="editAddress">
                </div>
                <div class="form-group">
                    <label>Date of Birth</label>
                    <input type="date" id="editDOB">
                </div>
                <div class="form-group">
                    <label>Gender</label>
                    <select id="editGender">
                        <option value="">Select</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Department</label>
                    <select id="editDepartment">
                        <option value="">Select</option>
                        <option value="Computer Science">Computer Science</option>
                        <option value="Mathematics">Mathematics</option>
                        <option value="English">English</option>
                        <option value="Business">Business</option>
                        <option value="Science">Science</option>
                        <option value="Arts">Arts</option>
                        <option value="Commercial">Commercial</option>
                        <option value="Social Sciences">Social Sciences</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Level</label>
                    <select id="editLevel">
                        <option value="">Select</option>
                        <option value="MS1">MS1</option>
                        <option value="MS2">MS2</option>
                        <option value="MS3">MS3</option>
                        <option value="HS1">HS1</option>
                        <option value="HS2">HS2</option>
                        <option value="HS3">HS3</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="editStatus">
                        <option value="active">Active</option>
                        <option value="suspended">Suspended</option>
                        <option value="graduated">Graduated</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Change Password (leave blank to keep current)</label>
                    <input type="password" id="editPassword" placeholder="New password">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn" style="flex: 1;"><i class="bi bi-person-check"></i> Update
                        Student</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editStudentModal')"
                        style="flex: 1;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="approveCourseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="bi bi-shield-lock"></i> Admin Approval Required</h3>
                <span class="close-modal" onclick="closeModal('approveCourseModal')">&times;</span>
            </div>
            <div style="padding: 20px;">
                <p>To teach <strong id="courseToApproveTitle"></strong>, you need admin approval.</p>
                <p>Please contact the administrator with your request.</p>
                <button class="btn btn-secondary" onclick="closeModal('approveCourseModal')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="createTeacherModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create Teacher Account</h3>
                <span class="close-modal" onclick="closeModal('createTeacherModal')">&times;</span>
            </div>
            <form id="createTeacherForm" onsubmit="createTeacherAccount(event)">
                <div class="form-group">
                    <label>First Name</label>
                    <input type="text" id="newTeacherFirstName" required>
                </div>
                <div class="form-group">
                    <label>Last Name</label>
                    <input type="text" id="newTeacherLastName" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="newTeacherEmail" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="newTeacherPassword" required>
                </div>
                <div class="form-group">
                    <label>Teacher Code (Unique)</label>
                    <input type="text" id="newTeacherCode" required>
                </div>
                <div class="form-group">
                    <label>Department</label>
                    <select id="newTeacherDepartment" required>
                        <option value="">Select Department</option>
                        <option value="Science">Science</option>
                        <option value="Arts">Arts</option>
                        <option value="Commercial">Commercial</option>
                    </select>
                </div>
                <button type="submit" class="btn">Create Teacher Account</button>
            </form>
        </div>
    </div>

    <div id="createCourseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Course</h3>
                <span class="close-modal" onclick="closeModal('createCourseModal')">&times;</span>
            </div>
            <form id="createCourseForm">
                <input type="hidden" id="adminCourseId">
                <div class="form-group">
                    <label>Course Title</label>
                    <input type="text" id="adminCourseTitle" required>
                </div>
                <div class="form-group">
                    <label>Course Code</label>
                    <input type="text" id="adminCourseCode" required>
                </div>
                <div class="form-group">
                    <label>Credits</label>
                    <input type="number" id="adminCourseCredits" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="adminCourseDescription" rows="4" required></textarea>
                </div>
                <div class="form-group">
                    <label>Teacher Lock</label>
                    <select id="adminCourseTeacherLock">
                        <option value="1">Yes - One teacher per course</option>
                        <option value="0">No - Multiple teachers allowed</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Level</label>
                    <select id="adminCourseLevel">
                        <option value="all">All Levels</option>
                        <option value="MS1">MS1</option>
                        <option value="MS2">MS2</option>
                        <option value="MS3">MS3</option>
                        <option value="HS1">HS1</option>
                        <option value="HS2">HS2</option>
                        <option value="HS3">HS3</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Department</label>
                    <select id="adminCourseDepartment">
                        <option value="all">All Departments</option>
                        <option value="Science">Science</option>
                        <option value="Arts">Arts</option>
                        <option value="Commercial">Commercial</option>
                        <option value="Computer Science">Computer Science</option>
                        <option value="Mathematics">Mathematics</option>
                        <option value="English">English</option>
                        <option value="Business">Business</option>
                        <option value="Social Sciences">Social Sciences</option>
                    </select>
                </div>
                <button type="submit" class="btn">Create Course</button>
            </form>
        </div>
    </div>

    <div id="resetModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>⚠️ System Reset</h3>
                <span class="close-modal" onclick="closeModal('resetModal')">&times;</span>
            </div>
            <div style="padding: 20px;">
                <p style="color: #dc3545; margin-bottom: 20px;">
                    <strong>Warning:</strong> This will reset the entire system and delete all data except admin
                    account.
                </p>
                <p>Are you sure you want to proceed?</p>
                <div style="display: flex; gap: 10px; margin-top: 30px;">
                    <button class="btn btn-secondary" onclick="closeModal('resetModal')"
                        style="flex: 1;">Cancel</button>
                    <button class="btn" onclick="resetSystem()" style="flex: 1; background: #dc3545;">Reset
                        System</button>
                </div>
            </div>
        </div>
    </div>

    <div id="logoutConfirmationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="bi bi-box-arrow-right"></i> Confirm Logout</h3>
                <span class="close-modal" onclick="closeModal('logoutConfirmationModal')">&times;</span>
            </div>
            <div style="padding: 20px; text-align: center;">
                <div style="margin-bottom: 20px;">
                    <i class="bi bi-door-open-fill" style="font-size: 48px; color: #dc3545;"></i>
                </div>
                <p style="font-size: 16px; margin-bottom: 15px;">Are you sure you want to logout?</p>
                <p style="color: #666; font-size: 14px; margin-bottom: 25px;">
                    You will be signed out of your account and redirected to the login page.
                </p>
                <div style="display: flex; gap: 15px;">
                    <button class="btn btn-secondary" onclick="closeModal('logoutConfirmationModal')"
                        style="flex: 1;">Cancel</button>
                    <button class="btn" onclick="performLogout()" style="flex: 1; background: #dc3545;">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications Page Modal -->
    <div id="notificationsPageModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh;">
            <div class="modal-header">
                <h3><i class="bi bi-bell"></i> All Notifications</h3>
                <span class="close-modal" onclick="closeModal('notificationsPageModal')">&times;</span>
            </div>
            <div style="padding: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <button class="btn btn-small" onclick="markAllNotificationsAsRead()"
                            style="margin-right: 10px;">
                            <i class="bi bi-check-all"></i> Mark All Read
                        </button>
                        <button class="btn btn-small btn-secondary" onclick="clearAllNotifications()">
                            <i class="bi bi-trash"></i> Clear All
                        </button>
                    </div>
                    <div id="notificationsCount"></div>
                </div>
                <div id="allNotificationsList" style="max-height: 60vh; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <!-- Reassign Confirmation Modal -->
    <div id="reassignConfirmationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="bi bi-exclamation-triangle"></i> Confirm Reassignment</h3>
                <span class="close-modal" onclick="closeModal('reassignConfirmationModal')">&times;</span>
            </div>
            <div style="padding: 20px;">
                <input type="hidden" id="approvalRequestId">
                <input type="hidden" id="approvalCourseId">
                <input type="hidden" id="approvalTeacherId">

                <p style="color: #dc3545; margin-bottom: 20px;">
                    <strong>Warning:</strong> This course is currently assigned to another teacher.
                </p>
                <p>Do you want to reassign <strong id="approvalCourseTitle"></strong> to the requesting teacher?</p>
                <p style="color: #666; font-size: 14px; margin-top: 10px;">
                    The current teacher will be notified and unassigned from this course.
                </p>

                <div style="display: flex; gap: 15px; margin-top: 30px;">
                    <button class="btn btn-secondary" onclick="closeModal('reassignConfirmationModal')"
                        style="flex: 1;">
                        Cancel
                    </button>
                    <button class="btn" onclick="confirmReassignment()" style="flex: 1; background: #28a745;">
                        <i class="bi bi-check-circle"></i> Yes, Reassign
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reject Reason Modal -->
    <div id="rejectReasonModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="bi bi-x-circle"></i> Reject Course Request</h3>
                <span class="close-modal" onclick="closeModal('rejectReasonModal')">&times;</span>
            </div>
            <div style="padding: 20px;">
                <input type="hidden" id="rejectRequestId">
                <input type="hidden" id="rejectCourseId">
                <input type="hidden" id="rejectTeacherId">

                <div class="form-group">
                    <label>Reason for Rejection (optional)</label>
                    <textarea id="rejectReason" rows="4"
                        placeholder="Provide a reason for rejecting this request..."></textarea>
                </div>

                <div style="display: flex; gap: 15px; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="closeModal('rejectReasonModal')" style="flex: 1;">
                        Cancel
                    </button>
                    <button class="btn" onclick="confirmRejection()" style="flex: 1; background: #dc3545;">
                        <i class="bi bi-x-circle"></i> Reject Request
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Teacher Details Modal -->
    <div id="teacherDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="bi bi-person-workspace"></i> Teacher Details</h3>
                <span class="close-modal" onclick="closeModal('teacherDetailsModal')">&times;</span>
            </div>
            <div id="teacherDetailsContent" style="padding: 20px;"></div>
        </div>
    </div>

    <!-- Approval History Modal -->
    <div id="approvalHistoryModal" class="modal">
        <div class="modal-content" style="max-width: 1000px; max-height: 80vh;">
            <div class="modal-header">
                <h3><i class="bi bi-clock-history"></i> Approval History</h3>
                <span class="close-modal" onclick="closeModal('approvalHistoryModal')">&times;</span>
            </div>
            <div style="padding: 20px;" id="approvalHistoryContent">
                <!-- History will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Student Enrollments Modal -->
    <div id="studentEnrollmentsModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 80vh;">
            <div class="modal-header">
                <h3><i class="bi bi-journals"></i> Student Course Enrollments</h3>
                <span class="close-modal" onclick="closeModal('studentEnrollmentsModal')">&times;</span>
            </div>
            <div id="studentEnrollmentsContent" style="max-height: 60vh; overflow-y: auto;">
                <!-- Student enrollments will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Suspend Teacher Modal -->
    <div id="suspendTeacherModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="bi bi-person-slash"></i> Suspend Teacher</h3>
                <span class="close-modal" onclick="closeModal('suspendTeacherModal')">&times;</span>
            </div>
            <div id="suspendTeacherContent"></div>
        </div>
    </div>

    <!-- Terminate Teacher Modal -->
    <div id="terminateTeacherModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="bi bi-person-x"></i> Terminate Teacher</h3>
                <span class="close-modal" onclick="closeModal('terminateTeacherModal')">&times;</span>
            </div>
            <div id="terminateTeacherContent"></div>
        </div>
    </div>

    <!-- Edit Teacher Modal -->
    <div id="editTeacherModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3><i class="bi bi-person-workspace"></i> Edit Teacher Information</h3>
                <span class="close-modal" onclick="closeModal('editTeacherModal')">&times;</span>
            </div>
            <div id="editTeacherContent"></div>
        </div>
    </div>

    <!-- Advanced Confirmation Modal -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="confirmationTitle"><i class="bi bi-question-circle"></i> Confirmation Required</h3>
                <span class="close-modal" onclick="closeModal('confirmationModal')">&times;</span>
            </div>
            <div style="padding: 20px;">
                <div id="confirmationIcon" style="text-align: center; margin-bottom: 20px;">
                    <i class="bi bi-exclamation-triangle" style="font-size: 48px; color: #ffc107;"></i>
                </div>
                <p id="confirmationMessage"
                    style="text-align: center; font-size: 16px; line-height: 1.6; margin-bottom: 25px;">
                    Are you sure you want to proceed?
                </p>
                <p id="confirmationDetails"
                    style="color: #666; font-size: 14px; text-align: center; margin-bottom: 30px;">
                    This action cannot be undone.
                </p>
                <div style="display: flex; gap: 15px;">
                    <button class="btn btn-secondary" onclick="cancelConfirmation()" style="flex: 1;">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                    <button class="btn" id="confirmActionBtn" onclick="executeConfirmedAction()" style="flex: 1;">
                        <i class="bi bi-check-circle"></i> Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmationModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 style="color: #dc3545;"><i class="bi bi-exclamation-triangle-fill"></i> Confirm Deletion</h3>
                <span class="close-modal" onclick="closeModal('deleteConfirmationModal')">&times;</span>
            </div>
            <div style="padding: 20px;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <i class="bi bi-trash-fill" style="font-size: 48px; color: #dc3545;"></i>
                </div>
                <p id="deleteConfirmationMessage"
                    style="text-align: center; font-size: 16px; line-height: 1.6; margin-bottom: 25px;">
                    Are you sure you want to delete this item?
                </p>
                <p style="color: #dc3545; font-size: 14px; text-align: center; margin-bottom: 30px;">
                    <i class="bi bi-info-circle"></i> This action cannot be undone. All associated data will be
                    permanently removed.
                </p>
                <div style="display: flex; gap: 15px;">
                    <button class="btn btn-secondary" onclick="closeModal('deleteConfirmationModal')" style="flex: 1;">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                    <button class="btn" id="deleteConfirmBtn" onclick="executeDeleteAction()"
                        style="flex: 1; background: #dc3545;">
                        <i class="bi bi-trash-fill"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Record Fee Payment Modal -->
    <div id="recordFeePaymentModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3><i class="bi bi-cash-stack"></i> Record Fee Payment</h3>
                <span class="close-modal" onclick="closeModal('recordFeePaymentModal')">&times;</span>
            </div>
            <form onsubmit="recordFeePayment(event)">
                <div class="form-group">
                    <label>Select Student *</label>
                    <select id="feePaymentStudent" required onchange="loadStudentFeeInfo(this.value)">
                        <option value="">Select Student</option>
                        <!-- Students will be loaded dynamically -->
                    </select>
                </div>

                <div id="studentFeeInfo" style="display: none; margin-bottom: 20px;">
                    <!-- Student info will be loaded here -->
                </div>

                <div class="form-group">
                    <label>Amount *</label>
                    <input type="number" id="feePaymentAmount" required min="1" step="0.01">
                </div>

                <div class="form-group">
                    <label>Payment Date *</label>
                    <input type="date" id="feePaymentDate" required>
                </div>

                <div class="form-group">
                    <label>Payment Method *</label>
                    <select id="feePaymentMethod" required>
                        <option value="cash">Cash</option>
                        <option value="bank_transfer">Bank Transfer</option>
                        <option value="card">Card</option>
                        <option value="check">Check</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Academic Year *</label>
                    <input type="number" id="feeAcademicYear" required min="2020" max="2030" value="2024">
                </div>

                <div class="form-group">
                    <label>Semester *</label>
                    <select id="feeSemester" required>
                        <option value="1">Semester 1</option>
                        <option value="2">Semester 2</option>
                        <option value="3">Semester 3</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Description (Optional)</label>
                    <textarea id="feeDescription" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label>Notes (Optional)</label>
                    <textarea id="feeNotes" rows="3"></textarea>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn" style="flex: 1; background: #28a745;">
                        <i class="bi bi-save"></i> Record Payment
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('recordFeePaymentModal')"
                        style="flex: 1;">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Payment Details Modal -->
    <div id="viewFeePaymentModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3><i class="bi bi-receipt"></i> Payment Details</h3>
                <span class="close-modal" onclick="closeModal('viewFeePaymentModal')">&times;</span>
            </div>
            <div id="feePaymentDetails" style="max-height: 70vh; overflow-y: auto;">
                <!-- Payment details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Approve/Reject Payment Modal -->
    <div id="feeActionModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="feeActionTitle"><i class="bi bi-check-circle"></i> Approve Payment</h3>
                <span class="close-modal" onclick="closeModal('feeActionModal')">&times;</span>
            </div>
            <div style="padding: 20px;">
                <input type="hidden" id="actionPaymentId">
                <div id="feeActionContent">
                    <!-- Action content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Manage Fee Structure Modal -->
    <div id="manageFeeStructureModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3><i class="bi bi-receipt"></i> Manage Fee Structure</h3>
                <span class="close-modal" onclick="closeModal('manageFeeStructureModal')">&times;</span>
            </div>
            <div id="feeStructureContent">
                <!-- Fee structure content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h3 style="color: #28a745;"><i class="bi bi-check-circle-fill"></i> Success</h3>
                <span class="close-modal" onclick="closeModal('successModal')">&times;</span>
            </div>
            <div style="padding: 20px; text-align: center;">
                <div style="margin-bottom: 20px;">
                    <i class="bi bi-check-circle-fill" style="font-size: 64px; color: #28a745;"></i>
                </div>
                <p id="successMessage" style="font-size: 16px; line-height: 1.6; margin-bottom: 25px;">
                    Operation completed successfully!
                </p>
                <button class="btn" onclick="closeModal('successModal')" style="background: #28a745;">
                    <i class="bi bi-check-lg"></i> Continue
                </button>
            </div>
        </div>
    </div>

    <!-- Warning Modal -->
    <div id="warningModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 style="color: #ffc107;"><i class="bi bi-exclamation-triangle-fill"></i> Warning</h3>
                <span class="close-modal" onclick="closeModal('warningModal')">&times;</span>
            </div>
            <div style="padding: 20px;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <i class="bi bi-exclamation-triangle-fill" style="font-size: 48px; color: #ffc107;"></i>
                </div>
                <p id="warningMessage"
                    style="text-align: center; font-size: 16px; line-height: 1.6; margin-bottom: 25px;">
                    Please review this warning before proceeding.
                </p>
                <p id="warningDetails" style="color: #666; font-size: 14px; text-align: center; margin-bottom: 30px;">
                    Additional details about the warning.
                </p>
                <div style="display: flex; gap: 15px;">
                    <button class="btn btn-secondary" onclick="closeModal('warningModal')" style="flex: 1;">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                    <button class="btn" id="warningConfirmBtn" onclick="executeWarningAction()"
                        style="flex: 1; background: #ffc107; color: #212529;">
                        <i class="bi bi-exclamation-triangle"></i> Proceed Anyway
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="infoModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 style="color: #17a2b8;"><i class="bi bi-info-circle-fill"></i> Information</h3>
                <span class="close-modal" onclick="closeModal('infoModal')">&times;</span>
            </div>
            <div style="padding: 20px; text-align: center;">
                <div style="margin-bottom: 20px;">
                    <i class="bi bi-info-circle-fill" style="font-size: 48px; color: #17a2b8;"></i>
                </div>
                <p id="infoMessage" style="font-size: 16px; line-height: 1.6; margin-bottom: 25px;">
                    Here's some important information you should know.
                </p>
                <button class="btn" onclick="closeModal('infoModal')" style="background: #17a2b8;">
                    <i class="bi bi-check-lg"></i> Understood
                </button>
            </div>
        </div>
    </div>

    <!-- Add Compulsory Course Modal -->
    <div id="addCompulsoryCourseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="bi bi-check-circle"></i> Add/Edit Compulsory Course</h3>
                <span class="close-modal" onclick="closeModal('addCompulsoryCourseModal')">&times;</span>
            </div>
            <form id="compulsoryCourseForm">
                <input type="hidden" id="compulsoryCourseId">
                <div class="form-group">
                    <label>Course Title *</label>
                    <input type="text" id="compulsoryCourseTitle" required>
                </div>
                <div class="form-group">
                    <label>Course Code *</label>
                    <input type="text" id="compulsoryCourseCode" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="compulsoryCourseDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Credits *</label>
                    <input type="number" id="compulsoryCourseCredits" required min="1" max="5">
                </div>
                <div class="form-group">
                    <label>Level *</label>
                    <select id="compulsoryCourseLevel" required>
                        <option value="">Select Level</option>
                        <option value="MS1">Middle School 1 (MS1)</option>
                        <option value="MS2">Middle School 2 (MS2)</option>
                        <option value="MS3">Middle School 3 (MS3)</option>
                        <option value="HS1">High School 1 (HS1)</option>
                        <option value="HS2">High School 2 (HS2)</option>
                        <option value="HS3">High School 3 (HS3)</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn" style="flex: 1; background: #28a745;">
                        <i class="bi bi-check-circle"></i> Save Compulsory Course
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addCompulsoryCourseModal')"
                        style="flex: 1;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Clear All Courses Modal -->
    <div id="clearAllCoursesModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 style="color: #dc3545;"><i class="bi bi-exclamation-triangle-fill"></i> Clear All Courses</h3>
                <span class="close-modal" onclick="closeModal('clearAllCoursesModal')">&times;</span>
            </div>
            <div style="padding: 20px;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <i class="bi bi-trash-fill" style="font-size: 48px; color: #dc3545;"></i>
                </div>
                <p style="text-align: center; font-size: 16px; line-height: 1.6; margin-bottom: 15px;">
                    Are you sure you want to clear <strong>ALL</strong> courses from the system?
                </p>
                <p style="color: #dc3545; font-size: 14px; text-align: center; margin-bottom: 20px;">
                    <i class="bi bi-info-circle"></i> This action will:
                </p>
                <ul style="color: #666; font-size: 14px; padding-left: 20px; margin-bottom: 25px;">
                    <li>Delete all course records</li>
                    <li>Remove all teacher-course assignments</li>
                    <li>Remove all student enrollments</li>
                    <li>Delete all course materials, assignments, and discussions</li>
                    <li>Preserve student and teacher accounts</li>
                </ul>
                <p style="color: #dc3545; font-size: 14px; text-align: center; margin-bottom: 25px;">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Warning:</strong> This action cannot be undone!
                </p>
                <div style="display: flex; gap: 15px;">
                    <button class="btn btn-secondary" onclick="closeModal('clearAllCoursesModal')" style="flex: 1;">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                    <button class="btn" onclick="clearAllCourses()" style="flex: 1; background: #dc3545;">
                        <i class="bi bi-trash-fill"></i> Clear All Courses
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==============================================
        // GLOBAL VARIABLES AND CONSTANTS
        // ==============================================
        const API_URL = '/api';
        let currentUser = null;

        // Modal callback variables
        let currentConfirmationCallback = null;
        let currentDeleteCallback = null;
        let currentWarningCallback = null;
        let currentConfirmationData = null;

        // ==============================================
        // LOADING ANIMATION FUNCTIONS
        // ==============================================

        /**
         * Shows loading animation on a button
         * @param {HTMLElement} button - The button element
         * @param {string} loadingText - Optional loading text
         */
        function showButtonLoading(button, loadingText = null) {
            if (!button) return;

            const originalText = button.innerHTML;
            const originalWidth = button.style.width;
            const originalMinWidth = button.style.minWidth;

            // Store original content for later restoration
            button.dataset.originalContent = originalText;
            if (originalWidth) button.dataset.originalWidth = originalWidth;
            if (originalMinWidth) button.dataset.originalMinWidth = originalMinWidth;

            // Create loading spinner HTML
            const spinnerHTML = `
        <span class="button-spinner">
            <i class="bi bi-arrow-repeat" style="animation: spin 1s linear infinite; margin-right: 8px;"></i>
            ${loadingText || 'Loading...'}
        </span>
        `;

            // Set button to loading state
            button.innerHTML = spinnerHTML;
            button.classList.add('loading');
            button.disabled = true;

            // Maintain button width
            if (!originalWidth) {
                button.style.width = button.offsetWidth + 'px';
            }
            if (!originalMinWidth) {
                button.style.minWidth = button.offsetWidth + 'px';
            }

            return originalText;
        }

        /**
         * Hides loading animation from a button
         * @param {HTMLElement} button - The button element
         */
        function hideButtonLoading(button) {
            if (!button) return;

            // Restore original content
            if (button.dataset.originalContent) {
                button.innerHTML = button.dataset.originalContent;
            }

            // Remove loading classes
            button.classList.remove('loading');
            button.disabled = false;

            // Restore original width
            if (button.dataset.originalWidth) {
                button.style.width = button.dataset.originalWidth;
            } else {
                button.style.width = '';
            }

            if (button.dataset.originalMinWidth) {
                button.style.minWidth = button.dataset.originalMinWidth;
            } else {
                button.style.minWidth = '';
            }

            // Clean up data attributes
            delete button.dataset.originalContent;
            delete button.dataset.originalWidth;
            delete button.dataset.originalMinWidth;
        }

        /**
         * Shows loading animation on a form submit button
         * @param {Event} event - The form submit event
         * @param {string} loadingText - Optional loading text
         */
        function showFormLoading(event, loadingText = null) {
            const form = event.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                showButtonLoading(submitBtn, loadingText);
            }
        }

        /**
         * Hides loading animation from a form submit button
         * @param {Event} event - The form submit event
         */
        function hideFormLoading(event) {
            const form = event.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                hideButtonLoading(submitBtn);
            }
        }

        // ==============================================
        // AUTHENTICATION FUNCTIONS - WITH LOADING
        // ==============================================

        function showRoleSelection() {
            document.getElementById('studentLoginForm').classList.add('hidden');
            document.getElementById('teacherLoginForm').classList.add('hidden');
            document.getElementById('adminLoginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('roleSelection').classList.remove('hidden');
        }

        function showStudentLogin() {
            document.getElementById('roleSelection').classList.add('hidden');
            document.getElementById('studentLoginForm').classList.remove('hidden');
        }

        function showTeacherLogin() {
            document.getElementById('roleSelection').classList.add('hidden');
            document.getElementById('teacherLoginForm').classList.remove('hidden');
        }

        function showAdminLogin() {
            document.getElementById('roleSelection').classList.add('hidden');
            document.getElementById('adminLoginForm').classList.remove('hidden');
        }

        function showRegister() {
            document.getElementById('roleSelection').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        function showLogin() {
            document.getElementById('registerForm').classList.add('hidden');
            showRoleSelection();
        }

        function toggleStudentFields() {
            const role = document.getElementById('regRole').value;
            const studentFields = document.getElementById('studentFields');

            if (role === 'student') {
                studentFields.classList.remove('hidden');
            }
        }

        function toggleDepartmentField() {
            const level = document.getElementById('regLevel').value;
            const departmentField = document.getElementById('departmentField');

            if (level.startsWith('HS')) {
                departmentField.classList.remove('hidden');
                document.getElementById('regDepartment').required = true;
            } else {
                departmentField.classList.add('hidden');
                document.getElementById('regDepartment').required = false;
                document.getElementById('regDepartment').value = '';
            }
        }

        // ==============================================
        // TOAST NOTIFICATIONS
        // ==============================================

        function showToast(message, type = 'info') {
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(toast => {
                if (toast.parentElement) {
                    toast.remove();
                }
            });

            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px; padding: 5px;">
            <span style="font-size: 18px;">
                ${type === 'success' ? '✓' : type === 'error' ? '✗' : 'ℹ'}
            </span>
            <span style="flex: 1;">${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" 
                    style="background: none; border: none; color: inherit; cursor: pointer; 
                           font-size: 20px; padding: 0; margin-left: 10px;">×</button>
        </div>
    `;

            document.body.appendChild(toast);

            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }

        function showAlert(alertId, message, type = 'error') {
            const alertDiv = document.getElementById(alertId);
            if (alertDiv) {
                alertDiv.textContent = message;
                alertDiv.className = `alert alert-${type}`;
                alertDiv.style.display = 'block';

                setTimeout(() => {
                    alertDiv.style.display = 'none';
                    alertDiv.textContent = '';
                }, 5000);
            }
        }

        // ==============================================
        // MODAL MANAGEMENT
        // ==============================================

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');

                currentConfirmationCallback = null;
                currentDeleteCallback = null;
                currentWarningCallback = null;
                currentConfirmationData = null;
            }
        }

        function closeAllModals() {
            document.querySelectorAll('.modal.active').forEach(modal => {
                modal.classList.remove('active');
            });

            document.querySelectorAll('.hidden').forEach(el => {
                if (el.id.includes('Dropdown')) {
                    el.classList.add('hidden');
                }
            });
        }

        // ==============================================
        // CONFIRMATION MODAL SYSTEM
        // ==============================================

        function showConfirmation(message, callback, options = {}) {
            const defaultOptions = {
                title: 'Confirmation Required',
                details: 'This action cannot be undone.',
                icon: 'warning',
                confirmText: 'Confirm',
                confirmColor: '#667eea',
                cancelText: 'Cancel'
            };

            const config = { ...defaultOptions, ...options };

            document.getElementById('confirmationTitle').innerHTML =
                `<i class="bi bi-${config.icon}"></i> ${config.title}`;
            document.getElementById('confirmationMessage').textContent = message;
            document.getElementById('confirmationDetails').textContent = config.details;

            const iconElement = document.getElementById('confirmationIcon');
            const icons = {
                'warning': 'exclamation-triangle',
                'danger': 'exclamation-circle-fill',
                'info': 'info-circle-fill',
                'success': 'check-circle-fill'
            };
            iconElement.innerHTML = `<i class="bi bi-${icons[config.icon] || icons.warning}" 
        style="font-size: 48px; color: ${config.icon === 'warning' ? '#ffc107' :
                    config.icon === 'danger' ? '#dc3545' :
                        config.icon === 'success' ? '#28a745' : '#17a2b8'};"></i>`;

            const confirmBtn = document.getElementById('confirmActionBtn');
            confirmBtn.innerHTML = `<i class="bi bi-check-circle"></i> ${config.confirmText}`;
            confirmBtn.style.background = config.confirmColor;

            currentConfirmationCallback = callback;
            document.getElementById('confirmationModal').classList.add('active');
        }

        function showDeleteConfirmation(message, callback, details = 'This action cannot be undone. All associated data will be permanently removed.') {
            document.getElementById('deleteConfirmationMessage').textContent = message;
            currentDeleteCallback = callback;
            document.getElementById('deleteConfirmationModal').classList.add('active');
        }

        function showSuccess(message) {
            document.getElementById('successMessage').textContent = message;
            document.getElementById('successModal').classList.add('active');
        }

        function showInfo(message) {
            document.getElementById('infoMessage').textContent = message;
            document.getElementById('infoModal').classList.add('active');
        }

        function showWarning(message, details, callback) {
            document.getElementById('warningMessage').textContent = message;
            document.getElementById('warningDetails').textContent = details;
            currentWarningCallback = callback;
            document.getElementById('warningModal').classList.add('active');
        }

        function executeConfirmedAction() {
            const confirmBtn = document.getElementById('confirmActionBtn');
            showButtonLoading(confirmBtn, 'Processing...');

            setTimeout(() => {
                if (currentConfirmationCallback) {
                    currentConfirmationCallback();
                }
                hideButtonLoading(confirmBtn);
                closeModal('confirmationModal');
            }, 500);
        }

        function executeDeleteAction() {
            const deleteBtn = document.getElementById('deleteConfirmBtn');
            showButtonLoading(deleteBtn, 'Deleting...');

            setTimeout(() => {
                if (currentDeleteCallback) {
                    currentDeleteCallback();
                }
                hideButtonLoading(deleteBtn);
                closeModal('deleteConfirmationModal');
            }, 500);
        }

        function executeWarningAction() {
            const warningBtn = document.getElementById('warningConfirmBtn');
            showButtonLoading(warningBtn, 'Processing...');

            setTimeout(() => {
                if (currentWarningCallback) {
                    currentWarningCallback();
                }
                hideButtonLoading(warningBtn);
                closeModal('warningModal');
            }, 500);
        }

        function cancelConfirmation() {
            closeModal('confirmationModal');
        }

        // ==============================================
        // LOGIN/HANDLERS WITH LOADING
        // ==============================================

        async function handleStudentLogin(e) {
            e.preventDefault();

            const email = document.getElementById('studentLoginEmail').value.trim();
            const password = document.getElementById('studentLoginPassword').value;

            const alertDiv = document.getElementById('studentLoginAlert');
            if (alertDiv) {
                alertDiv.style.display = 'none';
                alertDiv.textContent = '';
            }

            if (!email) {
                showAlert('studentLoginAlert', 'Please enter your email address', 'error');
                return;
            }

            if (!password) {
                showAlert('studentLoginAlert', 'Please enter your password', 'error');
                return;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showAlert('studentLoginAlert', 'Please enter a valid email address', 'error');
                return;
            }

            const submitBtn = e.target.querySelector('button[type="submit"]');
            showButtonLoading(submitBtn, 'Logging in...');

            try {
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, role: 'student' }),
                    credentials: 'include'
                });

                if (response.ok) {
                    currentUser = await response.json();

                    if (currentUser.role !== 'student') {
                        showAlert('studentLoginAlert', 'This is not a student account. Please use the correct login page.', 'error');
                        hideButtonLoading(submitBtn);
                        return;
                    }

                    if (currentUser.status === 'suspended') {
                        showAlert('studentLoginAlert', 'Your account has been suspended. Please contact the administrator.', 'error');
                        hideButtonLoading(submitBtn);
                        return;
                    }

                    document.getElementById('studentLoginEmail').value = '';
                    document.getElementById('studentLoginPassword').value = '';
                    showAlert('studentLoginAlert', '', 'error');
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    document.getElementById('authPage').style.display = 'none';
                    document.querySelectorAll('.dashboard').forEach(dash => {
                        dash.classList.remove('active');
                    });
                    document.getElementById('studentDashboard').classList.add('active');

                    document.getElementById('studentName').textContent =
                        `${currentUser.first_name} ${currentUser.last_name}`;

                    loadStudentData();
                    checkStudentFeeStatus();
                    showToast('Login successful! Welcome back!', 'success');
                    hideButtonLoading(submitBtn);

                } else {
                    const errorData = await response.json();
                    let errorMessage = 'Login failed';

                    if (errorData.error) {
                        errorMessage = errorData.error;
                    } else if (response.status === 401) {
                        errorMessage = 'Invalid email or password';
                    } else if (response.status === 404) {
                        errorMessage = 'Account not found';
                    } else if (response.status === 403) {
                        if (errorData.requires_fee_approval) {
                            const email = document.getElementById('studentLoginEmail').value.trim();
                            document.getElementById('studentLoginEmail').value = '';
                            document.getElementById('studentLoginPassword').value = '';
                            currentUser = {
                                email: email,
                                first_name: 'Student',
                                last_name: '',
                                role: 'student',
                                requires_fee_approval: true
                            };
                            localStorage.setItem('currentUser', JSON.stringify(currentUser));
                            document.getElementById('authPage').style.display = 'none';
                            document.querySelectorAll('.dashboard').forEach(dash => {
                                dash.classList.remove('active');
                            });
                            document.getElementById('studentDashboard').classList.add('active');
                            document.getElementById('studentName').textContent = 'Fee Payment Required';
                            loadStudentData();
                            showToast('Please complete fee payment to access full features', 'warning');
                            showSection('fee-payment');
                            hideButtonLoading(submitBtn);
                            return;
                        }
                        errorMessage = 'Access denied';
                    } else if (response.status >= 500) {
                        errorMessage = 'Server error. Please try again later.';
                    }
                    showAlert('studentLoginAlert', errorMessage, 'error');
                    hideButtonLoading(submitBtn);
                }
            } catch (error) {
                console.error('Login error:', error);
                showAlert('studentLoginAlert', 'Network error. Please check your internet connection and try again.', 'error');
                hideButtonLoading(submitBtn);
            }
        }

        async function checkStudentFeeStatus() {
            if (!currentUser || !currentUser.id) return;

            try {
                const response = await fetch(`${API_URL}/students/${currentUser.id}/fee-status`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    const feeData = await response.json();

                    // Store fee status in currentUser
                    currentUser.has_approved_fee_payment = feeData.summary.has_approved_payment;
                    currentUser.fee_payment_required = feeData.summary.requires_fee_payment;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));

                    // Show warning if fee payment is pending
                    if (currentUser.fee_payment_required && !currentUser.has_approved_fee_payment) {
                        showToast('Please complete fee payment to access full features', 'warning');
                        // Automatically show fee payment section if user tries to access courses
                        const currentSection = document.querySelector('#studentDashboard .section.active');
                        if (currentSection && currentSection.id !== 'fee-payment' && currentSection.id !== 'profile') {
                            showSection('fee-payment');
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking fee status:', error);
            }
        }

        async function handleTeacherLogin(e) {
            e.preventDefault();
            const email = document.getElementById('teacherLoginEmail').value;
            const password = document.getElementById('teacherLoginPassword').value;
            const teacherCode = document.getElementById('teacherCode').value;

            const submitBtn = e.target.querySelector('button[type="submit"]');
            showButtonLoading(submitBtn, 'Logging in...');

            try {
                const response = await fetch(`${API_URL}/teacher-login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, teacher_code: teacherCode }),
                    credentials: 'include'
                });

                if (response.ok) {
                    currentUser = await response.json();

                    if (currentUser.role !== 'teacher') {
                        showAlert('teacherLoginAlert', 'This is not a teacher account', 'error');
                        hideButtonLoading(submitBtn);
                        return;
                    }

                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    document.getElementById('authPage').style.display = 'none';
                    document.getElementById('teacherDashboard').classList.add('active');
                    document.getElementById('teacherName').textContent =
                        `${currentUser.first_name} ${currentUser.last_name}`;
                    loadTeacherData();
                    showToast('Login successful!', 'success');
                    hideButtonLoading(submitBtn);
                } else {
                    const errorData = await response.json();
                    showAlert('teacherLoginAlert', errorData.error || 'Invalid teacher credentials or code', 'error');
                    hideButtonLoading(submitBtn);
                }
            } catch (error) {
                showAlert('teacherLoginAlert', 'Login failed', 'error');
                hideButtonLoading(submitBtn);
            }
        }

        async function handleAdminLogin(e) {
            e.preventDefault();
            const email = document.getElementById('adminLoginEmail').value;
            const password = document.getElementById('adminLoginPassword').value;

            const submitBtn = e.target.querySelector('button[type="submit"]');
            showButtonLoading(submitBtn, 'Logging in...');

            try {
                const response = await fetch(`${API_URL}/admin-login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password }),
                    credentials: 'include'
                });

                if (response.ok) {
                    currentUser = await response.json();

                    if (currentUser.role !== 'admin') {
                        showAlert('adminLoginAlert', 'This is not an admin account', 'error');
                        hideButtonLoading(submitBtn);
                        return;
                    }

                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    document.getElementById('authPage').style.display = 'none';
                    document.getElementById('adminDashboard').classList.add('active');
                    loadAdminData();
                    showToast('Admin login successful!', 'success');
                    hideButtonLoading(submitBtn);
                } else {
                    const error = await response.json();
                    showAlert('adminLoginAlert', error.error || 'Invalid admin credentials', 'error');
                    hideButtonLoading(submitBtn);
                }
            } catch (error) {
                showAlert('adminLoginAlert', 'Login failed', 'error');
                hideButtonLoading(submitBtn);
            }
        }

        function validateRegistration(data) {
            const errors = [];

            if (data.role === 'student') {
                if (!data.first_name) errors.push('First name is required');
                if (!data.last_name) errors.push('Last name is required');
                if (!data.email) errors.push('Email is required');
                if (!data.password) errors.push('Password is required');
                if (!data.level) errors.push('Level is required');

                if (data.level && data.level.startsWith('HS')) {
                    if (!data.department) {
                        errors.push('Department is required for high school students');
                    }
                }
            }

            return errors.length > 0 ? errors.join(', ') : null;
        }

        async function handleRegister(e) {
            e.preventDefault();

            const data = {
                first_name: document.getElementById('regFirstName').value.trim(),
                last_name: document.getElementById('regLastName').value.trim(),
                email: document.getElementById('regEmail').value.trim(),
                password: document.getElementById('regPassword').value,
                role: document.getElementById('regRole').value
            };

            if (data.role === 'student') {
                data.phone = document.getElementById('regPhone').value;
                data.address = document.getElementById('regAddress').value;
                data.date_of_birth = document.getElementById('regDOB').value;
                data.gender = document.getElementById('regGender').value;
                data.department = document.getElementById('regDepartment').value;
                data.level = document.getElementById('regLevel').value;
            }

            const validationError = validateRegistration(data);
            if (validationError) {
                showAlert('registerAlert', validationError, 'error');
                return;
            }

            const submitBtn = e.target.querySelector('button[type="submit"]');
            showButtonLoading(submitBtn, 'Registering...');

            try {
                const response = await fetch(`${API_URL}/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const result = await response.json();
                    document.getElementById('regFirstName').value = '';
                    document.getElementById('regLastName').value = '';
                    document.getElementById('regEmail').value = '';
                    document.getElementById('regPassword').value = '';
                    document.getElementById('regPhone').value = '';
                    document.getElementById('regAddress').value = '';
                    document.getElementById('regDOB').value = '';
                    document.getElementById('regGender').value = '';
                    document.getElementById('regDepartment').value = '';
                    document.getElementById('regLevel').value = '';
                    showRegistrationSuccess(result, data);
                    hideButtonLoading(submitBtn);

                } else {
                    const error = await response.json();
                    showAlert('registerAlert', error.error || 'Registration failed', 'error');
                    hideButtonLoading(submitBtn);
                }
            } catch (error) {
                showAlert('registerAlert', 'Registration failed. Please try again.', 'error');
                hideButtonLoading(submitBtn);
            }
        }

        function showRegistrationSuccess(result, formData) {
            const messageDiv = document.getElementById('registrationMessage');
            const studentIdDiv = document.getElementById('studentIdDisplay');
            const studentIdSpan = document.getElementById('generatedStudentId');
            const successModal = document.getElementById('registrationSuccessModal');

            if (formData.role === 'student') {
                if (result.student_id) {
                    messageDiv.textContent = `🎉 Congratulations ${formData.first_name} ${formData.last_name}! Your student account has been created successfully.`;
                    studentIdSpan.textContent = result.student_id;
                    studentIdDiv.style.display = 'block';

                    const extraInfo = document.createElement('div');
                    extraInfo.style.marginTop = '15px';
                    extraInfo.style.padding = '10px';
                    extraInfo.style.background = '#f8f9fa';
                    extraInfo.style.borderRadius = '5px';
                    extraInfo.innerHTML = `
                <p style="color: #666; font-size: 14px; margin: 5px 0;">
                    <strong>Important:</strong> Please save your Student ID for login.
                </p>
                <p style="color: #666; font-size: 14px; margin: 5px 0;">
                    <strong>Login Details:</strong>
                </p>
                <ul style="color: #666; font-size: 13px; margin: 5px 0 0 15px;">
                    <li>Email: ${formData.email}</li>
                    <li>Student ID: ${result.student_id}</li>
                    <li>Department: ${formData.department}</li>
                    <li>Level: ${formData.level}</li>
                </ul>
            `;
                    studentIdDiv.appendChild(extraInfo);
                }
            } else {
                messageDiv.textContent = 'Registration successful!';
                studentIdDiv.style.display = 'none';
            }

            successModal.classList.add('active');
        }

        // ==============================================
        // LOGOUT FUNCTION WITH LOADING
        // ==============================================

        async function logout() {
            showConfirmation(
                'Are you sure you want to logout?',
                async () => {
                    const logoutBtn = document.querySelector('#logoutConfirmationModal .btn[onclick="performLogout()"]');
                    if (logoutBtn) showButtonLoading(logoutBtn, 'Logging out...');

                    try {
                        await fetch(`${API_URL}/logout`, {
                            method: 'POST',
                            credentials: 'include'
                        });
                    } catch (error) {
                        // Silent fail
                    }

                    currentUser = null;
                    localStorage.clear();
                    document.querySelectorAll('.dashboard.active').forEach(d => d.classList.remove('active'));
                    document.getElementById('authPage').style.display = 'flex';
                    showRoleSelection();
                    closeAllModals();
                    showToast('Logged out successfully!', 'success');

                    if (logoutBtn) hideButtonLoading(logoutBtn);
                },
                {
                    title: 'Logout Confirmation',
                    details: 'You will be signed out of your account.',
                    icon: 'info',
                    confirmText: 'Logout',
                    confirmColor: '#dc3545'
                }
            );
        }

        function performLogout() {
            closeAllModals();
            logout();
        }

        // ==============================================
        // NAVIGATION FUNCTIONS
        // ==============================================

        function showSection(sectionId) {
            document.querySelectorAll('#studentDashboard .section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('#studentDashboard .menu-item').forEach(item => {
                item.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        function showTeacherSection(sectionId) {
            document.querySelectorAll('#teacherDashboard .section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('#teacherDashboard .menu-item').forEach(item => {
                item.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        function showAdminSection(sectionId) {
            document.querySelectorAll('#adminDashboard .section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('#adminDashboard .menu-item').forEach(item => {
                item.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // ==============================================
        // NOTIFICATION SYSTEM
        // ==============================================

        function updateNotificationBadge(count, role = 'student') {
            let badge;
            if (role === 'student') {
                badge = document.getElementById('notificationBadge');
            } else if (role === 'teacher') {
                badge = document.getElementById('teacherNotificationBadge');
            } else if (role === 'admin') {
                badge = document.getElementById('adminNotificationBadge');
            } else {
                badge = document.getElementById(`${role}Badge`);
            }

            if (!badge) {
                console.warn(`Badge not found for role: ${role}`);
                return;
            }

            if (count > 0) {
                badge.textContent = count > 99 ? '99+' : count;
                badge.classList.remove('hidden');
            } else {
                badge.textContent = '0';
                badge.classList.add('hidden');
            }
        }

        async function loadStudentNotifications() {
            if (!currentUser) return;

            try {
                const response = await fetch(`${API_URL}/notifications/${currentUser.id}`, {
                    credentials: 'include'
                });
                const notifications = await response.json();

                const unreadCount = notifications.filter(n => !n.is_read).length;
                updateNotificationBadge(unreadCount, 'student');

                const notificationsList = document.getElementById('notificationsList');
                if (notifications.length === 0) {
                    notificationsList.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No notifications</p>';
                    return;
                }

                const recentNotifications = notifications.slice(0, 5);
                notificationsList.innerHTML = recentNotifications.map(notif => `
            <div class="notification-item ${notif.is_read ? 'read' : 'unread'}" 
                 style="padding: 12px; margin-bottom: 8px; border-radius: 8px; 
                        background: ${notif.is_read ? '#f8f9fa' : '#e3f2fd'}; 
                        border-left: 3px solid ${notif.is_read ? '#ddd' : '#667eea'}; 
                        cursor: pointer;"
                 onclick="viewNotification('${notif.id}', '${notif.type}', '${notif.reference_id || ''}')">
              <div style="display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;">
                  <strong style="color: #333; display: block; margin-bottom: 4px;">${notif.title}</strong>
                  <p style="color: #666; font-size: 13px; margin: 0;">${notif.message}</p>
                  <span style="color: #999; font-size: 11px;">${new Date(notif.created_at).toLocaleString()}</span>
                </div>
                ${!notif.is_read ? '<div style="width: 8px; height: 8px; background: #667eea; border-radius: 50%; margin-left: 10px;"></div>' : ''}
              </div>
            </div>
        `).join('');
            } catch (error) {
                console.error('Error loading student notifications:', error);
            }
        }

        async function loadTeacherNotifications() {
            if (!currentUser) return;

            try {
                const response = await fetch(`${API_URL}/notifications/${currentUser.id}`, {
                    credentials: 'include'
                });
                const notifications = await response.json();

                const unreadCount = notifications.filter(n => !n.is_read).length;
                updateNotificationBadge(unreadCount, 'teacher');

                const notificationsList = document.getElementById('teacherNotificationsList');
                if (notifications.length === 0) {
                    notificationsList.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No notifications</p>';
                    return;
                }

                const recentNotifications = notifications.slice(0, 5);
                notificationsList.innerHTML = recentNotifications.map(notif => `
            <div class="notification-item ${notif.is_read ? 'read' : 'unread'}" 
                 style="padding: 12px; margin-bottom: 8px; border-radius: 8px; 
                        background: ${notif.is_read ? '#f8f9fa' : '#e3f2fd'}; 
                        border-left: 3px solid ${notif.is_read ? '#ddd' : '#667eea'}; 
                        cursor: pointer;"
                 onclick="viewNotification('${notif.id}', '${notif.type}', '${notif.reference_id || ''}')">
              <div style="display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;">
                  <strong style="color: #333; display: block; margin-bottom: 4px;">${notif.title}</strong>
                  <p style="color: #666; font-size: 13px; margin: 0;">${notif.message}</p>
                  <span style="color: #999; font-size: 11px;">${new Date(notif.created_at).toLocaleString()}</span>
                </div>
                ${!notif.is_read ? '<div style="width: 8px; height: 8px; background: #667eea; border-radius: 50%; margin-left: 10px;"></div>' : ''}
              </div>
            </div>
        `).join('');
            } catch (error) {
                console.error('Error loading teacher notifications:', error);
            }
        }

        async function loadAdminNotifications() {
            if (!currentUser || !currentUser.id) return;

            try {
                const response = await fetch(`${API_URL}/notifications/${currentUser.id}`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to load notifications');
                }

                const notifications = await response.json();

                if (!Array.isArray(notifications)) {
                    console.error('Notifications is not an array:', notifications);
                    return;
                }

                const unreadCount = notifications.filter(n => !n.is_read).length;
                updateNotificationBadge(unreadCount, 'admin');

                const notificationsList = document.getElementById('adminNotificationsList');
                if (notifications.length === 0) {
                    notificationsList.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No notifications</p>';
                    return;
                }

                const recentNotifications = notifications.slice(0, 5);
                notificationsList.innerHTML = recentNotifications.map(notif => `
            <div class="notification-item ${notif.is_read ? 'read' : 'unread'}" 
                 style="padding: 12px; margin-bottom: 8px; border-radius: 8px; 
                        background: ${notif.is_read ? '#f8f9fa' : '#e3f2fd'}; 
                        border-left: 3px solid ${notif.is_read ? '#ddd' : '#667eea'}; 
                        cursor: pointer;"
                 onclick="viewNotification('${notif.id}', '${notif.type}', '${notif.reference_id || ''}')">
              <div style="display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;">
                  <strong style="color: #333; display: block; margin-bottom: 4px;">${notif.title}</strong>
                  <p style="color: #666; font-size: 13px; margin: 0;">${notif.message}</p>
                  <span style="color: #999; font-size: 11px;">${new Date(notif.created_at).toLocaleString()}</span>
                </div>
                ${!notif.is_read ? '<div style="width: 8px; height: 8px; background: #667eea; border-radius: 50%; margin-left: 10px;"></div>' : ''}
              </div>
            </div>
        `).join('');
            } catch (error) {
                console.error('Error loading admin notifications:', error);
            }
        }

        async function markAllAsRead() {
            const button = event.target;
            showButtonLoading(button, 'Processing...');

            try {
                const response = await fetch(`${API_URL}/notifications/${currentUser.id}/read-all`, {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    updateNotificationBadge(0, 'student');
                    loadStudentNotifications();
                    showToast('All notifications marked as read', 'success');
                } else {
                    showToast('Failed to mark all notifications as read', 'error');
                }
            } catch (error) {
                console.error('Error marking all notifications as read:', error);
                showToast('Network error', 'error');
            } finally {
                hideButtonLoading(button);
            }
        }

        async function markAllTeacherNotificationsAsRead() {
            const button = event.target;
            showButtonLoading(button, 'Processing...');

            try {
                const response = await fetch(`${API_URL}/notifications/${currentUser.id}/read-all`, {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    updateNotificationBadge(0, 'teacher');
                    loadTeacherNotifications();
                    showToast('All notifications marked as read', 'success');
                } else {
                    showToast('Failed to mark all as read', 'error');
                }
            } catch (error) {
                console.error('Error marking all as read:', error);
                showToast('Network error', 'error');
            } finally {
                hideButtonLoading(button);
            }
        }

        async function markAllAdminNotificationsAsRead() {
            const button = event.target;
            showButtonLoading(button, 'Processing...');

            try {
                const response = await fetch(`${API_URL}/notifications/${currentUser.id}/read-all`, {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    updateNotificationBadge(0, 'admin');
                    loadAdminNotifications();
                    showToast('All notifications marked as read', 'success');
                } else {
                    showToast('Failed to mark all as read', 'error');
                }
            } catch (error) {
                console.error('Error marking all as read:', error);
                showToast('Network error', 'error');
            } finally {
                hideButtonLoading(button);
            }
        }

        function toggleNotifications() {
            const dropdown = document.getElementById('notificationDropdown');
            if (dropdown.classList.contains('hidden')) {
                loadStudentNotifications();
                dropdown.classList.remove('hidden');
            } else {
                dropdown.classList.add('hidden');
            }
        }

        function toggleTeacherNotifications() {
            const dropdown = document.getElementById('teacherNotificationDropdown');
            if (dropdown.classList.contains('hidden')) {
                loadTeacherNotifications();
                dropdown.classList.remove('hidden');
            } else {
                dropdown.classList.add('hidden');
            }
        }

        function toggleAdminNotifications() {
            const dropdown = document.getElementById('adminNotificationDropdown');
            if (dropdown.classList.contains('hidden')) {
                loadAdminNotifications();
                dropdown.classList.remove('hidden');
            } else {
                dropdown.classList.add('hidden');
            }
        }

        // ==============================================
        // STUDENT DASHBOARD FUNCTIONS WITH LOADING
        // ==============================================

        async function loadStudentData() {
            await loadEnrolledCourses();
            await loadAvailableCourses();
            await loadRecentAnnouncements();
            await loadStudentAssignments();
            await populateCourseSelects();
            await loadStudentNotifications();
            await loadStudentProfile();
            await loadSubjectCombination();
            await loadStudentFeeStatus();

            setInterval(loadStudentNotifications, 30000);
        }

        async function loadSubjectCombination() {
            try {
                if (!currentUser || !currentUser.id) return;

                const response = await fetch(`${API_URL}/students/${currentUser.id}/subject-combination`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to load subject combination');
                }

                const data = await response.json();

                let container = document.getElementById('subjectCombinationContainer');
                if (!container) {
                    const overviewSection = document.getElementById('overview');
                    container = document.createElement('div');
                    container.id = 'subjectCombinationContainer';
                    overviewSection.insertBefore(container, overviewSection.firstChild);
                }

                container.innerHTML = '';

                if (data.subject_combination) {
                    const html = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                            color: white; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3 style="margin: 0 0 15px 0;">
                        <i class="bi bi-journals"></i> My Subject Combination
                    </h3>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <p style="margin: 0; opacity: 0.9;">
                                ${data.student_info.level} • ${data.student_info.department || 'No Department'}
                            </p>
                            <p style="margin: 5px 0 0 0; font-size: 14px;">
                                Total Credits: ${data.subject_combination.total_credits}
                            </p>
                        </div>
                        <div class="badge" style="background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px;">
                            ${data.enrolled_courses.length} subjects
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                    <!-- Compulsory Subjects -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0;">
                        <h4 style="color: #28a745; margin-bottom: 15px;">
                            <i class="bi bi-check-circle"></i> Compulsory Subjects (${data.subject_combination.compulsory.length})
                        </h4>
                        ${data.subject_combination.compulsory.length > 0 ? data.subject_combination.compulsory.map(course => `
                            <div style="padding: 10px; border-bottom: 1px solid #e0e0e0;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>${course.title}</strong>
                                        <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                            Code: ${course.course_code} • Credits: ${course.credits}
                                        </div>
                                    </div>
                                    <span class="badge" style="background: #28a745;">
                                        Compulsory
                                    </span>
                                </div>
                            </div>
                        `).join('') : '<p style="color: #666; text-align: center;">No compulsory subjects</p>'}
                    </div>
                    
                    <!-- Departmental Subjects -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0;">
                        <h4 style="color: #2196F3; margin-bottom: 15px;">
                            <i class="bi bi-building"></i> Departmental Subjects (${data.subject_combination.departmental.length})
                        </h4>
                        ${data.subject_combination.departmental.length > 0 ? data.subject_combination.departmental.map(course => `
                            <div style="padding: 10px; border-bottom: 1px solid #e0e0e0;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>${course.title}</strong>
                                        <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                            Code: ${course.course_code} • Credits: ${course.credits}
                                        </div>
                                    </div>
                                    <span class="badge" style="background: #2196F3;">
                                        ${course.department}
                                    </span>
                                </div>
                            </div>
                        `).join('') : '<p style="color: #666; text-align: center;">No departmental subjects</p>'}
                    </div>
                </div>
                
                <!-- Currently Enrolled -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #667eea; margin: 20px 0;">
                    <h4 style="color: #667eea; margin-bottom: 15px;">
                        <i class="bi bi-check-square"></i> Currently Enrolled (${data.enrolled_courses.length})
                    </h4>
                    ${data.enrolled_courses.length > 0 ? `
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                            ${data.enrolled_courses.map(course => {
                        const isCompulsory = data.subject_combination.compulsory.some(c => c.id === course.id);
                        return `
                                    <div style="background: white; padding: 12px; border-radius: 6px; border-left: 4px solid ${isCompulsory ? '#28a745' : '#667eea'}">
                                        <strong style="display: block; margin-bottom: 5px;">${course.title}</strong>
                                        <div style="font-size: 11px; color: #666;">
                                            ${course.course_code} • ${course.credits} credits
                                            ${isCompulsory ? '<br><span style="color: #28a745;">(Compulsory)</span>' : ''}
                                        </div>
                                    </div>
                                `;
                    }).join('')}
                        </div>
                    ` : '<p style="color: #666; text-align: center;">Not enrolled in any courses yet</p>'}
                </div>
                
                <!-- Enrollment Status -->
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e0e0e0;">
                    <h4 style="color: #667eea; margin-bottom: 10px;">
                        <i class="bi bi-info-circle"></i> Enrollment Status
                    </h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <strong>Compulsory Subjects:</strong>
                            <p style="color: #666; margin: 5px 0;">
                                ${data.subject_combination.compulsory.filter(c => data.enrolled_courses.some(ec => ec.id === c.id)).length} 
                                of ${data.subject_combination.compulsory.length} enrolled
                            </p>
                        </div>
                        <div>
                            <strong>Departmental Subjects:</strong>
                            <p style="color: #666; margin: 5px 0;">
                                ${data.subject_combination.departmental.filter(c => data.enrolled_courses.some(ec => ec.id === c.id)).length} 
                                of ${data.subject_combination.departmental.length} enrolled
                            </p>
                        </div>
                    </div>
                </div>
            `;

                    container.innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading subject combination:', error);
                const container = document.getElementById('subjectCombinationContainer') || document.getElementById('overview');
                if (container) {
                    container.innerHTML = `
                <div style="color: #dc3545; text-align: center; padding: 20px; background: #f8d7da; border-radius: 8px; margin: 20px 0;">
                    <i class="bi bi-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px;"></i>
                    <p>Failed to load subject combination. Please try again.</p>
                </div>
            `;
                }
            }
        }

        async function loadEnrolledCourses() {
            if (!currentUser || !currentUser.id) return;

            try {
                // Check fee payment status first
                if (currentUser.fee_payment_required && !currentUser.has_approved_fee_payment) {
                    document.getElementById('enrolledCoursesList').innerHTML = `
                <div style="text-align: center; padding: 40px; color: #dc3545;">
                    <i class="bi bi-credit-card" style="font-size: 48px; margin-bottom: 15px;"></i>
                    <h4>Fee Payment Required</h4>
                    <p>Please complete fee payment and get admin approval to access courses.</p>
                    <button class="btn" onclick="showSection('fee-payment')" style="margin-top: 15px;">
                        <i class="bi bi-credit-card"></i> Go to Fee Payment
                    </button>
                </div>
            `;
                    return;
                }

                const response = await fetch(`${API_URL}/students/${currentUser.id}/courses`, {
                    credentials: 'include'
                });

                if (response.status === 403) {
                    const error = await response.json();
                    if (error.requires_fee_approval) {
                        document.getElementById('enrolledCoursesList').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc3545;">
                        <i class="bi bi-credit-card" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <h4>Fee Payment Required</h4>
                        <p>${error.message || 'Please complete fee payment to access courses.'}</p>
                        <button class="btn" onclick="showSection('fee-payment')" style="margin-top: 15px;">
                            <i class="bi bi-credit-card"></i> Go to Fee Payment
                        </button>
                    </div>
                `;
                        return;
                    }
                }

                const courses = await response.json();

                const html = courses.length > 0 ? courses.map(course => {
                    const teacherNames = course.teacher_names || 'Not assigned yet';
                    return `
                <div class="card">
                    <h3>${course.title}</h3>
                    <p>${course.description}</p>
                    <div class="card-meta">
                        <span class="course-code">${course.course_code}</span>
                        <span>Credits: ${course.credits}</span>
                        <span>Teacher: ${teacherNames}</span>
                    </div>
                </div>
            `;
                }).join('') : '<p>You are not enrolled in any courses yet.</p>';

                document.getElementById('enrolledCoursesList').innerHTML = html;
            } catch (error) {
                console.error('Error loading enrolled courses:', error);
                showToast('Failed to load courses', 'error');
            }
        }

        async function loadAvailableCourses() {
            if (!currentUser) return;

            try {
                const response = await fetch(`${API_URL}/courses`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to load courses');
                }

                const allCourses = await response.json();

                const enrolledResponse = await fetch(`${API_URL}/students/${currentUser.id}/courses`, {
                    credentials: 'include'
                });

                let enrolledCourses = [];
                if (enrolledResponse.ok) {
                    enrolledCourses = await enrolledResponse.json();
                }

                const enrolledIds = enrolledCourses.map(c => c.id);
                const availableCourses = allCourses.filter(c => !enrolledIds.includes(c.id));

                const html = availableCourses.length > 0 ? availableCourses.map(course => `
            <div class="course-item">
                <div class="course-info">
                    <h3>${course.title}</h3>
                    <p>${course.description}</p>
                    <span class="course-code">${course.course_code}</span>
                    <span style="margin-left: 10px;">Credits: ${course.credits}</span>
                    <div style="margin-top: 5px; color: #666; font-size: 13px;">
                        Teacher: ${course.teacher_names || 'Not assigned yet'}
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <span class="badge" style="background: ${getDepartmentColor(course.department)}; font-size: 11px;">
                            ${course.department}
                        </span>
                        <span class="badge" style="background: #6c757d; font-size: 11px;">
                            Level: ${course.level}
                        </span>
                    </div>
                </div>
                <button class="btn btn-small" onclick="enrollInCourse('${course.id}')">Enroll</button>
            </div>
        `).join('') : '<p>No courses available for enrollment.</p>';

                document.getElementById('availableCoursesList').innerHTML = html;
            } catch (error) {
                console.error('Error loading available courses:', error);
                document.getElementById('availableCoursesList').innerHTML = '<p>Failed to load courses. Please try again.</p>';
            }
        }

        // ==============================================
        // FEE TAB FUNCTIONALITY
        // ==============================================

        function showFeeTab(tabName) {
            // Update active tab buttons
            const tabs = document.querySelectorAll('#admin-fee-management .btn-tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
                if (tab.textContent.toLowerCase().includes(tabName)) {
                    tab.classList.add('active');
                }
            });

            // Show/Hide sections
            document.getElementById('feePaymentsList').style.display = tabName === 'all' ? 'block' : 'none';
            document.getElementById('studentsFeeStatus').style.display = tabName === 'students' ? 'block' : 'none';

            // Load data for the selected tab
            if (tabName === 'pending') {
                loadPendingFeePayments();
            } else if (tabName === 'approved') {
                loadApprovedFeePayments();
            } else if (tabName === 'all') {
                loadAllFeePayments();
            } else if (tabName === 'students') {
                loadStudentsFeeStatus();
            }
        }

        // ==============================================
        // FEE PAYMENT FUNCTIONS
        // ==============================================

        async function loadPendingFeePayments() {
            try {
                const response = await fetch(`${API_URL}/admin/fee-payments/pending`, {
                    credentials: 'include'
                });
                const payments = await response.json();
                displayFeePayments(payments);
            } catch (error) {
                console.error('Error loading pending payments:', error);
                document.getElementById('feePaymentsList').innerHTML = `
            <div class="alert alert-error">
                Failed to load pending payments. Please try again.
            </div>
        `;
            }
        }

        async function loadApprovedFeePayments() {
            try {
                const response = await fetch(`${API_URL}/admin/fee-payments/approved`, {
                    credentials: 'include'
                });
                const payments = await response.json();
                displayFeePayments(payments);
            } catch (error) {
                console.error('Error loading approved payments:', error);
                document.getElementById('feePaymentsList').innerHTML = `
            <div class="alert alert-error">
                Failed to load approved payments. Please try again.
            </div>
        `;
            }
        }

        async function loadAllFeePayments() {
            try {
                const response = await fetch(`${API_URL}/admin/fee-payments`, {
                    credentials: 'include'
                });
                const payments = await response.json();
                displayFeePayments(payments);
            } catch (error) {
                console.error('Error loading all payments:', error);
                document.getElementById('feePaymentsList').innerHTML = `
            <div class="alert alert-error">
                Failed to load payments. Please try again.
            </div>
        `;
            }
        }

        async function loadStudentsFeeStatus() {
            try {
                const response = await fetch(`${API_URL}/admin/students-fee-status`, {
                    credentials: 'include'
                });
                const students = await response.json();

                const html = students.length > 0 ? students.map(student => `
            <div class="list-item">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <h4>${student.first_name} ${student.last_name}</h4>
                        <p>${student.email}</p>
                        <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                            <span class="badge" style="background: #667eea;">${student.student_id}</span>
                            <span class="badge" style="background: #6c757d;">${student.level}</span>
                            <span class="badge" style="background: #17a2b8;">${student.department}</span>
                            <span class="badge" style="background: ${student.fee_status === 'approved' ? '#28a745' :
                        student.fee_status === 'pending' ? '#ffc107' : '#dc3545'}">
                                ${student.fee_status}
                            </span>
                        </div>
                        ${student.last_payment_date ? `
                            <p style="margin-top: 10px; color: #666;">
                                Last Payment: ${new Date(student.last_payment_date).toLocaleDateString()} - 
                                $${student.last_payment_amount?.toFixed(2) || '0.00'}
                            </p>
                        ` : ''}
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <button class="btn btn-small" onclick="toggleStudentFeeRequirement('${student.id}', '${student.first_name} ${student.last_name}')">
                            ${student.fee_required ? 'Disable Fee' : 'Enable Fee'}
                        </button>
                        <button class="btn btn-small" onclick="recordFeePaymentForStudent('${student.id}', '${student.first_name} ${student.last_name}')">
                            Record Payment
                        </button>
                    </div>
                </div>
            </div>
        `).join('') : '<p>No students found.</p>';

                document.getElementById('studentsFeeStatus').innerHTML = html;
            } catch (error) {
                console.error('Error loading students fee status:', error);
                document.getElementById('studentsFeeStatus').innerHTML = `
            <div class="alert alert-error">
                Failed to load students fee status. Please try again.
            </div>
        `;
            }
        }

        async function loadStudentFeeInfo(studentId) {
            try {
                const response = await fetch(`${API_URL}/students/${studentId}/fee-status`, {
                    credentials: 'include'
                });
                const data = await response.json();

                const html = `
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h4 style="margin: 0 0 10px 0;">${data.student_info.first_name} ${data.student_info.last_name}</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                    <div><strong>Student ID:</strong></div>
                    <div>${data.student_info.student_id}</div>
                    <div><strong>Level:</strong></div>
                    <div>${data.student_info.level}</div>
                    <div><strong>Department:</strong></div>
                    <div>${data.student_info.department}</div>
                    <div><strong>Fee Status:</strong></div>
                    <div>
                        <span class="badge" style="background: ${data.summary.has_approved_payment ? '#28a745' :
                        data.summary.pending_count > 0 ? '#ffc107' : '#dc3545'}">
                            ${data.summary.has_approved_payment ? 'Approved' :
                        data.summary.pending_count > 0 ? 'Pending' : 'Not Paid'}
                        </span>
                    </div>
                </div>
                ${data.summary.total_paid > 0 ? `
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
                        <p style="margin: 5px 0;"><strong>Total Paid:</strong> $${data.summary.total_paid.toFixed(2)}</p>
                        <p style="margin: 5px 0;"><strong>Approved Payments:</strong> ${data.summary.approved_count}</p>
                        <p style="margin: 5px 0;"><strong>Pending Payments:</strong> ${data.summary.pending_count}</p>
                    </div>
                ` : ''}
            </div>
        `;

                document.getElementById('studentFeeInfo').innerHTML = html;
                document.getElementById('studentFeeInfo').style.display = 'block';
            } catch (error) {
                console.error('Error loading student fee info:', error);
                document.getElementById('studentFeeInfo').innerHTML = `
            <div class="alert alert-error">
                Failed to load student information
            </div>
        `;
            }
        }

        // ==============================================
        // APPROVAL FUNCTIONS
        // ==============================================

        async function loadApprovals() {
            try {
                const response = await fetch(`${API_URL}/admin/approvals`, {
                    credentials: 'include'
                });
                const approvals = await response.json();

                const html = approvals.length > 0 ? approvals.map(approval => `
            <div class="list-item">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <h4>${approval.course_title}</h4>
                        <p><strong>Requested by:</strong> ${approval.teacher_name}</p>
                        <p><strong>Teacher Code:</strong> ${approval.teacher_code}</p>
                        <p><strong>Requested at:</strong> ${new Date(approval.requested_at).toLocaleString()}</p>
                        ${approval.current_teacher ?
                        `<p style="color: #dc3545;"><strong>Currently assigned to:</strong> ${approval.current_teacher}</p>` :
                        ''
                    }
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <button class="btn btn-small" style="background: #28a745;" 
                                onclick="approveRequest('${approval.id}', '${approval.course_id}', '${approval.teacher_id}', '${approval.course_title}')">
                            <i class="bi bi-check"></i> Approve
                        </button>
                        <button class="btn btn-small btn-secondary" style="background: #dc3545;"
                                onclick="rejectRequest('${approval.id}', '${approval.course_id}', '${approval.teacher_id}', '${approval.course_title}')">
                            <i class="bi bi-x"></i> Reject
                        </button>
                    </div>
                </div>
            </div>
        `).join('') : '<p>No pending approval requests.</p>';

                document.getElementById('approvalsList').innerHTML = html;

                // Update badge count
                const badge = document.getElementById('approvalBadge');
                if (approvals.length > 0) {
                    badge.textContent = approvals.length;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error loading approvals:', error);
                document.getElementById('approvalsList').innerHTML = `
            <div class="alert alert-error">
                Failed to load approval requests. Please try again.
            </div>
        `;
            }
        }

        async function approveRequest(requestId, courseId, teacherId, courseTitle) {
            const button = event.target.closest('button');
            showButtonLoading(button, 'Checking...');

            try {
                // Check if course is already assigned to another teacher
                const checkResponse = await fetch(`${API_URL}/courses/${courseId}/teacher`, {
                    credentials: 'include'
                });

                if (checkResponse.ok) {
                    const currentTeacher = await checkResponse.json();
                    if (currentTeacher && currentTeacher.id !== teacherId) {
                        // Show reassignment confirmation modal
                        document.getElementById('approvalRequestId').value = requestId;
                        document.getElementById('approvalCourseId').value = courseId;
                        document.getElementById('approvalTeacherId').value = teacherId;
                        document.getElementById('approvalCourseTitle').textContent = courseTitle;
                        document.getElementById('reassignConfirmationModal').classList.add('active');
                        hideButtonLoading(button);
                        return;
                    }
                }

                // If no current teacher or same teacher, approve directly
                await confirmApproval(requestId, courseId, teacherId);
            } catch (error) {
                console.error('Error checking course assignment:', error);
                // Proceed with approval anyway
                await confirmApproval(requestId, courseId, teacherId);
            } finally {
                hideButtonLoading(button);
            }
        }

        async function confirmReassignment() {
            const button = event.target.closest('button');
            showButtonLoading(button, 'Reassigning...');

            const requestId = document.getElementById('approvalRequestId').value;
            const courseId = document.getElementById('approvalCourseId').value;
            const teacherId = document.getElementById('approvalTeacherId').value;

            try {
                const response = await fetch(`${API_URL}/admin/approvals/${requestId}/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        course_id: courseId,
                        teacher_id: teacherId,
                        reassign: true
                    }),
                    credentials: 'include'
                });

                if (response.ok) {
                    showToast('Course reassigned and approved successfully!', 'success');
                    closeModal('reassignConfirmationModal');
                    loadApprovals();
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to approve request', 'error');
                }
            } catch (error) {
                console.error('Error approving request:', error);
                showToast('Failed to approve request', 'error');
            } finally {
                hideButtonLoading(button);
            }
        }

        async function confirmApproval(requestId, courseId, teacherId) {
            try {
                const response = await fetch(`${API_URL}/admin/approvals/${requestId}/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        course_id: courseId,
                        teacher_id: teacherId
                    }),
                    credentials: 'include'
                });

                if (response.ok) {
                    showToast('Request approved successfully!', 'success');
                    loadApprovals();
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to approve request', 'error');
                }
            } catch (error) {
                console.error('Error approving request:', error);
                showToast('Failed to approve request', 'error');
            }
        }

        async function rejectRequest(requestId, courseId, teacherId, courseTitle) {
            document.getElementById('rejectRequestId').value = requestId;
            document.getElementById('rejectCourseId').value = courseId;
            document.getElementById('rejectTeacherId').value = teacherId;
            document.getElementById('rejectReasonModal').classList.add('active');
        }

        async function confirmRejection() {
            const button = event.target.closest('button');
            showButtonLoading(button, 'Rejecting...');

            const requestId = document.getElementById('rejectRequestId').value;
            const reason = document.getElementById('rejectReason').value;

            try {
                const response = await fetch(`${API_URL}/admin/approvals/${requestId}/reject`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason: reason }),
                    credentials: 'include'
                });

                if (response.ok) {
                    showToast('Request rejected successfully!', 'success');
                    closeModal('rejectReasonModal');
                    loadApprovals();
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to reject request', 'error');
                }
            } catch (error) {
                console.error('Error rejecting request:', error);
                showToast('Failed to reject request', 'error');
            } finally {
                hideButtonLoading(button);
            }
        }

        // ==============================================
        // UPDATE LOAD ADMIN DATA FUNCTION
        // ==============================================

        // Update the loadAdminData function to include approvals
        async function loadAdminData() {
            await loadAllStudents();
            await loadAllTeachers();
            await loadAllCourses();
            await loadAdminNotifications();
            await loadFeeManagementData();
            await loadApprovals(); // Add this line

            // Poll for new notifications every 30 seconds
            setInterval(loadAdminNotifications, 30000);
        }

        // ==============================================
        // INITIALIZE WHEN PAGE LOADS
        // ==============================================

        // Add this to your existing initialization
        document.addEventListener('DOMContentLoaded', function () {
            // Set default fee tab to pending
            const feeTab = document.querySelector('#admin-fee-management .btn-tab');
            if (feeTab) {
                feeTab.classList.add('active');
            }

            // Load approvals if on admin dashboard
            if (document.getElementById('adminDashboard').classList.contains('active')) {
                loadApprovals();
            }
        });

        function filterCourses() {
            const searchTerm = document.getElementById('courseSearch').value.toLowerCase();
            const category = document.getElementById('searchCategory').value;
            const courseItems = document.querySelectorAll('#availableCoursesList .course-item');

            courseItems.forEach(item => {
                let text = '';
                if (category === 'all' || category === 'title') {
                    text += item.querySelector('h3').textContent.toLowerCase() + ' ';
                }
                if (category === 'all' || category === 'code') {
                    const codeElement = item.querySelector('.course-code');
                    if (codeElement) text += codeElement.textContent.toLowerCase() + ' ';
                }
                if (category === 'all' || category === 'teacher') {
                    const teacherElement = item.querySelector('.course-info div');
                    if (teacherElement) text += teacherElement.textContent.toLowerCase() + ' ';
                }

                item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
            });
        }

        async function enrollInCourse(courseId) {
            const button = event.target;
            showButtonLoading(button, 'Enrolling...');

            try {
                const response = await fetch(`${API_URL}/enroll`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ course_id: courseId }),
                    credentials: 'include'
                });

                if (response.ok) {
                    loadEnrolledCourses();
                    loadAvailableCourses();
                    populateCourseSelects();
                    loadSubjectCombination();
                    showToast('Successfully enrolled in course!', 'success');
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Enrollment failed', 'error');
                }
            } catch (error) {
                showToast('Enrollment failed', 'error');
            } finally {
                hideButtonLoading(button);
            }
        }

        async function loadRecentAnnouncements() {
            try {
                const response = await fetch(`${API_URL}/announcements`, {
                    credentials: 'include'
                });
                const announcements = await response.json();

                const html = announcements.slice(0, 5).map(ann => `
            <div class="list-item">
                <h4>${ann.title}</h4>
                <p>${ann.content}</p>
                <div class="card-meta">
                    <span><i class="bi bi-journals"></i> Course: ${ann.course_title}</span>
                    <span><i class="bi bi-person-workspace"></i> By ${ann.teacher_name}</span>
                    <span><i class="bi bi-calendar-event"></i> ${new Date(ann.created_at).toLocaleDateString()}</span>
                </div>
            </div>
        `).join('');

                if (announcements.length > 0) {
                    document.getElementById('recentAnnouncements').innerHTML =
                        `<h3 style="margin-bottom: 20px;"><i class="bi bi-megaphone"></i> Recent Announcements</h3>${html}`;
                } else {
                    document.getElementById('recentAnnouncements').innerHTML = '';
                }
            } catch (error) {
                console.error('Error loading announcements:', error);
            }
        }

        async function loadStudentAssignments() {
            if (!currentUser || !currentUser.id) return;

            try {
                const enrolledResponse = await fetch(`${API_URL}/students/${currentUser.id}/courses`, {
                    credentials: 'include'
                });
                const courses = await enrolledResponse.json();

                let allAssignments = [];
                const now = new Date();

                for (const course of courses) {
                    const response = await fetch(`${API_URL}/assignments?course_id=${course.id}`, {
                        credentials: 'include'
                    });
                    const assignments = await response.json();

                    const assignmentsWithStatus = assignments.map(a => {
                        const dueDate = new Date(a.due_date);
                        const isPastDue = dueDate < now;
                        return {
                            ...a,
                            course_title: course.title,
                            is_past_due: isPastDue
                        };
                    });

                    allAssignments = allAssignments.concat(assignmentsWithStatus);
                }

                const html = allAssignments.map(asgn => {
                    const dueDate = new Date(asgn.due_date);
                    const isPastDue = asgn.is_past_due;

                    return `
                <div class="list-item">
                    <h4>${asgn.title}</h4>
                    <p><strong>Course:</strong> ${asgn.course_title}</p>
                    <p>${asgn.description}</p>
                    <div class="card-meta">
                        <span>Due: ${dueDate.toLocaleString()}</span>
                        <span>Points: ${asgn.max_points}</span>
                        ${isPastDue ? '<span style="color: #dc3545; font-weight: bold;">PAST DUE</span>' : ''}
                    </div>
                    <div class="item-actions">
                        ${!isPastDue ?
                            `<button class="btn btn-small" onclick="showSubmitModal('${asgn.id}')">Submit Assignment</button>` :
                            `<button class="btn btn-small" disabled style="background: #6c757d;">Submission Closed</button>`
                        }
                    </div>
                </div>
            `;
                }).join('');

                document.getElementById('assignmentsList').innerHTML = html || '<p>No assignments yet.</p>';
            } catch (error) {
                console.error('Error loading assignments:', error);
                showToast('Failed to load assignments', 'error');
            }
        }

        async function showSubmitModal(assignmentId) {
            try {
                const response = await fetch(`${API_URL}/assignments/${assignmentId}`, {
                    credentials: 'include'
                });
                const assignment = await response.json();

                const dueDate = new Date(assignment.due_date);
                const now = new Date();

                if (dueDate < now) {
                    showToast('Submission is closed. The due date has passed.', 'error');
                    return;
                }

                document.getElementById('submitAssignmentId').value = assignmentId;
                document.getElementById('submitAssignmentModal').classList.add('active');
            } catch (error) {
                console.error('Error loading assignment:', error);
                showToast('Failed to load assignment', 'error');
            }
        }

        async function submitAssignment(e) {
            e.preventDefault();
            showFormLoading(e, 'Submitting...');

            const data = {
                assignment_id: document.getElementById('submitAssignmentId').value,
                content: document.getElementById('submissionContent').value
            };

            try {
                const response = await fetch(`${API_URL}/submissions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                    credentials: 'include'
                });

                if (response.ok) {
                    closeModal('submitAssignmentModal');
                    showToast('Assignment submitted successfully!', 'success');
                    document.getElementById('submissionContent').value = '';
                    loadStudentAssignments();
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Submission failed', 'error');
                }
            } catch (error) {
                showToast('Submission failed', 'error');
            } finally {
                hideFormLoading(e);
            }
        }

        async function populateCourseSelects() {
            if (!currentUser || !currentUser.id) return;

            try {
                const response = await fetch(`${API_URL}/students/${currentUser.id}/courses`, {
                    credentials: 'include'
                });
                const courses = await response.json();

                const options = courses.map(c => `<option value="${c.id}">${c.title}</option>`).join('');

                ['discussionCourseSelect', 'gradesCourseSelect', 'materialsCourseSelect'].forEach(id => {
                    const select = document.getElementById(id);
                    if (select) {
                        select.innerHTML = '<option value="">Select a course</option>' + options;
                    }
                });
            } catch (error) {
                console.error('Error populating course selects:', error);
            }
        }

        async function loadDiscussions() {
            const courseId = document.getElementById('discussionCourseSelect').value;
            if (!courseId) return;

            const button = event ? event.target : null;
            if (button) showButtonLoading(button, 'Loading...');

            try {
                const response = await fetch(`${API_URL}/discussions?course_id=${courseId}`, {
                    credentials: 'include'
                });
                const posts = await response.json();

                let html = '';
                for (const post of posts) {
                    const repliesResponse = await fetch(`${API_URL}/discussions/${post.id}/replies`, {
                        credentials: 'include'
                    });
                    const replies = await repliesResponse.ok ? await repliesResponse.json() : [];

                    const repliesHtml = replies.map(r => `
                <div class="reply">
                    <div class="post-header">
                        <div>
                            <span class="post-author">${r.author_name}</span>
                            <span class="post-role">${r.role}</span>
                        </div>
                        <span class="post-date">${new Date(r.created_at).toLocaleString()}</span>
                    </div>
                    <p>${r.content}</p>
                </div>
            `).join('');

                    html += `
                <div class="discussion-post">
                    <div class="post-header">
                        <div>
                            <span class="post-author">${post.author_name}</span>
                            <span class="post-role">${post.role}</span>
                        </div>
                        <span class="post-date">${new Date(post.created_at).toLocaleString()}</span>
                    </div>
                    <h4 style="padding:10px;">${post.title}</h4>
                    <p style="padding:10px;">${post.content}</p>
                    <button class="btn btn-small" onclick="showReplyModal('${post.id}')">Reply</button>
                    ${replies.length > 0 ? `<div class="replies">${repliesHtml}</div>` : ''}
                </div>
            `;
                }

                document.getElementById('discussionsList').innerHTML = html || '<p>No discussions yet.</p>';
            } catch (error) {
                console.error('Error loading discussions:', error);
                showToast('Failed to load discussions', 'error');
            } finally {
                if (button) hideButtonLoading(button);
            }
        }

        function showReplyModal(postId) {
            document.getElementById('replyPostId').value = postId;
            document.getElementById('replyModal').classList.add('active');
        }

        async function replyToPost(e) {
            e.preventDefault();
            showFormLoading(e, 'Posting...');

            const data = {
                post_id: document.getElementById('replyPostId').value,
                content: document.getElementById('replyContent').value
            };

            try {
                await fetch(`${API_URL}/discussions/${data.post_id}/replies`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                    credentials: 'include'
                });

                closeModal('replyModal');
                document.getElementById('replyContent').value = '';
                loadDiscussions();
                showToast('Reply posted successfully!', 'success');
            } catch (error) {
                showToast('Reply failed', 'error');
            } finally {
                hideFormLoading(e);
            }
        }

        function showNewPostModal() {
            document.getElementById('newPostModal').classList.add('active');
        }

        async function createDiscussionPost(e) {
            e.preventDefault();

            let courseSelectId, courseId;
            if (currentUser.role === 'student') {
                courseSelectId = 'discussionCourseSelect';
            } else if (currentUser.role === 'teacher') {
                courseSelectId = 'teacherDiscussionCourseSelect';
            } else {
                showToast('Only students and teachers can create discussion posts', 'error');
                return;
            }

            const courseSelect = document.getElementById(courseSelectId);
            if (!courseSelect) {
                showToast('Course selection not found', 'error');
                return;
            }

            courseId = courseSelect.value;

            if (!courseId) {
                showToast('Please select a course first', 'error');
                return;
            }

            const data = {
                course_id: courseId,
                title: document.getElementById('postTitle').value.trim(),
                content: document.getElementById('postContent').value.trim()
            };

            if (!data.title) {
                showToast('Please enter a post title', 'error');
                return;
            }

            if (!data.content) {
                showToast('Please enter post content', 'error');
                return;
            }

            showFormLoading(e, 'Posting...');

            try {
                const response = await fetch(`${API_URL}/discussions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                    credentials: 'include'
                });

                if (response.ok) {
                    closeModal('newPostModal');
                    document.getElementById('postTitle').value = '';
                    document.getElementById('postContent').value = '';
                    showToast('Discussion post created successfully!', 'success');

                    if (currentUser.role === 'student') {
                        await loadDiscussions();
                    } else if (currentUser.role === 'teacher') {
                        await loadTeacherDiscussions();
                    }
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to create discussion post', 'error');
                }
            } catch (error) {
                console.error('Error creating discussion post:', error);
                showToast('Network error. Please check your connection and try again.', 'error');
            } finally {
                hideFormLoading(e);
            }
        }

        async function loadStudentGrades() {
            const courseId = document.getElementById('gradesCourseSelect').value;
            if (!courseId) return;

            const button = event ? event.target : null;
            if (button) showButtonLoading(button, 'Loading...');

            try {
                const response = await fetch(`${API_URL}/students/${currentUser.id}/grades?course_id=${courseId}`, {
                    credentials: 'include'
                });
                const grades = await response.json();

                if (grades.length === 0) {
                    document.getElementById('gradesList').innerHTML = '<p>No grades available yet.</p>';
                    return;
                }

                const html = `
            <table class="grade-table">
                <thead>
                    <tr>
                        <th>Assignment</th>
                        <th>Grade</th>
                        <th>Max Points</th>
                        <th>Percentage</th>
                        <th>Feedback</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    ${grades.map(g => {
                    const percentage = (g.grade / g.max_points * 100).toFixed(1);
                    const badgeClass = percentage >= 70 ? '' : percentage >= 50 ? 'medium' : 'low';
                    return `
                            <tr>
                                <td>${g.assignment_title}</td>
                                <td><span class="grade-badge ${badgeClass}">${g.grade}</span></td>
                                <td>${g.max_points}</td>
                                <td>${percentage}%</td>
                                <td>${g.feedback || '-'}</td>
                                <td>${new Date(g.submitted_at).toLocaleDateString()}</td>
                            </tr>
                        `;
                }).join('')}
                </tbody>
            </table>
        `;

                document.getElementById('gradesList').innerHTML = html;
            } catch (error) {
                console.error('Error loading grades:', error);
                showToast('Failed to load grades', 'error');
            } finally {
                if (button) hideButtonLoading(button);
            }
        }

        async function loadMaterials() {
            const courseId = document.getElementById('materialsCourseSelect').value;
            if (!courseId) return;

            const button = event ? event.target : null;
            if (button) showButtonLoading(button, 'Loading...');

            try {
                const response = await fetch(`${API_URL}/materials?course_id=${courseId}`, {
                    credentials: 'include'
                });
                const materials = await response.json();

                const html = materials.map(mat => `
            <div class="list-item">
                <h4>${mat.title}</h4>
                <p>${mat.description || ''}</p>
                <div class="card-meta">
                    <span>Type: ${mat.material_type}</span>
                    <span>Added: ${new Date(mat.created_at).toLocaleDateString()}</span>
                    <span>By: ${mat.teacher_name}</span>
                </div>
                ${mat.file_url ? `<a href="${mat.file_url}" target="_blank" class="btn btn-small" style="margin-top: 10px; display: inline-block;">View Material</a>` : ''}
            </div>
        `).join('');

                document.getElementById('materialsList').innerHTML = html || '<p>No materials available yet.</p>';
            } catch (error) {
                console.error('Error loading materials:', error);
                showToast('Failed to load materials', 'error');
            } finally {
                if (button) hideButtonLoading(button);
            }
        }

        async function loadStudentProfile() {
            if (!currentUser || !currentUser.id) return;

            try {
                const response = await fetch(`${API_URL}/users/${currentUser.id}`, {
                    credentials: 'include'
                });
                const profile = await response.json();

                document.getElementById('profileEmail').value = profile.email;
                document.getElementById('profileFirstName').value = profile.first_name;
                document.getElementById('profileLastName').value = profile.last_name;
                document.getElementById('profilePhone').value = profile.phone || '';
                document.getElementById('profileAddress').value = profile.address || '';
                document.getElementById('profileDOB').value = profile.date_of_birth || '';

                const profileSection = document.getElementById('profile');
                if (!document.getElementById('studentIdDisplay')) {
                    const studentIdHtml = `
                <div class="form-group">
                    <label>Student ID</label>
                    <input type="text" id="profileStudentId" value="${profile.student_id || ''}" 
                           readonly style="background: #f5f5f5; font-weight: bold; color: #667eea;">
                </div>
            `;
                    const emailField = document.getElementById('profileEmail').parentElement;
                    emailField.insertAdjacentHTML('afterend', studentIdHtml);
                } else {
                    document.getElementById('profileStudentId').value = profile.student_id || '';
                }
            } catch (error) {
                console.error('Error loading student profile:', error);
                showToast('Failed to load profile', 'error');
            }
        }

        async function updateStudentProfile(e) {
            e.preventDefault();
            showFormLoading(e, 'Updating...');

            const data = {
                first_name: document.getElementById('profileFirstName').value,
                last_name: document.getElementById('profileLastName').value,
                phone: document.getElementById('profilePhone').value,
                address: document.getElementById('profileAddress').value,
                date_of_birth: document.getElementById('profileDOB').value
            };

            try {
                const response = await fetch(`${API_URL}/users/${currentUser.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                    credentials: 'include'
                });

                if (response.ok) {
                    showToast('Profile updated successfully!', 'success');
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Profile update failed', 'error');
                }
            } catch (error) {
                showToast('Profile update failed', 'error');
            } finally {
                hideFormLoading(e);
            }
        }

        // ==============================================
        // STUDENT FEE PAYMENT FUNCTIONS WITH LOADING
        // ==============================================

        async function loadStudentFeeStatus() {
            if (!currentUser || !currentUser.id) return;

            try {
                const banner = document.getElementById('feeStatusBanner');
                banner.innerHTML = `
            <div style="text-align: center; padding: 20px;">
                <div class="spinner"></div>
                <p>Loading fee status...</p>
            </div>
        `;

                const response = await fetch(`${API_URL}/students/${currentUser.id}/fee-status`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to load fee status');
                }

                const data = await response.json();

                // Update currentStudentId
                if (data.student_info && data.student_info.student_id) {
                    currentUser.student_id = data.student_info.student_id;
                    document.getElementById('currentStudentId').textContent = data.student_info.student_id;
                }

                let statusHtml = '';
                if (data.summary.has_approved_payment) {
                    statusHtml = `
                <div class="fee-status approved">
                    <h4><i class="bi bi-check-circle-fill"></i> Fee Payment Approved</h4>
                    <p>Your fee payment has been approved. You have full access to all courses.</p>
                    <p><strong>Total Paid:</strong> $${data.summary.total_paid.toFixed(2)}</p>
                    <p><strong>Approved Payments:</strong> ${data.summary.approved_count}</p>
                </div>
            `;
                } else if (data.summary.pending_count > 0) {
                    statusHtml = `
                <div class="fee-status pending">
                    <h4><i class="bi bi-clock"></i> Fee Payment Pending Approval</h4>
                    <p>Your fee payment is pending admin approval. You cannot access courses until approved.</p>
                    <p><strong>Pending Payments:</strong> ${data.summary.pending_count}</p>
                </div>
            `;
                } else if (data.summary.requires_fee_payment) {
                    statusHtml = `
                <div class="fee-status rejected">
                    <h4><i class="bi bi-exclamation-triangle"></i> No Fee Payment Recorded</h4>
                    <p>You need to make a fee payment to access courses. Please follow the payment instructions below.</p>
                </div>
            `;
                } else {
                    statusHtml = `
                <div class="fee-status approved">
                    <h4><i class="bi bi-check-circle"></i> Fee Payment Not Required</h4>
                    <p>You have full access to all courses. Fee payment is not required for your account.</p>
                </div>
            `;
                }

                document.getElementById('feeStatusBanner').innerHTML = statusHtml;

                let paymentsHtml = '';
                if (data.payments && data.payments.length > 0) {
                    paymentsHtml = data.payments.map(payment => `
                <div class="payment-card">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div>
                            <h5 style="margin: 0;">Receipt: ${payment.receipt_number || 'N/A'}</h5>
                            <p style="margin: 5px 0; color: #666;">
                                ${new Date(payment.payment_date).toLocaleDateString()} | 
                                Amount: $${payment.amount.toFixed(2)}
                            </p>
                        </div>
                        <span class="payment-status-badge payment-status-${payment.status.toLowerCase()}">
                            ${payment.status}
                        </span>
                    </div>
                    ${payment.description ? `<p style="margin: 10px 0; color: #666;">${payment.description}</p>` : ''}
                    ${payment.notes ? `<p style="margin: 10px 0; color: #999; font-size: 14px;"><em>${payment.notes}</em></p>` : ''}
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <span style="background: #f8f9fa; padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                            ${payment.payment_method || 'N/A'}
                        </span>
                        <span style="background: #f8f9fa; padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                            ${payment.academic_year || new Date().getFullYear()} - Semester ${payment.semester || 1}
                        </span>
                        ${payment.approved_at ?
                            `<span style="background: #e8f5e9; padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                                Approved: ${new Date(payment.approved_at).toLocaleDateString()}
                            </span>` : ''}
                    </div>
                </div>
            `).join('');
                } else {
                    paymentsHtml = `
                <div style="text-align: center; padding: 40px; color: #666;">
                    <i class="bi bi-receipt" style="font-size: 48px; margin-bottom: 15px;"></i>
                    <p>No fee payments recorded yet.</p>
                </div>
            `;
                }

                document.getElementById('studentFeePaymentsList').innerHTML = paymentsHtml;

                if (data.fee_structure) {
                    document.getElementById('feeStructureSection').style.display = 'block';
                    const feeStructureHtml = `
                <div class="payment-card">
                    <h4 style="margin-bottom: 15px;">${data.fee_structure.level} - ${data.fee_structure.department}</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <p style="margin: 5px 0;"><strong>Tuition Fee:</strong> $${data.fee_structure.tuition_fee.toFixed(2)}</p>
                            <p style="margin: 5px 0;"><strong>Registration Fee:</strong> $${data.fee_structure.registration_fee.toFixed(2)}</p>
                            <p style="margin: 5px 0;"><strong>Library Fee:</strong> $${data.fee_structure.library_fee.toFixed(2)}</p>
                        </div>
                        <div>
                            <p style="margin: 5px 0;"><strong>Sports Fee:</strong> $${data.fee_structure.sports_fee.toFixed(2)}</p>
                            <p style="margin: 5px 0;"><strong>Lab Fee:</strong> $${data.fee_structure.lab_fee.toFixed(2)}</p>
                            <p style="margin: 5px 0;"><strong>Other Fees:</strong> $${data.fee_structure.other_fees.toFixed(2)}</p>
                        </div>
                    </div>
                    <p style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                        <strong>Total:</strong> $${(
                            data.fee_structure.tuition_fee +
                            data.fee_structure.registration_fee +
                            data.fee_structure.library_fee +
                            data.fee_structure.sports_fee +
                            data.fee_structure.lab_fee +
                            data.fee_structure.other_fees
                        ).toFixed(2)}
                    </p>
                    ${data.fee_structure.description ?
                            `<p style="margin-top: 10px; color: #666;">${data.fee_structure.description}</p>` : ''}
                </div>
            `;
                    document.getElementById('feeStructureInfo').innerHTML = feeStructureHtml;
                } else {
                    document.getElementById('feeStructureSection').style.display = 'none';
                }

            } catch (error) {
                console.error('Error loading fee status:', error);
                document.getElementById('feeStatusBanner').innerHTML = `
            <div class="fee-status rejected">
                <h4><i class="bi bi-exclamation-triangle"></i> Error Loading Fee Status</h4>
                <p>Unable to load fee payment information. Please try again later.</p>
            </div>
        `;
            }
        }
        // ==============================================
        // TEACHER DASHBOARD FUNCTIONS WITH LOADING
        // ==============================================

        async function loadTeacherData() {
            await loadTeacherCourses();
            await loadTeacherNotifications();
            // Poll for new notifications every 30 seconds
            setInterval(loadTeacherNotifications, 30000);
        }

        async function loadTeacherCourses() {
            if (!currentUser || !currentUser.id) return;

            try {
                const response = await fetch(`${API_URL}/teachers/${currentUser.id}/courses`, {
                    credentials: 'include'
                });
                const courses = await response.json();

                const html = courses.length > 0 ? courses.map(course => `
            <div class="card">
                <h3>${course.title}</h3>
                <p>${course.description}</p>
                <div class="card-meta">
                    <span class="course-code">${course.course_code}</span>
                    <span>Credits: ${course.credits}</span>
                    <span>Students: ${course.student_count || 0}</span>
                </div>
            </div>
        `).join('') : '<p>You are not assigned to any courses yet.</p>';

                document.getElementById('teacherCoursesList').innerHTML = html;
            } catch (error) {
                console.error('Error loading teacher courses:', error);
                showToast('Failed to load courses', 'error');
            }
        }

        async function showManageCoursesModal() {
            try {
                const response = await fetch(`${API_URL}/courses`, {
                    credentials: 'include'
                });
                const allCourses = await response.json();

                const teacherResponse = await fetch(`${API_URL}/teachers/${currentUser.id}/courses`, {
                    credentials: 'include'
                });
                const teacherCourses = await teacherResponse.json();
                const teacherCourseIds = teacherCourses.map(c => c.id);

                let html = '';
                for (const course of allCourses) {
                    const isAssigned = teacherCourseIds.includes(course.id);
                    const hasTeacher = course.teacher_id && course.teacher_id !== currentUser.id;

                    html += `
                <div class="course-item">
                    <div class="course-info">
                        <h3>${course.title}</h3>
                        <p>${course.description}</p>
                        <span class="course-code">${course.course_code}</span>
                        <span style="margin-left: 10px;">Credits: ${course.credits}</span>
                        <div style="margin-top: 5px; color: #666; font-size: 13px;">
                            ${hasTeacher ? `Currently assigned to: ${course.teacher_name}` : 'Available'}
                        </div>
                    </div>
                    ${isAssigned ?
                            `<button class="btn btn-small btn-secondary" onclick="removeTeacherFromCourse('${course.id}', this)" style="background: #dc3545;">
                            <i class="bi bi-dash-circle"></i> Remove
                        </button>` :
                            `<button class="btn btn-small" onclick="assignTeacherToCourse('${course.id}', this)" ${hasTeacher ? 'disabled style="background: #6c757d;"' : ''}>
                            <i class="bi bi-plus-circle"></i> ${hasTeacher ? 'Request Access' : 'Assign to Me'}
                        </button>`
                        }
                </div>
            `;
                }

                document.getElementById('allCoursesList').innerHTML = html;
                document.getElementById('manageCoursesModal').classList.add('active');
            } catch (error) {
                console.error('Error loading courses for management:', error);
                showToast('Failed to load courses', 'error');
            }
        }

        async function assignTeacherToCourse(courseId, button) {
            showButtonLoading(button);

            try {
                const response = await fetch(`${API_URL}/teachers/${currentUser.id}/assign-course`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ course_id: courseId }),
                    credentials: 'include'
                });

                if (response.ok) {
                    const result = await response.json();

                    if (result.requires_approval) {
                        showToast('Course assignment request sent for admin approval', 'info');
                        showManageCoursesModal(); // Refresh the list
                    } else {
                        showToast('Successfully assigned to course!', 'success');
                        loadTeacherCourses();
                        showManageCoursesModal(); // Refresh the list
                    }
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to assign course', 'error');
                }
            } catch (error) {
                showToast('Failed to assign course', 'error');
            } finally {
                hideButtonLoading(button);
            }
        }

        async function removeTeacherFromCourse(courseId, button) {
            showButtonLoading(button);

            try {
                const response = await fetch(`${API_URL}/teachers/${currentUser.id}/remove-course/${courseId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    showToast('Removed from course', 'success');
                    loadTeacherCourses();
                    showManageCoursesModal(); // Refresh the list
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to remove from course', 'error');
                }
            } catch (error) {
                showToast('Failed to remove from course', 'error');
            } finally {
                hideButtonLoading(button);
            }
        }

        async function loadEnrolledStudents() {
            const courseId = document.getElementById('studentsCourseSelect').value;
            if (!courseId) return;

            const button = document.getElementById('studentsCourseSelect');
            showButtonLoading(button, 'Loading...');

            try {
                const response = await fetch(`${API_URL}/courses/${courseId}/students`, {
                    credentials: 'include'
                });
                const students = await response.json();

                const html = students.length > 0 ? students.map(student => `
            <div class="list-item">
                <h4>${student.first_name} ${student.last_name}</h4>
                <p>Email: ${student.email}</p>
                <div class="card-meta">
                    <span>Student ID: ${student.student_id}</span>
                    <span>Level: ${student.level}</span>
                    <span>Department: ${student.department}</span>
                </div>
            </div>
        `).join('') : '<p>No students enrolled in this course yet.</p>';

                document.getElementById('enrolledStudentsList').innerHTML = html;
            } catch (error) {
                console.error('Error loading enrolled students:', error);
                showToast('Failed to load students', 'error');
            } finally {
                hideButtonLoading(button);
            }
        }

        async function createAnnouncement(e) {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            showButtonLoading(submitBtn, 'Posting...');

            const data = {
                course_id: document.getElementById('announcementCourse').value,
                title: document.getElementById('announcementTitle').value,
                content: document.getElementById('announcementContent').value
            };

            try {
                const response = await fetch(`${API_URL}/announcements`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                    credentials: 'include'
                });

                if (response.ok) {
                    showToast('Announcement posted successfully!', 'success');
                    e.target.reset();
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to post announcement', 'error');
                }
            } catch (error) {
                showToast('Failed to post announcement', 'error');
            } finally {
                hideButtonLoading(submitBtn);
            }
        }

        async function createAssignment(e) {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            showButtonLoading(submitBtn, 'Creating...');

            const data = {
                course_id: document.getElementById('assignmentCourse').value,
                title: document.getElementById('assignmentTitle').value,
                description: document.getElementById('assignmentDescription').value,
                due_date: document.getElementById('assignmentDueDate').value,
                max_points: document.getElementById('assignmentPoints').value
            };

            try {
                const response = await fetch(`${API_URL}/assignments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                    credentials: 'include'
                });

                if (response.ok) {
                    showToast('Assignment created successfully!', 'success');
                    e.target.reset();
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to create assignment', 'error');
                }
            } catch (error) {
                showToast('Failed to create assignment', 'error');
            } finally {
                hideButtonLoading(submitBtn);
            }
        }

        async function addMaterial(e) {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            showButtonLoading(submitBtn, 'Adding...');

            const data = {
                course_id: document.getElementById('materialCourse').value,
                title: document.getElementById('materialTitle').value,
                description: document.getElementById('materialDescription').value,
                material_type: document.getElementById('materialType').value,
                file_url: document.getElementById('materialUrl').value
            };

            try {
                const response = await fetch(`${API_URL}/materials`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                    credentials: 'include'
                });

                if (response.ok) {
                    showToast('Material added successfully!', 'success');
                    e.target.reset();
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to add material', 'error');
                }
            } catch (error) {
                showToast('Failed to add material', 'error');
            } finally {
                hideButtonLoading(submitBtn);
            }
        }

        async function loadCourseAssignments() {
            const courseId = document.getElementById('gradingCourseSelect').value;
            if (!courseId) return;

            const button = document.getElementById('gradingCourseSelect');
            showButtonLoading(button, 'Loading...');

            try {
                const response = await fetch(`${API_URL}/assignments?course_id=${courseId}`, {
                    credentials: 'include'
                });
                const assignments = await response.json();

                const options = assignments.map(a =>
                    `<option value="${a.id}">${a.title} (Due: ${new Date(a.due_date).toLocaleDateString()})</option>`
                ).join('');

                document.getElementById('gradingAssignmentSelect').innerHTML =
                    '<option value="">Select an assignment</option>' + options;
            } catch (error) {
                console.error('Error loading assignments:', error);
                showToast('Failed to load assignments', 'error');
            } finally {
                hideButtonLoading(button);
            }
        }

        async function loadSubmissions() {
            const assignmentId = document.getElementById('gradingAssignmentSelect').value;
            if (!assignmentId) return;

            const button = document.getElementById('gradingAssignmentSelect');
            showButtonLoading(button, 'Loading...');

            try {
                const response = await fetch(`${API_URL}/assignments/${assignmentId}/submissions`, {
                    credentials: 'include'
                });
                const submissions = await response.json();

                let html = '';
                for (const submission of submissions) {
                    const gradeResponse = await fetch(`${API_URL}/submissions/${submission.id}/grade`, {
                        credentials: 'include'
                    });
                    const grade = gradeResponse.ok ? await gradeResponse.json() : null;

                    html += `
                <div class="list-item">
                    <h4>${submission.student_name}</h4>
                    <p><strong>Submitted:</strong> ${new Date(submission.submitted_at).toLocaleString()}</p>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        ${submission.content}
                    </div>
                    ${grade ?
                            `<p><strong>Grade:</strong> ${grade.grade}/${grade.max_points}</p>
                         ${grade.feedback ? `<p><strong>Feedback:</strong> ${grade.feedback}</p>` : ''}` :
                            `<button class="btn btn-small" onclick="showGradeModal('${submission.id}', '${submission.student_id}')">
                            Grade Submission
                        </button>`
                        }
                </div>
            `;
                }

                document.getElementById('submissionsList').innerHTML = html || '<p>No submissions yet.</p>';
            } catch (error) {
                console.error('Error loading submissions:', error);
                showToast('Failed to load submissions', 'error');
            } finally {
                hideButtonLoading(button);
            }
        }

        function showGradeModal(submissionId, studentId) {
            document.getElementById('gradeAssignmentId').value = submissionId;
            document.getElementById('gradeStudentId').value = studentId;

            // Load submission content
            fetch(`${API_URL}/submissions/${submissionId}`, {
                credentials: 'include'
            })
                .then(response => response.json())
                .then(submission => {
                    document.getElementById('submissionContentDisplay').innerHTML = `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                        <h4>Submission Content</h4>
                        <p>${submission.content}</p>
                    </div>
                `;
                    document.getElementById('gradeModal').classList.add('active');
                })
                .catch(error => {
                    console.error('Error loading submission:', error);
                    showToast('Failed to load submission', 'error');
                });
        }

        async function gradeSubmission(e) {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            showButtonLoading(submitBtn, 'Grading...');

            const data = {
                submission_id: document.getElementById('gradeAssignmentId').value,
                grade: document.getElementById('gradePoints').value,
                feedback: document.getElementById('gradeFeedback').value
            };

            try {
                const response = await fetch(`${API_URL}/grades`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                    credentials: 'include'
                });

                if (response.ok) {
                    closeModal('gradeModal');
                    showToast('Grade submitted successfully!', 'success');
                    loadSubmissions();
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to submit grade', 'error');
                }
            } catch (error) {
                showToast('Failed to submit grade', 'error');
            } finally {
                hideButtonLoading(submitBtn);
            }
        }

        async function loadTeacherDiscussions() {
            const courseId = document.getElementById('teacherDiscussionCourseSelect').value;
            if (!courseId) return;

            const button = document.getElementById('teacherDiscussionCourseSelect');
            showButtonLoading(button, 'Loading...');

            try {
                const response = await fetch(`${API_URL}/discussions?course_id=${courseId}`, {
                    credentials: 'include'
                });
                const posts = await response.json();

                let html = '';
                for (const post of posts) {
                    const repliesResponse = await fetch(`${API_URL}/discussions/${post.id}/replies`, {
                        credentials: 'include'
                    });
                    const replies = await repliesResponse.json();

                    const repliesHtml = replies.map(r => `
                <div class="reply">
                    <div class="post-header">
                        <div>
                            <span class="post-author">${r.author_name}</span>
                            <span class="post-role">${r.role}</span>
                        </div>
                        <span class="post-date">${new Date(r.created_at).toLocaleString()}</span>
                    </div>
                    <p>${r.content}</p>
                </div>
            `).join('');

                    html += `
                <div class="discussion-post">
                    <div class="post-header">
                        <div>
                            <span class="post-author">${post.author_name}</span>
                            <span class="post-role">${post.role}</span>
                        </div>
                        <span class="post-date">${new Date(post.created_at).toLocaleString()}</span>
                    </div>
                    <h4 style="padding:10px;">${post.title}</h4>
                    <p style="padding:10px;">${post.content}</p>
                    <button class="btn btn-small" onclick="showReplyModal('${post.id}')">Reply</button>
                    ${replies.length > 0 ? `<div class="replies">${repliesHtml}</div>` : ''}
                </div>
            `;
                }

                document.getElementById('teacherDiscussionsList').innerHTML = html || '<p>No discussions yet.</p>';
            } catch (error) {
                console.error('Error loading discussions:', error);
                showToast('Failed to load discussions', 'error');
            } finally {
                hideButtonLoading(button);
            }
        }

        async function updateTeacherProfile() {
            const button = event.target;
            showButtonLoading(button, 'Updating...');

            const data = {
                specialization: document.getElementById('teacherProfileSpecialization').value
            };

            try {
                const response = await fetch(`${API_URL}/teachers/${currentUser.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                    credentials: 'include'
                });

                if (response.ok) {
                    showToast('Profile updated successfully!', 'success');
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Profile update failed', 'error');
                }
            } catch (error) {
                showToast('Profile update failed', 'error');
            } finally {
                hideButtonLoading(button);
            }
        }

        // ==============================================
        // ADMIN DASHBOARD FUNCTIONS WITH LOADING
        // ==============================================

        async function loadAdminData() {
            await loadAllStudents();
            await loadAllTeachers();
            await loadAllCourses();
            await loadAdminNotifications();
            await loadFeeManagementData();

            // Poll for new notifications every 30 seconds
            setInterval(loadAdminNotifications, 30000);
        }

        async function loadAllStudents() {
            const button = document.querySelector('[onclick*="searchStudents"]') ||
                document.getElementById('searchStudents')?.parentElement;
            if (button) showButtonLoading(button, 'Loading...');

            try {
                const response = await fetch(`${API_URL}/admin/students`, {
                    credentials: 'include'
                });
                const students = await response.json();

                const html = students.map(student => `
            <div class="list-item">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <h4>${student.first_name} ${student.last_name}</h4>
                        <p><strong>Email:</strong> ${student.email}</p>
                        <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                            <span class="badge" style="background: #667eea;">${student.student_id || 'No ID'}</span>
                            <span class="badge" style="background: #6c757d;">${student.level || 'No Level'}</span>
                            <span class="badge" style="background: #17a2b8;">${student.department || 'No Department'}</span>
                            <span class="badge" style="background: ${student.status === 'active' ? '#28a745' :
                        student.status === 'suspended' ? '#dc3545' : '#6c757d'}">
                                ${student.status || 'unknown'}
                            </span>
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <button class="btn btn-small" onclick="showStudentDetails('${student.id}')">
                            <i class="bi bi-eye"></i> View
                        </button>
                        <button class="btn btn-small btn-secondary" onclick="showEditStudentModal('${student.id}')">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        ${student.status === 'active' ?
                        `<button class="btn btn-small" style="background: #dc3545;" onclick="suspendStudent('${student.id}')">
                                <i class="bi bi-person-slash"></i> Suspend
                            </button>` :
                        `<button class="btn btn-small" style="background: #28a745;" onclick="activateStudent('${student.id}')">
                                <i class="bi bi-person-check"></i> Activate
                            </button>`
                    }
                    </div>
                </div>
            </div>
        `).join('');

                document.getElementById('studentsList').innerHTML = html;
            } catch (error) {
                console.error('Error loading students:', error);
                document.getElementById('studentsList').innerHTML =
                    '<p style="color: #dc3545;">Failed to load students. Please try again.</p>';
            } finally {
                if (button) hideButtonLoading(button);
            }
        }

        function searchStudents() {
            const searchTerm = document.getElementById('searchStudents').value.toLowerCase();
            const studentItems = document.querySelectorAll('#studentsList .list-item');

            studentItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        }

        async function showStudentDetails(studentId) {
            const button = event.target.closest('button');
            showButtonLoading(button, 'Loading...');

            try {
                const response = await fetch(`${API_URL}/users/${studentId}`, {
                    credentials: 'include'
                });
                const student = await response.json();

                const html = `
            <div style="padding: 20px;">
                <h3>Student Details</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                    <div>
                        <h4>Personal Information</h4>
                        <p><strong>Name:</strong> ${student.first_name} ${student.last_name}</p>
                        <p><strong>Email:</strong> ${student.email}</p>
                        <p><strong>Phone:</strong> ${student.phone || 'Not provided'}</p>
                        <p><strong>Address:</strong> ${student.address || 'Not provided'}</p>
                        <p><strong>Date of Birth:</strong> ${student.date_of_birth || 'Not provided'}</p>
                        <p><strong>Gender:</strong> ${student.gender || 'Not provided'}</p>
                    </div>
                    <div>
                        <h4>Academic Information</h4>
                        <p><strong>Student ID:</strong> ${student.student_id || 'Not assigned'}</p>
                        <p><strong>Level:</strong> ${student.level || 'Not assigned'}</p>
                        <p><strong>Department:</strong> ${student.department || 'Not assigned'}</p>
                        <p><strong>Status:</strong> <span class="badge" style="background: ${student.status === 'active' ? '#28a745' :
                        student.status === 'suspended' ? '#dc3545' : '#6c757d'}">${student.status}</span></p>
                        <p><strong>Registered:</strong> ${new Date(student.created_at).toLocaleDateString()}</p>
                    </div>
                </div>
                <div style="margin-top: 30px;">
                    <button class="btn" onclick="showEditStudentModal('${student.id}')" style="margin-right: 10px;">
                        <i class="bi bi-pencil"></i> Edit Student
                    </button>
                    <button class="btn btn-secondary" onclick="closeModal('studentDetailsModal')">
                        Close
                    </button>
                </div>
            </div>
        `;

                document.getElementById('studentDetailsContent').innerHTML = html;
                document.getElementById('studentDetailsModal').classList.add('active');
            } catch (error) {
                console.error('Error loading student details:', error);
                showToast('Failed to load student details', 'error');
            } finally {
                hideButtonLoading(button);
            }
        }

        async function showEditStudentModal(studentId) {
            const button = event.target.closest('button');
            showButtonLoading(button, 'Loading...');

            try {
                const response = await fetch(`${API_URL}/users/${studentId}`, {
                    credentials: 'include'
                });
                const student = await response.json();

                // Populate form fields
                document.getElementById('editStudentId').value = student.id;
                document.getElementById('editFirstName').value = student.first_name;
                document.getElementById('editLastName').value = student.last_name;
                document.getElementById('editEmail').value = student.email;
                document.getElementById('editStudentIdField').value = student.student_id || '';
                document.getElementById('editPhone').value = student.phone || '';
                document.getElementById('editAddress').value = student.address || '';
                document.getElementById('editDOB').value = student.date_of_birth || '';
                document.getElementById('editGender').value = student.gender || '';
                document.getElementById('editDepartment').value = student.department || '';
                document.getElementById('editLevel').value = student.level || '';
                document.getElementById('editStatus').value = student.status || 'active';

                document.getElementById('editStudentModal').classList.add('active');
            } catch (error) {
                console.error('Error loading student for edit:', error);
                showToast('Failed to load student information', 'error');
            } finally {
                hideButtonLoading(button);
            }
        }

        async function updateStudentInfo(e) {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            showButtonLoading(submitBtn, 'Updating...');

            const studentId = document.getElementById('editStudentId').value;
            const data = {
                first_name: document.getElementById('editFirstName').value,
                last_name: document.getElementById('editLastName').value,
                email: document.getElementById('editEmail').value,
                student_id: document.getElementById('editStudentIdField').value,
                phone: document.getElementById('editPhone').value,
                address: document.getElementById('editAddress').value,
                date_of_birth: document.getElementById('editDOB').value,
                gender: document.getElementById('editGender').value,
                department: document.getElementById('editDepartment').value,
                level: document.getElementById('editLevel').value,
                status: document.getElementById('editStatus').value
            };

            const password = document.getElementById('editPassword').value;
            if (password) {
                data.password = password;
            }

            try {
                const response = await fetch(`${API_URL}/admin/students/${studentId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                    credentials: 'include'
                });

                if (response.ok) {
                    closeModal('editStudentModal');
                    showToast('Student information updated successfully!', 'success');
                    loadAllStudents();
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to update student', 'error');
                }
            } catch (error) {
                showToast('Failed to update student', 'error');
            } finally {
                hideButtonLoading(submitBtn);
            }
        }

        async function suspendStudent(studentId) {
            const button = event.target.closest('button');
            showButtonLoading(button, 'Suspending...');

            try {
                const response = await fetch(`${API_URL}/admin/students/${studentId}/suspend`, {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    showToast('Student suspended successfully', 'success');
                    loadAllStudents();
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to suspend student', 'error');
                }
            } catch (error) {
                showToast('Failed to suspend student', 'error');
            } finally {
                hideButtonLoading(button);
            }
        }

        async function activateStudent(studentId) {
            const button = event.target.closest('button');
            showButtonLoading(button, 'Activating...');

            try {
                const response = await fetch(`${API_URL}/admin/students/${studentId}/activate`, {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    showToast('Student activated successfully', 'success');
                    loadAllStudents();
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to activate student', 'error');
                }
            } catch (error) {
                showToast('Failed to activate student', 'error');
            } finally {
                hideButtonLoading(button);
            }
        }

        async function loadAllTeachers() {
            try {
                const response = await fetch(`${API_URL}/admin/teachers`, {
                    credentials: 'include'
                });
                const teachers = await response.json();

                const html = teachers.map(teacher => `
            <div class="list-item">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <h4>${teacher.first_name} ${teacher.last_name}</h4>
                        <p><strong>Email:</strong> ${teacher.email}</p>
                        <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                            <span class="badge" style="background: #667eea;">${teacher.teacher_code}</span>
                            <span class="badge" style="background: #6c757d;">${teacher.department || 'No Department'}</span>
                            <span class="badge" style="background: ${teacher.status === 'active' ? '#28a745' :
                        teacher.status === 'suspended' ? '#dc3545' : '#6c757d'}">
                                ${teacher.status || 'unknown'}
                            </span>
                            <span class="badge" style="background: #17a2b8;">
                                ${teacher.course_count || 0} courses
                            </span>
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <button class="btn btn-small" onclick="showTeacherDetails('${teacher.id}')">
                            <i class="bi bi-eye"></i> View
                        </button>
                        <button class="btn btn-small btn-secondary" onclick="showEditTeacherModal('${teacher.id}')">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        ${teacher.status === 'active' ?
                        `<button class="btn btn-small" style="background: #dc3545;" onclick="suspendTeacher('${teacher.id}')">
                                <i class="bi bi-person-slash"></i> Suspend
                            </button>` :
                        `<button class="btn btn-small" style="background: #28a745;" onclick="activateTeacher('${teacher.id}')">
                                <i class="bi bi-person-check"></i> Activate
                            </button>`
                    }
                        <button class="btn btn-small" style="background: #dc3545;" onclick="terminateTeacher('${teacher.id}')">
                            <i class="bi bi-person-x"></i> Terminate
                        </button>
                    </div>
                </div>
            </div>
        `).join('');

                document.getElementById('teachersList').innerHTML = html;
            } catch (error) {
                console.error('Error loading teachers:', error);
                document.getElementById('teachersList').innerHTML =
                    '<p style="color: #dc3545;">Failed to load teachers. Please try again.</p>';
            }
        }

        function showCreateTeacherModal() {
            document.getElementById('createTeacherModal').classList.add('active');
        }

        async function createTeacherAccount(e) {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            showButtonLoading(submitBtn, 'Creating...');

            const data = {
                first_name: document.getElementById('newTeacherFirstName').value,
                last_name: document.getElementById('newTeacherLastName').value,
                email: document.getElementById('newTeacherEmail').value,
                password: document.getElementById('newTeacherPassword').value,
                teacher_code: document.getElementById('newTeacherCode').value,
                department: document.getElementById('newTeacherDepartment').value
            };

            try {
                const response = await fetch(`${API_URL}/admin/teachers`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                    credentials: 'include'
                });

                if (response.ok) {
                    closeModal('createTeacherModal');
                    showToast('Teacher account created successfully!', 'success');
                    loadAllTeachers();
                    e.target.reset();
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to create teacher account', 'error');
                }
            } catch (error) {
                showToast('Failed to create teacher account', 'error');
            } finally {
                hideButtonLoading(submitBtn);
            }
        }

        async function showTeacherDetails(teacherId) {
            const button = event.target.closest('button');
            showButtonLoading(button, 'Loading...');

            try {
                const response = await fetch(`${API_URL}/teachers/${teacherId}`, {
                    credentials: 'include'
                });
                const teacher = await response.json();

                const coursesResponse = await fetch(`${API_URL}/teachers/${teacherId}/courses`, {
                    credentials: 'include'
                });
                const courses = coursesResponse.ok ? await coursesResponse.json() : [];

                const html = `
            <div style="padding: 20px;">
                <h3>Teacher Details</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                    <div>
                        <h4>Personal Information</h4>
                        <p><strong>Name:</strong> ${teacher.first_name} ${teacher.last_name}</p>
                        <p><strong>Email:</strong> ${teacher.email}</p>
                        <p><strong>Teacher Code:</strong> ${teacher.teacher_code}</p>
                        <p><strong>Department:</strong> ${teacher.department || 'Not assigned'}</p>
                        <p><strong>Specialization:</strong> ${teacher.specialization || 'Not specified'}</p>
                    </div>
                    <div>
                        <h4>Account Information</h4>
                        <p><strong>Status:</strong> <span class="badge" style="background: ${teacher.status === 'active' ? '#28a745' :
                        teacher.status === 'suspended' ? '#dc3545' : '#6c757d'}">${teacher.status}</span></p>
                        <p><strong>Registered:</strong> ${new Date(teacher.created_at).toLocaleDateString()}</p>
                        <p><strong>Last Login:</strong> ${teacher.last_login ? new Date(teacher.last_login).toLocaleString() : 'Never'}</p>
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <h4>Assigned Courses (${courses.length})</h4>
                    ${courses.length > 0 ? courses.map(course => `
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 5px 0;">
                            <strong>${course.title}</strong> (${course.course_code})
                            <div style="font-size: 12px; color: #666;">
                                Credits: ${course.credits} • Students: ${course.student_count || 0}
                            </div>
                        </div>
                    `).join('') : '<p>No courses assigned yet.</p>'}
                </div>
                
                <div style="margin-top: 30px;">
                    <button class="btn" onclick="showEditTeacherModal('${teacher.id}')" style="margin-right: 10px;">
                        <i class="bi bi-pencil"></i> Edit Teacher
                    </button>
                    <button class="btn btn-secondary" onclick="closeModal('teacherDetailsModal')">
                        Close
                    </button>
                </div>
            </div>
        `;

                document.getElementById('teacherDetailsContent').innerHTML = html;
                document.getElementById('teacherDetailsModal').classList.add('active');
            } catch (error) {
                console.error('Error loading teacher details:', error);
                showToast('Failed to load teacher details', 'error');
            } finally {
                hideButtonLoading(button);
            }
        }

        async function suspendTeacher(teacherId) {
            const button = event.target.closest('button');
            showButtonLoading(button, 'Suspending...');

            try {
                const response = await fetch(`${API_URL}/admin/teachers/${teacherId}/suspend`, {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    showToast('Teacher suspended successfully', 'success');
                    loadAllTeachers();
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to suspend teacher', 'error');
                }
            } catch (error) {
                showToast('Failed to suspend teacher', 'error');
            } finally {
                hideButtonLoading(button);
            }
        }

        async function activateTeacher(teacherId) {
            const button = event.target.closest('button');
            showButtonLoading(button, 'Activating...');

            try {
                const response = await fetch(`${API_URL}/admin/teachers/${teacherId}/activate`, {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    showToast('Teacher activated successfully', 'success');
                    loadAllTeachers();
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to activate teacher', 'error');
                }
            } catch (error) {
                showToast('Failed to activate teacher', 'error');
            } finally {
                hideButtonLoading(button);
            }
        }

        async function terminateTeacher(teacherId) {
            const button = event.target.closest('button');
            showButtonLoading(button, 'Processing...');

            showConfirmation(
                'Are you sure you want to terminate this teacher?',
                async () => {
                    try {
                        const response = await fetch(`${API_URL}/admin/teachers/${teacherId}`, {
                            method: 'DELETE',
                            credentials: 'include'
                        });

                        if (response.ok) {
                            showToast('Teacher terminated successfully', 'success');
                            loadAllTeachers();
                        } else {
                            const error = await response.json();
                            showToast(error.error || 'Failed to terminate teacher', 'error');
                        }
                    } catch (error) {
                        showToast('Failed to terminate teacher', 'error');
                    }
                },
                {
                    title: 'Terminate Teacher',
                    details: 'This action cannot be undone. The teacher will lose access to the system.',
                    icon: 'danger',
                    confirmText: 'Terminate',
                    confirmColor: '#dc3545'
                }
            );

            hideButtonLoading(button);
        }

        async function showEditTeacherModal(teacherId) {
            const button = event.target.closest('button');
            showButtonLoading(button, 'Loading...');

            try {
                const response = await fetch(`${API_URL}/teachers/${teacherId}`, {
                    credentials: 'include'
                });
                const teacher = await response.json();

                const html = `
            <div style="padding: 20px;">
                <h3>Edit Teacher Information</h3>
                <form id="editTeacherForm" onsubmit="updateTeacherInfo(event, '${teacherId}')">
                    <div class="form-group">
                        <label>First Name *</label>
                        <input type="text" id="editTeacherFirstName" value="${teacher.first_name}" required>
                    </div>
                    <div class="form-group">
                        <label>Last Name *</label>
                        <input type="text" id="editTeacherLastName" value="${teacher.last_name}" required>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="editTeacherEmail" value="${teacher.email}" required>
                    </div>
                    <div class="form-group">
                        <label>Teacher Code *</label>
                        <input type="text" id="editTeacherCode" value="${teacher.teacher_code}" required>
                    </div>
                    <div class="form-group">
                        <label>Department</label>
                        <select id="editTeacherDepartment">
                            <option value="">Select Department</option>
                            <option value="Science" ${teacher.department === 'Science' ? 'selected' : ''}>Science</option>
                            <option value="Arts" ${teacher.department === 'Arts' ? 'selected' : ''}>Arts</option>
                            <option value="Commercial" ${teacher.department === 'Commercial' ? 'selected' : ''}>Commercial</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Specialization</label>
                        <input type="text" id="editTeacherSpecialization" value="${teacher.specialization || ''}">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="editTeacherStatus">
                            <option value="active" ${teacher.status === 'active' ? 'selected' : ''}>Active</option>
                            <option value="suspended" ${teacher.status === 'suspended' ? 'selected' : ''}>Suspended</option>
                            <option value="inactive" ${teacher.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Change Password (leave blank to keep current)</label>
                        <input type="password" id="editTeacherPassword" placeholder="New password">
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="submit" class="btn" style="flex: 1;">
                            <i class="bi bi-person-check"></i> Update Teacher
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('editTeacherModal')" style="flex: 1;">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        `;

                document.getElementById('editTeacherContent').innerHTML = html;
                document.getElementById('editTeacherModal').classList.add('active');
            } catch (error) {
                console.error('Error loading teacher for edit:', error);
                showToast('Failed to load teacher information', 'error');
            } finally {
                hideButtonLoading(button);
            }
        }

        async function updateTeacherInfo(e, teacherId) {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            showButtonLoading(submitBtn, 'Updating...');

            const data = {
                first_name: document.getElementById('editTeacherFirstName').value,
                last_name: document.getElementById('editTeacherLastName').value,
                email: document.getElementById('editTeacherEmail').value,
                teacher_code: document.getElementById('editTeacherCode').value,
                department: document.getElementById('editTeacherDepartment').value,
                specialization: document.getElementById('editTeacherSpecialization').value,
                status: document.getElementById('editTeacherStatus').value
            };

            const password = document.getElementById('editTeacherPassword').value;
            if (password) {
                data.password = password;
            }

            try {
                const response = await fetch(`${API_URL}/admin/teachers/${teacherId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                    credentials: 'include'
                });

                if (response.ok) {
                    closeModal('editTeacherModal');
                    showToast('Teacher information updated successfully!', 'success');
                    loadAllTeachers();
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to update teacher', 'error');
                }
            } catch (error) {
                showToast('Failed to update teacher', 'error');
            } finally {
                hideButtonLoading(submitBtn);
            }
        }

        // ==============================================
        // COURSE MANAGEMENT FUNCTIONS WITH LOADING
        // ==============================================

        async function loadAllCourses() {
            try {
                const response = await fetch(`${API_URL}/courses`, {
                    credentials: 'include'
                });
                const courses = await response.json();

                const html = courses.map(course => `
            <div class="list-item">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <h4>${course.title}</h4>
                        <p>${course.description}</p>
                        <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                            <span class="badge" style="background: #667eea;">${course.course_code}</span>
                            <span class="badge" style="background: #6c757d;">Credits: ${course.credits}</span>
                            <span class="badge" style="background: #17a2b8;">Level: ${course.level}</span>
                            <span class="badge" style="background: #28a745;">${course.department}</span>
                            <span class="badge" style="background: ${course.teacher_lock ? '#dc3545' : '#ffc107'}">
                                ${course.teacher_lock ? 'Teacher Locked' : 'Multiple Teachers'}
                            </span>
                        </div>
                        <div style="margin-top: 10px; font-size: 13px; color: #666;">
                            ${course.teacher_names ? `<strong>Teacher(s):</strong> ${course.teacher_names}` : 'No teacher assigned'}
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <button class="btn btn-small" onclick="showCourseDetails('${course.id}')">
                            <i class="bi bi-eye"></i> View
                        </button>
                        <button class="btn btn-small btn-secondary" onclick="showEditCourseModal('${course.id}')">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        <button class="btn btn-small" style="background: #dc3545;" onclick="deleteCourse('${course.id}')">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </div>
                </div>
            </div>
        `).join('');

                document.getElementById('adminCoursesList').innerHTML = html;
            } catch (error) {
                console.error('Error loading courses:', error);
                document.getElementById('adminCoursesList').innerHTML =
                    '<p style="color: #dc3545;">Failed to load courses. Please try again.</p>';
            }
        }

        function showCreateCourseModal() {
            document.getElementById('adminCourseId').value = '';
            document.getElementById('adminCourseTitle').value = '';
            document.getElementById('adminCourseCode').value = '';
            document.getElementById('adminCourseCredits').value = '';
            document.getElementById('adminCourseDescription').value = '';
            document.getElementById('adminCourseTeacherLock').value = '1';
            document.getElementById('adminCourseLevel').value = 'all';
            document.getElementById('adminCourseDepartment').value = 'all';
            document.getElementById('createCourseModal').classList.add('active');
        }

        async function adminCreateCourse(e) {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            showButtonLoading(submitBtn, 'Creating...');

            const data = {
                title: document.getElementById('adminCourseTitle').value,
                course_code: document.getElementById('adminCourseCode').value,
                credits: document.getElementById('adminCourseCredits').value,
                description: document.getElementById('adminCourseDescription').value,
                teacher_lock: document.getElementById('adminCourseTeacherLock').value,
                level: document.getElementById('adminCourseLevel').value,
                department: document.getElementById('adminCourseDepartment').value
            };

            const courseId = document.getElementById('adminCourseId').value;
            const method = courseId ? 'PUT' : 'POST';
            const url = courseId ? `${API_URL}/courses/${courseId}` : `${API_URL}/courses`;

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                    credentials: 'include'
                });

                if (response.ok) {
                    closeModal('createCourseModal');
                    showToast(courseId ? 'Course updated successfully!' : 'Course created successfully!', 'success');
                    loadAllCourses();
                    e.target.reset();
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to save course', 'error');
                }
            } catch (error) {
                showToast('Failed to save course', 'error');
            } finally {
                hideButtonLoading(submitBtn);
            }
        }

        async function showCourseDetails(courseId) {
            const button = event.target.closest('button');
            showButtonLoading(button, 'Loading...');

            try {
                const response = await fetch(`${API_URL}/courses/${courseId}`, {
                    credentials: 'include'
                });
                const course = await response.json();

                const studentsResponse = await fetch(`${API_URL}/courses/${courseId}/students`, {
                    credentials: 'include'
                });
                const students = studentsResponse.ok ? await studentsResponse.json() : [];

                const html = `
            <div style="padding: 20px;">
                <h3>Course Details</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                    <div>
                        <h4>Course Information</h4>
                        <p><strong>Title:</strong> ${course.title}</p>
                        <p><strong>Code:</strong> ${course.course_code}</p>
                        <p><strong>Credits:</strong> ${course.credits}</p>
                        <p><strong>Description:</strong> ${course.description}</p>
                        <p><strong>Level:</strong> ${course.level}</p>
                        <p><strong>Department:</strong> ${course.department}</p>
                        <p><strong>Teacher Lock:</strong> ${course.teacher_lock ? 'Enabled' : 'Disabled'}</p>
                    </div>
                    <div>
                        <h4>Statistics</h4>
                        <p><strong>Enrolled Students:</strong> ${students.length}</p>
                        <p><strong>Assigned Teacher(s):</strong> ${course.teacher_names || 'None'}</p>
                        <p><strong>Created:</strong> ${new Date(course.created_at).toLocaleDateString()}</p>
                    </div>
                </div>
                
                ${students.length > 0 ? `
                    <div style="margin-top: 30px;">
                        <h4>Enrolled Students (${students.length})</h4>
                        <div style="max-height: 200px; overflow-y: auto; margin-top: 10px;">
                            ${students.map(student => `
                                <div style="background: #f8f9fa; padding: 8px; border-radius: 5px; margin: 5px 0;">
                                    <strong>${student.first_name} ${student.last_name}</strong>
                                    <div style="font-size: 12px; color: #666;">
                                        ${student.email} • ${student.student_id}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <div style="margin-top: 30px;">
                    <button class="btn" onclick="showEditCourseModal('${course.id}')" style="margin-right: 10px;">
                        <i class="bi bi-pencil"></i> Edit Course
                    </button>
                    <button class="btn btn-secondary" onclick="closeModal('studentDetailsModal')">
                        Close
                    </button>
                </div>
            </div>
        `;

                document.getElementById('studentDetailsContent').innerHTML = html;
                document.getElementById('studentDetailsModal').classList.add('active');
            } catch (error) {
                console.error('Error loading course details:', error);
                showToast('Failed to load course details', 'error');
            } finally {
                hideButtonLoading(button);
            }
        }

        async function showEditCourseModal(courseId) {
            const button = event.target.closest('button');
            showButtonLoading(button, 'Loading...');

            try {
                const response = await fetch(`${API_URL}/courses/${courseId}`, {
                    credentials: 'include'
                });
                const course = await response.json();

                document.getElementById('adminCourseId').value = course.id;
                document.getElementById('adminCourseTitle').value = course.title;
                document.getElementById('adminCourseCode').value = course.course_code;
                document.getElementById('adminCourseCredits').value = course.credits;
                document.getElementById('adminCourseDescription').value = course.description;
                document.getElementById('adminCourseTeacherLock').value = course.teacher_lock ? '1' : '0';
                document.getElementById('adminCourseLevel').value = course.level;
                document.getElementById('adminCourseDepartment').value = course.department;

                document.getElementById('createCourseModal').classList.add('active');
            } catch (error) {
                console.error('Error loading course for edit:', error);
                showToast('Failed to load course information', 'error');
            } finally {
                hideButtonLoading(button);
            }
        }

        async function deleteCourse(courseId) {
            const button = event.target.closest('button');
            showButtonLoading(button, 'Processing...');

            showConfirmation(
                'Are you sure you want to delete this course?',
                async () => {
                    try {
                        const response = await fetch(`${API_URL}/courses/${courseId}`, {
                            method: 'DELETE',
                            credentials: 'include'
                        });

                        if (response.ok) {
                            showToast('Course deleted successfully', 'success');
                            loadAllCourses();
                        } else {
                            const error = await response.json();
                            showToast(error.error || 'Failed to delete course', 'error');
                        }
                    } catch (error) {
                        showToast('Failed to delete course', 'error');
                    }
                },
                {
                    title: 'Delete Course',
                    details: 'This action cannot be undone. All course data will be permanently removed.',
                    icon: 'danger',
                    confirmText: 'Delete',
                    confirmColor: '#dc3545'
                }
            );

            hideButtonLoading(button);
        }

        function showAddCompulsoryCourseModal() {
            document.getElementById('compulsoryCourseId').value = '';
            document.getElementById('compulsoryCourseTitle').value = '';
            document.getElementById('compulsoryCourseCode').value = '';
            document.getElementById('compulsoryCourseDescription').value = '';
            document.getElementById('compulsoryCourseCredits').value = '';
            document.getElementById('compulsoryCourseLevel').value = '';
            document.getElementById('addCompulsoryCourseModal').classList.add('active');
        }

        async function saveCompulsoryCourse(e) {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            showButtonLoading(submitBtn, 'Saving...');

            const data = {
                title: document.getElementById('compulsoryCourseTitle').value,
                course_code: document.getElementById('compulsoryCourseCode').value,
                description: document.getElementById('compulsoryCourseDescription').value,
                credits: document.getElementById('compulsoryCourseCredits').value,
                level: document.getElementById('compulsoryCourseLevel').value,
                is_compulsory: true
            };

            const courseId = document.getElementById('compulsoryCourseId').value;
            const method = courseId ? 'PUT' : 'POST';
            const url = courseId ? `${API_URL}/courses/${courseId}` : `${API_URL}/courses`;

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                    credentials: 'include'
                });

                if (response.ok) {
                    closeModal('addCompulsoryCourseModal');
                    showToast(courseId ? 'Compulsory course updated!' : 'Compulsory course added!', 'success');
                    loadAllCourses();
                    e.target.reset();
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to save compulsory course', 'error');
                }
            } catch (error) {
                showToast('Failed to save compulsory course', 'error');
            } finally {
                hideButtonLoading(submitBtn);
            }
        }

        function clearAllCourses() {
            const button = document.querySelector('#clearAllCoursesModal .btn[onclick="clearAllCourses()"]');
            showButtonLoading(button, 'Clearing...');

            setTimeout(() => {
                // Simulate API call
                showToast('All courses cleared successfully', 'success');
                closeModal('clearAllCoursesModal');
                hideButtonLoading(button);
                // In real implementation, you would call the API here
                // await fetch(`${API_URL}/courses/clear-all`, { method: 'DELETE' });
            }, 2000);
        }

        // ==============================================
        // FEE MANAGEMENT FUNCTIONS WITH LOADING
        // ==============================================

        async function loadFeeManagementData() {
            const button = document.querySelector('[onclick="loadFeeManagementData()"]');
            if (button) showButtonLoading(button, 'Loading...');

            try {
                // Simulate API call
                setTimeout(() => {
                    // Mock data for demonstration
                    const mockData = {
                        statistics: {
                            total_amount: 12500.00,
                            approved_payments: 45,
                            pending_payments: 12
                        },
                        students_with_fees: 150,
                        payments: [
                            {
                                id: '1',
                                student_name: 'John Doe',
                                student_id_display: 'STU2024001',
                                receipt_number: 'REC001',
                                amount: 500.00,
                                payment_date: '2024-01-15',
                                status: 'approved',
                                payment_method: 'bank_transfer',
                                academic_year: 2024,
                                semester: 1,
                                student_level: 'HS1',
                                student_department: 'Science',
                                description: 'Tuition fee payment'
                            },
                            {
                                id: '2',
                                student_name: 'Jane Smith',
                                student_id_display: 'STU2024002',
                                receipt_number: 'REC002',
                                amount: 500.00,
                                payment_date: '2024-01-16',
                                status: 'pending',
                                payment_method: 'cash',
                                academic_year: 2024,
                                semester: 1,
                                student_level: 'HS2',
                                student_department: 'Arts',
                                description: 'Registration fee'
                            }
                        ]
                    };

                    // Update statistics
                    const statsHtml = `
                <div class="card">
                    <h3><i class="bi bi-currency-dollar"></i> Total Approved</h3>
                    <p style="font-size: 24px; font-weight: bold; color: #28a745;">$${mockData.statistics.total_amount.toFixed(2)}</p>
                    <p>from ${mockData.statistics.approved_payments} payments</p>
                </div>
                <div class="card">
                    <h3><i class="bi bi-clock"></i> Pending</h3>
                    <p style="font-size: 24px; font-weight: bold; color: #ffc107;">${mockData.statistics.pending_payments}</p>
                    <p>awaiting approval</p>
                </div>
                <div class="card">
                    <h3><i class="bi bi-check-circle"></i> Approved</h3>
                    <p style="font-size: 24px; font-weight: bold; color: #28a745;">${mockData.statistics.approved_payments}</p>
                    <p>payments approved</p>
                </div>
                <div class="card">
                    <h3><i class="bi bi-people"></i> Students</h3>
                    <p style="font-size: 24px; font-weight: bold; color: #667eea;">${mockData.students_with_fees}</p>
                    <p>with fee requirements</p>
                </div>
            `;

                    document.getElementById('feeStatistics').innerHTML = statsHtml;

                    // Update fee payments list
                    displayFeePayments(mockData.payments);

                    if (button) hideButtonLoading(button);
                }, 1000);

            } catch (error) {
                console.error('Error loading fee management data:', error);
                document.getElementById('feePaymentsList').innerHTML = `
            <div style="color: #dc3545; text-align: center; padding: 40px;">
                <i class="bi bi-exclamation-triangle" style="font-size: 48px;"></i>
                <p>Failed to load fee management data</p>
            </div>
        `;
                if (button) hideButtonLoading(button);
            }
        }

        function displayFeePayments(payments) {
            if (!payments || payments.length === 0) {
                document.getElementById('feePaymentsList').innerHTML = `
            <div style="text-align: center; padding: 40px; color: #666;">
                <i class="bi bi-receipt" style="font-size: 48px;"></i>
                <p>No fee payments found</p>
            </div>
        `;
                return;
            }

            const html = payments.map(payment => `
        <div class="list-item" style="border-left-color: ${payment.status === 'approved' ? '#28a745' : payment.status === 'pending' ? '#ffc107' : '#dc3545'};">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;">
                    <h4>${payment.student_name} (${payment.student_id_display})</h4>
                    <p><strong>Receipt:</strong> ${payment.receipt_number} | 
                       <strong>Amount:</strong> $${payment.amount.toFixed(2)} | 
                       <strong>Date:</strong> ${new Date(payment.payment_date).toLocaleDateString()}</p>
                    <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                        <span class="badge" style="background: ${payment.status === 'approved' ? '#28a745' : payment.status === 'pending' ? '#ffc107' : '#dc3545'}">
                            ${payment.status}
                        </span>
                        <span class="badge" style="background: #6c757d;">
                            ${payment.payment_method}
                        </span>
                        <span class="badge" style="background: #17a2b8;">
                            ${payment.academic_year} - Semester ${payment.semester}
                        </span>
                        <span class="badge" style="background: #6c757d;">
                            ${payment.student_level} - ${payment.student_department}
                        </span>
                    </div>
                    ${payment.description ? `<p style="margin-top: 10px; color: #666;">${payment.description}</p>` : ''}
                </div>
                <div style="display: flex; flex-direction: column; gap: 5px;">
                    <button class="btn btn-small" onclick="viewFeePayment('${payment.id}')">
                        <i class="bi bi-eye"></i> View
                    </button>
                    ${payment.status === 'pending' ? `
                        <button class="btn btn-small" style="background: #28a745;" onclick="approveFeePayment('${payment.id}')">
                            <i class="bi bi-check"></i> Approve
                        </button>
                        <button class="btn btn-small btn-secondary" style="background: #dc3545;" onclick="rejectFeePayment('${payment.id}')">
                            <i class="bi bi-x"></i> Reject
                        </button>
                    ` : ''}
                    <button class="btn btn-small btn-secondary" onclick="editFeePayment('${payment.id}')" style="margin-top: 5px;">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                </div>
            </div>
        </div>
    `).join('');

            document.getElementById('feePaymentsList').innerHTML = html;
        }

        function viewFeePayment(paymentId) {
            const button = event.target.closest('button');
            showButtonLoading(button, 'Loading...');

            setTimeout(() => {
                // Mock data for demonstration
                const mockPayment = {
                    receipt_number: 'REC001',
                    student_name: 'John Doe',
                    student_id_display: 'STU2024001',
                    student_email: 'john@example.com',
                    level: 'HS1',
                    department: 'Science',
                    amount: 500.00,
                    payment_date: '2024-01-15',
                    payment_method: 'bank_transfer',
                    status: 'approved',
                    academic_year: 2024,
                    semester: 1,
                    description: 'Tuition fee payment for semester 1',
                    notes: 'Paid via online banking',
                    created_by_name: 'Admin User',
                    approved_by_name: 'Admin User',
                    approved_at: '2024-01-16'
                };

                const html = `
            <div style="padding: 20px;">
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 10px 0;">Fee Payment Details</h3>
                    <p style="margin: 0; opacity: 0.9;">Receipt: ${mockPayment.receipt_number}</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <strong style="color: #667eea;">Student Information</strong>
                        <p style="margin: 5px 0 0 0;">${mockPayment.student_name}</p>
                        <p style="margin: 5px 0 0 0; font-size: 14px;">ID: ${mockPayment.student_id_display}</p>
                        <p style="margin: 5px 0 0 0; font-size: 14px;">${mockPayment.student_email}</p>
                        <p style="margin: 5px 0 0 0; font-size: 14px;">Level: ${mockPayment.level} - ${mockPayment.department}</p>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <strong style="color: #667eea;">Payment Details</strong>
                        <p style="margin: 5px 0 0 0; font-size: 18px; font-weight: bold; color: #28a745;">
                            $${mockPayment.amount.toFixed(2)}
                        </p>
                        <p style="margin: 5px 0 0 0;">Date: ${new Date(mockPayment.payment_date).toLocaleDateString()}</p>
                        <p style="margin: 5px 0 0 0;">Method: ${mockPayment.payment_method}</p>
                        <span class="badge" style="background: ${mockPayment.status === 'approved' ? '#28a745' : mockPayment.status === 'pending' ? '#ffc107' : '#dc3545'}; margin-top: 5px; display: inline-block;">
                            ${mockPayment.status.toUpperCase()}
                        </span>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <strong style="color: #667eea;">Academic Information</strong>
                        <p style="margin: 5px 0 0 0;">Year: ${mockPayment.academic_year}</p>
                        <p style="margin: 5px 0 0 0;">Semester: ${mockPayment.semester}</p>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <strong style="color: #667eea;">Processed By</strong>
                        <p style="margin: 5px 0 0 0;">Recorded: ${mockPayment.created_by_name || 'System'}</p>
                        ${mockPayment.approved_by_name ?
                        `<p style="margin: 5px 0 0 0;">Approved: ${mockPayment.approved_by_name} on ${new Date(mockPayment.approved_at).toLocaleDateString()}</p>` :
                        ''}
                    </div>
                </div>
                
                ${mockPayment.description ? `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <strong style="color: #667eea;">Description</strong>
                        <p style="margin: 5px 0 0 0;">${mockPayment.description}</p>
                    </div>
                ` : ''}
                
                ${mockPayment.notes ? `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <strong style="color: #667eea;">Notes</strong>
                        <p style="margin: 5px 0 0 0;">${mockPayment.notes}</p>
                    </div>
                ` : ''}
                
                ${mockPayment.status === 'pending' ? `
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                        <div style="display: flex; gap: 15px;">
                            <button class="btn" style="flex: 1; background: #28a745;" onclick="approveFeePayment('${paymentId}')">
                                <i class="bi bi-check"></i> Approve Payment
                            </button>
                            <button class="btn btn-secondary" style="flex: 1; background: #dc3545;" onclick="rejectFeePayment('${paymentId}')">
                                <i class="bi bi-x"></i> Reject Payment
                            </button>
                        </div>
                    </div>
                ` : ''}
            </div>
        `;

                document.getElementById('feePaymentDetails').innerHTML = html;
                document.getElementById('viewFeePaymentModal').classList.add('active');
                hideButtonLoading(button);
            }, 1000);
        }

        function approveFeePayment(paymentId) {
            const button = event.target.closest('button');
            showButtonLoading(button, 'Approving...');

            showConfirmation(
                'Are you sure you want to approve this fee payment?',
                () => {
                    setTimeout(() => {
                        showToast('Fee payment approved successfully!', 'success');
                        closeModal('viewFeePaymentModal');
                        loadFeeManagementData();
                        hideButtonLoading(button);
                    }, 1000);
                },
                {
                    title: 'Approve Fee Payment',
                    details: 'This will grant the student access to all courses.',
                    icon: 'success',
                    confirmText: 'Approve',
                    confirmColor: '#28a745'
                }
            );
        }

        function rejectFeePayment(paymentId) {
            const button = event.target.closest('button');
            showButtonLoading(button, 'Processing...');

            const html = `
        <div style="padding: 20px;">
            <p style="margin-bottom: 15px;">Please provide a reason for rejecting this payment:</p>
            <div class="form-group">
                <textarea id="rejectionReason" rows="4" placeholder="Enter rejection reason..." style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 5px;"></textarea>
            </div>
            <div style="display: flex; gap: 15px; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeModal('feeActionModal')" style="flex: 1;">
                    Cancel
                </button>
                <button class="btn" onclick="confirmRejection('${paymentId}')" style="flex: 1; background: #dc3545;">
                    <i class="bi bi-x"></i> Reject Payment
                </button>
            </div>
        </div>
    `;

            document.getElementById('feeActionTitle').innerHTML = '<i class="bi bi-x-circle"></i> Reject Payment';
            document.getElementById('feeActionContent').innerHTML = html;
            document.getElementById('actionPaymentId').value = paymentId;
            document.getElementById('feeActionModal').classList.add('active');
            hideButtonLoading(button);
        }

        function confirmRejection(paymentId) {
            const button = event.target.closest('button');
            showButtonLoading(button, 'Rejecting...');

            const reason = document.getElementById('rejectionReason').value.trim();

            if (!reason) {
                showToast('Please provide a rejection reason', 'warning');
                hideButtonLoading(button);
                return;
            }

            setTimeout(() => {
                showToast('Fee payment rejected successfully!', 'success');
                closeModal('feeActionModal');
                closeModal('viewFeePaymentModal');
                loadFeeManagementData();
                hideButtonLoading(button);
            }, 1000);
        }

        function editFeePayment(paymentId) {
            const button = event.target.closest('button');
            showButtonLoading(button, 'Loading...');

            setTimeout(() => {
                showToast('Edit functionality to be implemented', 'info');
                hideButtonLoading(button);
            }, 1000);
        }

        function searchFeePayments() {
            const searchTerm = document.getElementById('searchFeePayments').value.toLowerCase();
            const paymentItems = document.querySelectorAll('#feePaymentsList .list-item');

            paymentItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        }

        function toggleStudentFeeRequirement(studentId, studentName) {
            const button = event.target.closest('button');
            showButtonLoading(button, 'Updating...');

            setTimeout(() => {
                showToast(`Fee requirement toggled for ${studentName}`, 'success');
                loadFeeManagementData();
                hideButtonLoading(button);
            }, 1000);
        }

        function recordFeePaymentForStudent(studentId, studentName) {
            showToast(`Recording payment for ${studentName}`, 'info');
            document.getElementById('recordFeePaymentModal').classList.add('active');
        }

        function showRecordFeePaymentModal() {
            document.getElementById('recordFeePaymentModal').classList.add('active');
        }

        async function recordFeePayment(e) {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            showButtonLoading(submitBtn, 'Recording...');

            setTimeout(() => {
                showToast('Fee payment recorded successfully!', 'success');
                closeModal('recordFeePaymentModal');
                loadFeeManagementData();
                hideButtonLoading(submitBtn);
                e.target.reset();
            }, 1500);
        }

        // ==============================================
        // APPROVAL FUNCTIONS WITH LOADING
        // ==============================================

        async function refreshApprovals() {
            const button = event.target.closest('button');
            showButtonLoading(button, 'Refreshing...');

            setTimeout(() => {
                showToast('Approvals refreshed', 'success');
                hideButtonLoading(button);
            }, 1000);
        }

        async function showApprovalHistory() {
            const button = event.target.closest('button');
            showButtonLoading(button, 'Loading...');

            setTimeout(() => {
                const mockHistory = [
                    {
                        id: '1',
                        teacher_name: 'John Smith',
                        course_title: 'Mathematics 101',
                        status: 'approved',
                        created_at: '2024-01-15T10:30:00',
                        processed_at: '2024-01-15T14:45:00',
                        processed_by: 'Admin User',
                        notes: 'Course assigned successfully'
                    },
                    {
                        id: '2',
                        teacher_name: 'Jane Doe',
                        course_title: 'Physics 201',
                        status: 'rejected',
                        created_at: '2024-01-14T09:15:00',
                        processed_at: '2024-01-14T11:30:00',
                        processed_by: 'Admin User',
                        notes: 'Course already assigned to another teacher'
                    }
                ];

                const html = mockHistory.map(item => `
            <div class="list-item" style="border-left-color: ${item.status === 'approved' ? '#28a745' : '#dc3545'};">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <h4>${item.course_title}</h4>
                        <p><strong>Teacher:</strong> ${item.teacher_name}</p>
                        <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                            <span class="badge" style="background: ${item.status === 'approved' ? '#28a745' : '#dc3545'}">
                                ${item.status.toUpperCase()}
                            </span>
                            <span class="badge" style="background: #6c757d;">
                                Requested: ${new Date(item.created_at).toLocaleString()}
                            </span>
                            <span class="badge" style="background: #17a2b8;">
                                Processed: ${new Date(item.processed_at).toLocaleString()}
                            </span>
                            <span class="badge" style="background: #6c757d;">
                                By: ${item.processed_by}
                            </span>
                        </div>
                        ${item.notes ? `<p style="margin-top: 10px; color: #666;">${item.notes}</p>` : ''}
                    </div>
                </div>
            </div>
        `).join('');

                document.getElementById('approvalHistoryContent').innerHTML = html;
                document.getElementById('approvalHistoryModal').classList.add('active');
                hideButtonLoading(button);
            }, 1000);
        }

        // ==============================================
        // SYSTEM SETTINGS FUNCTIONS WITH LOADING
        // ==============================================

        function backupDatabase() {
            const button = event.target.closest('button');
            showButtonLoading(button, 'Backing up...');

            setTimeout(() => {
                showToast('Database backup completed successfully', 'success');
                hideButtonLoading(button);
            }, 2000);
        }

        function resetSystem() {
            const button = document.querySelector('#resetModal .btn[onclick="resetSystem()"]');
            showButtonLoading(button, 'Resetting...');

            showConfirmation(
                '⚠️ FINAL WARNING: Are you absolutely sure you want to reset the entire system?',
                () => {
                    setTimeout(() => {
                        showToast('System reset completed. All data has been cleared.', 'success');
                        closeModal('resetModal');
                        hideButtonLoading(button);
                        // In real implementation, you would redirect to login or reload the page
                    }, 3000);
                },
                {
                    title: '⚠️ FINAL CONFIRMATION',
                    details: 'This will delete ALL data except the admin account. This action cannot be undone!',
                    icon: 'danger',
                    confirmText: 'RESET SYSTEM',
                    confirmColor: '#dc3545'
                }
            );
        }

        // ==============================================
        // MISCELLANEOUS FUNCTIONS WITH LOADING
        // ==============================================

        function clearAllNotifications() {
            const button = event.target;
            showButtonLoading(button, 'Clearing...');

            setTimeout(() => {
                showToast('All notifications cleared', 'success');
                hideButtonLoading(button);
            }, 1500);
        }

        function markAllNotificationsAsRead() {
            const button = event.target.closest('button');
            showButtonLoading(button, 'Marking...');

            setTimeout(() => {
                showToast('All notifications marked as read', 'success');
                hideButtonLoading(button);
            }, 1000);
        }

        // ==============================================
        // VIEW ALL NOTIFICATIONS FUNCTIONS
        // ==============================================

        function showAllNotifications() {
            const button = event.target.closest('button');
            showButtonLoading(button, 'Loading...');

            setTimeout(() => {
                // Mock notifications data
                const mockNotifications = [
                    {
                        id: '1',
                        title: 'New Assignment Posted',
                        message: 'Mathematics 101 assignment is now available',
                        created_at: '2024-01-15T10:30:00',
                        is_read: false,
                        type: 'assignment'
                    },
                    {
                        id: '2',
                        title: 'Fee Payment Approved',
                        message: 'Your fee payment has been approved',
                        created_at: '2024-01-14T14:45:00',
                        is_read: true,
                        type: 'fee'
                    },
                    {
                        id: '3',
                        title: 'Course Enrollment',
                        message: 'You have been enrolled in Physics 201',
                        created_at: '2024-01-13T09:15:00',
                        is_read: true,
                        type: 'enrollment'
                    }
                ];

                const html = mockNotifications.map(notif => `
            <div class="notification-item ${notif.is_read ? 'read' : 'unread'}" 
                 style="padding: 12px; margin-bottom: 8px; border-radius: 8px; 
                        background: ${notif.is_read ? '#f8f9fa' : '#e3f2fd'}; 
                        border-left: 3px solid ${notif.is_read ? '#ddd' : '#667eea'};">
              <div style="display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;">
                  <strong style="color: #333; display: block; margin-bottom: 4px;">${notif.title}</strong>
                  <p style="color: #666; font-size: 13px; margin: 0;">${notif.message}</p>
                  <span style="color: #999; font-size: 11px;">${new Date(notif.created_at).toLocaleString()}</span>
                </div>
                ${!notif.is_read ? '<div style="width: 8px; height: 8px; background: #667eea; border-radius: 50%; margin-left: 10px;"></div>' : ''}
              </div>
            </div>
        `).join('');

                document.getElementById('allNotificationsList').innerHTML = html;
                document.getElementById('notificationsCount').innerHTML =
                    `<span class="badge" style="background: #667eea;">${mockNotifications.length} notifications</span>`;
                document.getElementById('notificationsPageModal').classList.add('active');
                hideButtonLoading(button);
            }, 1000);
        }

        function showAllTeacherNotifications() {
            showAllNotifications(); // Reuse the same function
        }

        function showAllAdminNotifications() {
            showAllNotifications(); // Reuse the same function
        }

        // ==============================================
        // INITIALIZATION
        // ==============================================

        // Initialize the app when the page loads
        window.addEventListener('DOMContentLoaded', function () {
            setupButtonLoadingAnimations();
            initApp();
        });

        // ==============================================
        // HELPER FUNCTIONS
        // ==============================================

        function getDepartmentColor(department) {
            const colors = {
                'Science': '#2196F3',
                'Arts': '#9C27B0',
                'Commercial': '#4CAF50',
                'all': '#6c757d'
            };
            return colors[department] || '#667eea';
        }

        function initApp() {
            console.log('School LMS initialized with complete button loading animations');
        }

        // Note: This is a comprehensive implementation with loading animations
        // for all major functions. Some functions use setTimeout to simulate
        // API calls for demonstration purposes. In a real application, you would
        // replace these with actual API calls.
    </script>

</body>

</html>